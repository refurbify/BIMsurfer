define("bimsurfer/src/Notifier",[],function(){return function(){this.setSelector=function(e){console.log("setSelector",arguments)},this.clear=function(){console.log("clear",arguments)},this.resetStatus=function(){console.log("status",arguments)},this.resetStatusQuick=function(){console.log("status",arguments)},this.setSuccess=function(e,t){console.log("success",arguments)},this.setInfo=function(e,t){console.log("info",arguments)},this.setError=function(e){console.log("error",arguments)}}}),define("bimsurfer/lib/text",["module"],function(e){"use strict";var t,i,r,s,n,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],o=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,h=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,l="undefined"!=typeof location&&location.href,c=l&&location.protocol&&location.protocol.replace(/\:/,""),u=l&&location.hostname,d=l&&(location.port||void 0),f={},_=e.config&&e.config()||{};return t={version:"2.0.14",strip:function(e){if(e){var t=(e=e.replace(o,"")).match(h);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:_.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;t<3;t+=1){i=a[t];try{e=new ActiveXObject(i)}catch(e){}if(e){a=[i];break}}return e},parseName:function(e){var t,i,r,s=!1,n=e.lastIndexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==n&&(!a||n>1)?(t=e.substring(0,n),i=e.substring(n+1)):t=e,-1!==(n=(r=i||t).indexOf("!"))&&(s="strip"===r.substring(n+1),r=r.substring(0,n),i?i=r:t=r),{moduleName:t,ext:i,strip:s}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,r,s){var n,a,o,h=t.xdRegExp.exec(e);return!h||(n=h[2],o=(a=(a=h[3]).split(":"))[1],a=a[0],!(n&&n!==i||a&&a.toLowerCase()!==r.toLowerCase()||(o||a)&&o!==s))},finishLoad:function(e,i,r,s){r=i?t.strip(r):r,_.isBuild&&(f[e]=r),s(r)},load:function(e,i,r,s){if(s&&s.isBuild&&!s.inlineText)r();else{_.isBuild=s&&s.isBuild;var n=t.parseName(e),a=n.moduleName+(n.ext?"."+n.ext:""),o=i.toUrl(a),h=_.useXhr||t.useXhr;0!==o.indexOf("empty:")?!l||h(o,c,u,d)?t.get(o,function(i){t.finishLoad(e,n.strip,i,r)},function(e){r.error&&r.error(e)}):i([a],function(e){t.finishLoad(n.moduleName+"."+n.ext,n.strip,e,r)}):r()}},write:function(e,i,r,s){if(f.hasOwnProperty(i)){var n=t.jsEscape(f[i]);r.asModule(e+"!"+i,"define(function () { return '"+n+"';});\n")}},writeFile:function(e,i,r,s,n){var a=t.parseName(i),o=a.ext?"."+a.ext:"",h=a.moduleName+o,l=r.toUrl(a.moduleName+o)+".js";t.load(h,r,function(i){var r=function(e){return s(l,e)};r.asModule=function(e,t){return s.asModule(e,l,t)},t.write(e,h,r,n)},n)}},"node"===_.env||!_.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(i=require.nodeRequire("fs"),t.get=function(e,t,r){try{var s=i.readFileSync(e,"utf8");"\ufeff"===s[0]&&(s=s.substring(1)),t(s)}catch(e){r&&r(e)}}):"xhr"===_.env||!_.env&&t.createXhr()?t.get=function(e,i,r,s){var n,a=t.createXhr();if(a.open("GET",e,!0),s)for(n in s)s.hasOwnProperty(n)&&a.setRequestHeader(n.toLowerCase(),s[n]);_.onXhr&&_.onXhr(a,e),a.onreadystatechange=function(t){var s,n;4===a.readyState&&((s=a.status||0)>399&&s<600?((n=new Error(e+" HTTP status: "+s)).xhr=a,r&&r(n)):i(a.responseText),_.onXhrComplete&&_.onXhrComplete(a,e))},a.send(null)}:"rhino"===_.env||!_.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,r,s=new java.io.File(e),n=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),"utf-8")),o="";try{for(i=new java.lang.StringBuffer,(r=a.readLine())&&r.length()&&65279===r.charAt(0)&&(r=r.substring(1)),null!==r&&i.append(r);null!==(r=a.readLine());)i.append(n),i.append(r);o=String(i.toString())}finally{a.close()}t(o)}:("xpconnect"===_.env||!_.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(r=Components.classes,s=Components.interfaces,Components.utils.import("resource://gre/modules/FileUtils.jsm"),n="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var i,a,o,h={};n&&(e=e.replace(/\//g,"\\")),o=new FileUtils.File(e);try{(i=r["@mozilla.org/network/file-input-stream;1"].createInstance(s.nsIFileInputStream)).init(o,1,0,!1),(a=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(s.nsIConverterInputStream)).init(i,"utf-8",i.available(),s.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),a.readString(i.available(),h),a.close(),i.close(),t(h.value)}catch(e){throw new Error((o&&o.path||"")+": "+e)}}),t}),define("bimsurfer/src/BimServerModel",["../lib/text"],function(e){return function(e){this.api=e.bimServerApi,this.apiModel=e,this.tree=null,this.treePromise=null,this.getTree=function(t){var i=this;return i.treePromise||(i.treePromise=new Promise(function(t,r){i.tree&&t(i.tree);var s={IfcRelDecomposes:1,IfcRelAggregates:1,IfcRelContainedInSpatialStructure:1,IfcRelFillsElement:1,IfcRelVoidsElement:1},n={},a=[];for(var o in e.objects){var h=e.objects[o].object;h.parent=null,n[h._i]=h,a.push(h)}var l=function(e){return"[object Array]"===Object.prototype.toString.call(e)},c=[],u={};a.filter(function(e){return s[e._t]}).map(function(e){var t=Object.keys(e),i=t.filter(function(e){return-1!==e.indexOf("Related")});return[e[t.filter(function(e){return-1!==e.indexOf("Relating")})[0]],e[i[0]]]}).forEach(function(e){for(var t=l(e[0])?e[0]:[e[0]],i=l(e[1])?e[1]:[e[1]],r=0;r<t.length;++r)for(var s=0;s<i.length;++s){var a=n[t[r]._i],o=n[i[s]._i];o.parent=a.id=a._i,o.id=o._i,a.hasChildren=!0,u[o.id]||c.push(o),u[a.id]||c.push(a),u[a.id]=u[o.id]=!0}});var d,f=(d=null,function(e){var t={};return e.forEach(function(e){t[e.id]=e}),e.forEach(function(e){if(null===e.parent)d=e;else{var i=t[e.parent];(i.children||(i.children=[])).push(e)}}),d});t(i.tree=f(c.map(function(e){return{name:e.Name,id:e.id,guid:e.GlobalId,parent:e.parent,gid:null==e._rgeometry?null:e._rgeometry._i}})))}))}}}),define("bimsurfer/src/PreloadQuery",{defines:{Representation:{type:"IfcProduct",fields:["Representation","geometry"]},ContainsElementsDefine:{type:"IfcSpatialStructureElement",field:"ContainsElements",include:{type:"IfcRelContainedInSpatialStructure",field:"RelatedElements",includes:["IsDecomposedByDefine","ContainsElementsDefine","Representation"]}},IsDecomposedByDefine:{type:"IfcObjectDefinition",field:"IsDecomposedBy",include:{type:"IfcRelDecomposes",field:"RelatedObjects",includes:["IsDecomposedByDefine","ContainsElementsDefine","Representation"]}}},queries:[{type:"IfcProject",includes:["IsDecomposedByDefine","ContainsElementsDefine"]},{type:"IfcRepresentation",includeAllSubtypes:!0},{type:"IfcProductRepresentation"},{type:"IfcPresentationLayerWithStyle"},{type:"IfcProduct",includeAllSubtypes:!0},{type:"IfcProductDefinitionShape"},{type:"IfcPresentationLayerAssignment"},{type:"IfcRelAssociatesClassification",includes:[{type:"IfcRelAssociatesClassification",field:"RelatedObjects"},{type:"IfcRelAssociatesClassification",field:"RelatingClassification"}]},{type:"IfcSIUnit"},{type:"IfcPresentationLayerAssignment"}]}),define("bimsurfer/lib/StringView",[],function(){function e(t,i,r,s){var n,a,o,h,l,c,u=isFinite(r)?r:0,d=15;i&&(this.encoding=i.toString());e:switch(this.encoding){case"UTF-8":h=e.putUTF8CharCode,l=e.getUTF8CharLength,n=Uint8Array;break e;case"UTF-16":h=e.putUTF16CharCode,l=e.getUTF16CharLength,n=Uint16Array;break e;case"UTF-32":n=Uint32Array,d&=14;break e;default:n=Uint8Array,d&=14}e:switch(typeof t){case"string":d&=7;break e;case"object":switch(t.constructor){case e:d&=3;break e;case String:d&=7;break e;case ArrayBuffer:a=new n(t),c="UTF-32"===this.encoding?t.byteLength>>>2:"UTF-16"===this.encoding?t.byteLength>>>1:t.byteLength,o=0!==u||isFinite(s)&&s!==c?new n(t,u,isFinite(s)?s:c-u):a;break e;case Uint32Array:case Uint16Array:case Uint8Array:n=t.constructor,c=t.length,a=0===t.byteOffset&&t.length===(n===Uint32Array?t.buffer.byteLength>>>2:n===Uint16Array?t.buffer.byteLength>>>1:t.buffer.byteLength)?t:new n(t.buffer),o=0!==u||isFinite(s)&&s!==c?t.subarray(u,isFinite(s)?u+s:c):t;break e;default:c=(a=new n(t)).length,o=0!==u||isFinite(s)&&s!==c?a.subarray(u,isFinite(s)?u+s:c):a}break e;default:a=o=new n(Number(t)||0)}if(d<8){var f,_,p,g,m,y,v;4&d?(_=c=(f=t).length,d^="UTF-32"===this.encoding?0:2,u=p=r?Math.max((_+r)%_,0):0,m=g=(Number.isInteger(s)?Math.min(Math.max(s,0)+u,_):_)-1):(f=t.rawData,c=t.makeIndex(),u=p=r?Math.max((c+r)%c,0):0,m=g=(_=Number.isInteger(s)?Math.min(Math.max(s,0),c-p):c)+p,"UTF-8"===t.encoding?(y=e.getUTF8CharLength,v=e.loadUTF8CharCode):"UTF-16"===t.encoding?(y=e.getUTF16CharLength,v=e.loadUTF16CharCode):d&=1),(0===_||d<4&&f.encoding===this.encoding&&0===p&&_===c)&&(d=7);e:switch(d){case 0:a=new n(_);for(var x=0;x<_;a[x]=f[u+x++]);break e;case 1:_=0;for(var b=u;b<m;b++)_+=l(f[b]);a=new n(_);for(b=u,x=0;x<_;b++)x=h(a,f[b],x);break e;case 2:for(u=0,M=0;M<p;M++)u+=y(w=v(f,u));a=new n(_);for(b=u,x=0;x<_;b+=y(w),x++)w=v(f,b),a[x]=w;break e;case 3:var w;_=0;var M=0;for(b=0;M<g;b+=y(w))w=v(f,b),M===p&&(u=b),++M>p&&(_+=l(w));a=new n(_);for(b=u,x=0;x<_;b+=y(w))x=h(a,w=v(f,b),x);break e;case 4:a=new n(_);for(var E=0;E<_;E++)a[E]=255&f.charCodeAt(E);break e;case 5:_=0;for(var S=0;S<c;S++)S===p&&(u=_),_+=l(f.charCodeAt(S)),S===g&&(m=_);a=new n(_);for(x=0,M=0;x<_;M++)x=h(a,f.charCodeAt(M),x);break e;case 6:a=new n(_);for(E=0;E<_;E++)a[E]=f.charCodeAt(E);break e;case 7:a=new n(_?f:0)}o=d>3&&(u>0||m<a.length-1)?a.subarray(u,m):a}this.buffer=a.buffer,this.bufferView=a,this.rawData=o,Object.freeze(this)}return Number.isInteger||(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&e<9007199254740992&&Math.floor(e)===e}),e.loadUTF8CharCode=function(e,t){var i=e.length,r=e[t];return r>251&&r<254&&t+5<i?1073741824*(r-252)+(e[t+1]-128<<24)+(e[t+2]-128<<18)+(e[t+3]-128<<12)+(e[t+4]-128<<6)+e[t+5]-128:r>247&&r<252&&t+4<i?(r-248<<24)+(e[t+1]-128<<18)+(e[t+2]-128<<12)+(e[t+3]-128<<6)+e[t+4]-128:r>239&&r<248&&t+3<i?(r-240<<18)+(e[t+1]-128<<12)+(e[t+2]-128<<6)+e[t+3]-128:r>223&&r<240&&t+2<i?(r-224<<12)+(e[t+1]-128<<6)+e[t+2]-128:r>191&&r<224&&t+1<i?(r-192<<6)+e[t+1]-128:r},e.putUTF8CharCode=function(e,t,i){var r=i;return t<128?e[r++]=t:t<2048?(e[r++]=192+(t>>>6),e[r++]=128+(63&t)):t<65536?(e[r++]=224+(t>>>12),e[r++]=128+(t>>>6&63),e[r++]=128+(63&t)):t<2097152?(e[r++]=240+(t>>>18),e[r++]=128+(t>>>12&63),e[r++]=128+(t>>>6&63),e[r++]=128+(63&t)):t<67108864?(e[r++]=248+(t>>>24),e[r++]=128+(t>>>18&63),e[r++]=128+(t>>>12&63),e[r++]=128+(t>>>6&63),e[r++]=128+(63&t)):(e[r++]=252+t/1073741824,e[r++]=128+(t>>>24&63),e[r++]=128+(t>>>18&63),e[r++]=128+(t>>>12&63),e[r++]=128+(t>>>6&63),e[r++]=128+(63&t)),r},e.getUTF8CharLength=function(e){return e<128?1:e<2048?2:e<65536?3:e<2097152?4:e<67108864?5:6},e.loadUTF16CharCode=function(e,t){var i=e[t];return i>55231&&t+1<e.length?(i-55296<<10)+e[t+1]+9216:i},e.putUTF16CharCode=function(e,t,i){var r=i;return t<65536?e[r++]=t:(e[r++]=55232+(t>>>10),e[r++]=56320+(1023&t)),r},e.getUTF16CharLength=function(e){return e<65536?1:2},e.b64ToUint6=function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43===e?62:47===e?63:0},e.uint6ToB64=function(e){return e<26?e+65:e<52?e+71:e<62?e-4:62===e?43:63===e?47:65},e.bytesToBase64=function(t){for(var i,r="",s=t.length,n=0,a=0;a<s;a++)i=a%3,a>0&&4*a/3%76==0&&(r+="\r\n"),n|=t[a]<<(16>>>i&24),2!==i&&t.length-a!=1||(r+=String.fromCharCode(e.uint6ToB64(n>>>18&63),e.uint6ToB64(n>>>12&63),e.uint6ToB64(n>>>6&63),e.uint6ToB64(63&n)),n=0);return r.replace(/A(?=A$|$)/g,"=")},e.base64ToBytes=function(t,i){for(var r,s,n=t.replace(/[^A-Za-z0-9\+\/]/g,""),a=n.length,o=i?Math.ceil((3*a+1>>>2)/i)*i:3*a+1>>>2,h=new Uint8Array(o),l=0,c=0,u=0;u<a;u++)if(s=3&u,l|=e.b64ToUint6(n.charCodeAt(u))<<18-6*s,3===s||a-u==1){for(r=0;r<3&&c<o;r++,c++)h[c]=l>>>(16>>>r&24)&255;l=0}return h},e.makeFromBase64=function(t,i,r,s){return new e("UTF-16"===i||"UTF-32"===i?e.base64ToBytes(t,"UTF-16"===i?2:4).buffer:e.base64ToBytes(t),i,r,s)},e.prototype.encoding="UTF-8",e.prototype.makeIndex=function(e,t){var i,r=this.rawData,s=r.length,n=t||0,a=n,o=isNaN(e)?1/0:e;if(e+1>r.length)throw new RangeError("StringView.prototype.makeIndex - The offset can't be major than the length of the array - 1.");switch(this.encoding){case"UTF-8":var h;for(i=0;a<s&&i<o;i++)a+=(h=r[a])>251&&h<254&&a+5<s?6:h>247&&h<252&&a+4<s?5:h>239&&h<248&&a+3<s?4:h>223&&h<240&&a+2<s?3:h>191&&h<224&&a+1<s?2:1;break;case"UTF-16":for(i=n;a<s&&i<o;i++)a+=r[a]>55231&&a+1<r.length?2:1;break;default:a=i=isFinite(e)?e:s-1}return e?a:i},e.prototype.toBase64=function(t){return e.bytesToBase64(t?this.bufferView.constructor===Uint8Array?this.bufferView:new Uint8Array(this.buffer):this.rawData.constructor===Uint8Array?this.rawData:new Uint8Array(this.buffer,this.rawData.byteOffset,this.rawData.length<<(this.rawData.constructor===Uint16Array?1:2)))},e.prototype.subview=function(t,i){var r,s,n,a,o="UTF-8"===this.encoding||"UTF-16"===this.encoding,h=t,l=this.rawData.length;return 0===l?new e(this.buffer,this.encoding):(a=o?this.makeIndex():l,s=t?Math.max((a+t)%a,0):0,n=Number.isInteger(i)?Math.max(i,0)+s>a?a-s:i:a,0===s&&n===a?this:(o?(h=this.makeIndex(s),r=this.makeIndex(n,h)-h):(h=s,r=n-s),"UTF-16"===this.encoding?h<<=1:"UTF-32"===this.encoding&&(h<<=2),new e(this.buffer,this.encoding,h,r)))},e.prototype.forEachChar=function(t,i,r,s){var n,a,o=this.rawData;if("UTF-8"===this.encoding||"UTF-16"===this.encoding){var h,l;"UTF-8"===this.encoding?(h=e.getUTF8CharLength,l=e.loadUTF8CharCode):"UTF-16"===this.encoding&&(h=e.getUTF16CharLength,l=e.loadUTF16CharCode),a=isFinite(r)?this.makeIndex(r):0,n=isFinite(s)?this.makeIndex(s,a):o.length;for(var c,u=0;a<n;u++)c=l(o,a),t.call(i||null,c,u,a,o),a+=h(c)}else for(a=isFinite(r)?r:0,n=isFinite(s)?s+a:o.length;a<n;a++)t.call(i||null,o[a],a,a,o)},e.prototype.valueOf=e.prototype.toString=function(){if("UTF-8"!==this.encoding&&"UTF-16"!==this.encoding)return String.fromCharCode.apply(null,this.rawData);var t,i,r="";"UTF-8"===this.encoding?(i=e.getUTF8CharLength,t=e.loadUTF8CharCode):"UTF-16"===this.encoding&&(i=e.getUTF16CharLength,t=e.loadUTF16CharCode);for(var s,n=this.rawData.length,a=0;a<n;a+=i(s))s=t(this.rawData,a),r+=String.fromCharCode(s);return r},e}),define("bimsurfer/src/DataInputStreamReader",["../lib/StringView"],function(e){return function(t){this.arrayBuffer=t,this.dataView=new DataView(this.arrayBuffer),this.pos=0,this.readUTF8=function(){var t=this.dataView.getInt16(this.pos);this.pos+=2;var i=this.arrayBuffer.slice(this.pos,this.pos+t),r=new e(i).toString();return this.pos+=t,r},this.align4=function(){var e=4-this.pos%4;e>0&&4!=e&&(this.pos+=e)},this.align8=function(){var e=8-this.pos%8;e>0&&8!=e&&(this.pos+=e)},this.readDoubleArray=function(e){var t=new Float64Array(this.arrayBuffer,this.pos,e);return this.pos+=8*e,t},this.readFloat=function(){var e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e},this.readInt=function(){var e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e},this.readByte=function(){var e=this.dataView.getInt8(this.pos);return this.pos+=1,e},this.readLong=function(){var e=this.dataView.getUint32(this.pos,!0)+4294967296*this.dataView.getUint32(this.pos+4,!0);return this.pos+=8,e},this.readFloatArray2=function(e){for(var t=[],i=0;i<e;i++){var r=this.dataView.getFloat32(this.pos,!0);this.pos+=4,t.push(r)}return t},this.readFloatArray=function(e){var t=new Float32Array(this.arrayBuffer,this.pos,e);return this.pos+=4*e,t},this.readIntArray2=function(e){for(var t=[],i=0;i<e;i++){var r=this.dataView.getInt32(this.pos,!0);this.pos+=4,t.push(r)}return t},this.readIntArray=function(e){var t=new Int32Array(this.arrayBuffer,this.pos,e);return this.pos+=4*e,t},this.readShortArray=function(e){try{var t=new Int16Array(this.arrayBuffer,this.pos,e);return this.pos+=2*e,t}catch(e){}}}}),define("bimsurfer/src/BimServerGeometryLoader",["./DataInputStreamReader"],function(e){return function(t,i,r,s,n){var a=this;a.bimServerApi=t,a.viewer=i,a.state={},a.progressListeners=[],a.objectAddedListeners=[],a.prepareReceived=!1,a.todo=[],a.geometryIds={},a.dataToInfo={},a.model=r,a.roid=s,console.log(n),this.addProgressListener=function(e){a.progressListeners.push(e)},this.process=function(){for(var t,i=a.todo.shift();null!=i;){(t=new e(i)).readLong();var r=t.readByte();0==r?a._readStart(t):6==r?a._readEnd(t):a._readObject(t,r),i=a.todo.shift()}},this.setLoadOids=function(e){a.options={type:"oids",oids:e}},this.start=function(){if(!a.options||"oids"!==a.options.type)throw new Error("Invalid loader configuration");if("1.4"==BIMSERVER_VERSION)a.groupId=a.roid,a.oids=a.options.oids,a.bimServerApi.getMessagingSerializerByPluginClassName("org.bimserver.serializers.binarygeometry.BinaryGeometryMessagingSerializerPlugin",function(e){a.bimServerApi.call("Bimsie1ServiceInterface","downloadByOids",{roids:[a.roid],oids:a.options.oids,serializerOid:e.oid,sync:!1,deep:!1},function(e){a.topicId=e,a.bimServerApi.registerProgressHandler(a.topicId,a._progressHandler,a._afterRegistration)})});else{var e=[];for(var t in a.groupId=a.roid,a.infoToOid=a.options.oids,a.infoToOid){var i=parseInt(a.infoToOid[t]);a.model.apiModel.get(i,function(t){null!=t.object._rgeometry&&(null!=t.model.objects[t.object._rgeometry]?t.getGeometry(function(i){e.push({gid:t.object._rgeometry,oid:t.oid,object:t,info:i.object})}):e.push({gid:t.object._rgeometry,oid:t.oid,object:t}))})}e.sort(function(e,t){return null!=e.info&&null!=t.info?(e.info._emaxBounds.z+e.info._eminBounds.z)/2-(t.info._emaxBounds.z+t.info._eminBounds.z)/2:e.object.getType().localeCompare(t.object.getType())});var r=[];e.forEach(function(e){r.push(e.object.object._rgeometry._i)});var s={type:"GeometryInfo",oids:r,include:{type:"GeometryInfo",field:"data"}};a.bimServerApi.getSerializerByPluginClassName("org.bimserver.serializers.binarygeometry.BinaryGeometryMessagingStreamingSerializerPlugin3",function(e){a.bimServerApi.call("ServiceInterface","download",{roids:[a.roid],query:JSON.stringify(s),serializerOid:e.oid,sync:!1},function(e){a.topicId=e,a.bimServerApi.registerProgressHandler(a.topicId,a._progressHandler)})})}},this._progressHandler=function(e,t){e==a.topicId&&("Done preparing"==t.title&&(a.prepareReceived||(a.prepareReceived=!0,a._downloadInitiated())),"FINISHED"==t.state&&a.bimServerApi.unregisterProgressHandler(a.topicId,a._progressHandler))},this._downloadInitiated=function(){a.state={mode:0,nrObjectsRead:0,nrObjects:0};var e={longActionId:a.topicId,topicId:a.topicId};a.bimServerApi.setBinaryDataListener(a.topicId,a._binaryDataListener),a.bimServerApi.downloadViaWebsocket(e)},this._binaryDataListener=function(e){a.todo.push(e)},this._afterRegistration=function(e){a.bimServerApi.call("Bimsie1NotificationRegistryInterface","getProgress",{topicId:a.topicId},function(e){a._progressHandler(a.topicId,e)})},this._readEnd=function(e){a.progressListeners.forEach(function(e){e("done",a.state.nrObjectsRead,a.state.nrObjectsRead)}),a.bimServerApi.call("ServiceInterface","cleanupLongAction",{topicId:a.topicId},function(){})},this._readStart=function(e){var t=e.readUTF8();if("BGS"!=t)return console.error("data does not start with BGS ("+t+")"),!1;if(a.protocolVersion=e.readByte(),"1.4"==BIMSERVER_VERSION){if(4!=version&&5!=version&&6!=version)return console.error("Unimplemented version"),!1}else if(10!=a.protocolVersion&&11!=a.protocolVersion)return console.error("Unimplemented version"),!1;if(e.align8(),"1.4"==BIMSERVER_VERSION)var i=e.readFloatArray(6);else i=e.readDoubleArray(6);this._initCamera(i),a.state.mode=1,"1.4"==BIMSERVER_VERSION&&(a.state.nrObjects=e.readInt()),a.progressListeners.forEach(function(e){e("start",a.state.nrObjectsRead,a.state.nrObjectsRead)})},this._initCamera=function(e){if(!this._gotCamera){this._gotCamera=!0;var t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=Math.sqrt(Math.pow(s-t,2)+Math.pow(n-i,2)+Math.pow(a-r,2)),h=100/o;this.viewer.setScale(h);var l=[h*((s+t)/2),h*((n+i)/2),h*((a+r)/2)];this.viewer.setCamera({type:"persp",target:l,up:[0,0,1],eye:[l[0]-h*o,l[1]-h*o,l[2]+h*o],far:5e3,near:.1,fovy:35.8493})}},this._updateProgress=function(){},this._readObject=function(e,t){var i,r,s,o,h,l,c,u,d;"1.4"!=BIMSERVER_VERSION&&e.align8();var f=null;if(1==t){if(i=e.readLong(),s=e.readInt(),o="1.4"==BIMSERVER_VERSION?e.readIntArray(s):e.readShortArray(s),11==a.protocolVersion&&1==e.readInt())var _={r:e.readFloat(),g:e.readFloat(),b:e.readFloat(),a:e.readFloat()};if(e.align4(),h=e.readInt(),l=e.readFloatArray(h),c=e.readInt(),u=e.readFloatArray(c),(d=e.readInt())>0)f=e.readFloatArray(d);else if(null!=_){f=new Array(4*h);for(var p=0;p<h;p++)f[4*p+0]=_.r,f[4*p+1]=_.g,f[4*p+2]=_.b,f[4*p+3]=_.a}a.geometryIds[i]=[i],this.viewer.createGeometry(i,l,u,f,o),null!=a.dataToInfo[i]&&(a.dataToInfo[i].forEach(function(e){a.viewer.getObject(a.roid+":"+e).add(i)}),delete a.dataToInfo[i])}else if(2==t)console.log("Unimplemented",2);else if(3==t){var g=e.readLong();r=e.readInt(),a.geometryIds[g]=[];var m=[];for(p=0;p<r;p++){if(e.readLong(),i=g+"_"+p,s=e.readInt(),o="1.4"==BIMSERVER_VERSION?e.readIntArray(s):e.readShortArray(s),11==a.protocolVersion&&1==e.readInt()&&(_={r:e.readFloat(),g:e.readFloat(),b:e.readFloat(),a:e.readFloat()}),e.align4(),h=e.readInt(),l=e.readFloatArray(h),c=e.readInt(),u=e.readFloatArray(c),(d=e.readInt())>0)f=e.readFloatArray(d);else if(null!=_)for(f=new Array(4*h),p=0;p<h;p++)f[4*p+0]=_.r,f[4*p+1]=_.g,f[4*p+2]=_.b,f[4*p+3]=_.a;m.push(i),a.geometryIds[g].push(i),this.viewer.createGeometry(i,l,u,f,o)}null!=a.dataToInfo[g]&&(a.dataToInfo[g].forEach(function(e){var t=a.viewer.getObject(a.roid+":"+e);m.forEach(function(e){t.add(e)})}),delete a.dataToInfo[g])}else if(4==t)console.log("Unimplemented",4);else{if(5!=t)return void this.warn("Unsupported geometry type: "+t);var y=e.readLong(),v=e.readLong(),x=(e.readDoubleArray(6),e.readDoubleArray(16));null!=n&&xeogl.math.mulMat4(x,x,n),g=e.readLong();var b=a.geometryIds[g],w=a.infoToOid[v];if(null==b){b=[];var M=a.dataToInfo[g];null==M&&(M=[],a.dataToInfo[g]=M),M.push(w)}null==w?console.error("Not found",a.infoToOid,v):a.model.apiModel.get(w,function(e){e.gid=v;var t=a.roid;a._createObject(t,y,w,w,b,e.getType(),x)})}a.state.nrObjectsRead++,a._updateProgress()},this._createObject=function(e,t,i,r,s,n,o){0!=a.state.mode?a.viewer.createObject(e,t,i,r,s,n,o):console.log("Mode is still 0, should be 1")}}}),define("bimsurfer/src/DefaultMaterials",{IfcSpace:[.137255,.403922,.870588,.5],IfcRoof:[.837255,.203922,.270588,1],IfcSlab:[.637255,.603922,.670588,1],IfcWall:[.537255,.337255,.237255,1],IfcWallStandardCase:[.537255,.337255,.237255,1],IfcDoor:[.637255,.603922,.670588,1],IfcWindow:[.137255,.403922,.870588,.5],IfcOpeningElement:[.137255,.403922,.870588,0],IfcRailing:[.137255,.403922,.870588,1],IfcColumn:[.137255,.403922,.870588,1],IfcBeam:[.137255,.403922,.870588,1],IfcFurnishingElement:[.137255,.403922,.870588,1],IfcCurtainWall:[.137255,.403922,.870588,1],IfcStair:[.637255,.603922,.670588,1],IfcStairFlight:[.637255,.603922,.670588,1],IfcBuildingElementProxy:[.5,.5,.5,1],IfcFlowSegment:[.137255,.403922,.870588,1],IfcFlowitting:[.137255,.403922,.870588,1],IfcFlowTerminal:[.137255,.403922,.870588,1],IfcProxy:[.137255,.403922,.870588,1],IfcSite:[.137255,.403922,.870588,1],IfcLightFixture:[.8470588235,.8470588235,.870588,1],IfcDuctSegment:[.8470588235,.427450980392,0,1],IfcDistributionFlowElement:[.8470588235,.427450980392,0,1],IfcDuctFitting:[.8470588235,.427450980392,0,1],IfcPlate:[.8470588235,.427450980392,0,.5],IfcAirTerminal:[.8470588235,.427450980392,0,1],IfcMember:[.8470588235,.427450980392,0,1],IfcCovering:[.8470588235,.427450980392,0,1],IfcTransportElement:[.8470588235,.427450980392,0,1],IfcFlowController:[.8470588235,.427450980392,0,1],IfcFlowFitting:[.8470588235,.427450980392,0,1],IfcRamp:[.8470588235,.427450980392,0,1],IfcFurniture:[.8470588235,.427450980392,0,1],IfcFooting:[.8470588235,.427450980392,0,1],IfcSystemFurnitureElement:[.8470588235,.427450980392,0,1],DEFAULT:[.5,.5,.5,1]}),define("bimsurfer/src/EventHandler",[],function(){function e(){this.handlers={}}return e.prototype.on=function(e,t){(this.handlers[e]||(this.handlers[e]=[])).push(t)},e.prototype.off=function(e,t){var i=this.handlers[e],r=!1;if(void 0!==i){var s=i.indexOf(t);s>=-1&&(i.splice(s,1),r=!0)}if(!r)throw new Error("Handler not found")},e.prototype.fire=function(e,t){var i=this.handlers[e];if(i)for(var r=0;r<i.length;++r)i[r].apply(this,t)},e}),define("bimsurfer/src/Utils",[],function(){var e=function(t,i){if(t.nodeType===t.TEXT_NODE){var r=t.nodeValue;if(null===r.match(/^\s+$/))return r}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var s={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var n=0;n<t.attributes.length;n++){var a=t.attributes[n];s[i[a.nodeName]||a.nodeName]=a.nodeValue}for(var o=0;o<t.childNodes.length;o++){var h=t.childNodes[o];(n=e(h,i))&&s.children.push(n)}return s}},t=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],s=i;s<r;++s)t.push(s);return String.fromCharCode.apply(null,t)}).join(""),i=function(e,i){return(i&&4!=i?[0,6]:[0,6,12,18]).map(function(i){return t.substr(parseInt(e/(1<<i))%64,1)}).reverse().join("")};return{XmlToJson:e,Clone:function(e){return JSON.parse(JSON.stringify(e))},CompressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(t){return parseInt(e.substr(t,2),16)});return i(t[0],2)+[1,4,7,10,13].map(function(e){return i((t[e]<<16)+(t[e+1]<<8)+t[e+2])}).join("")},FindNodeOfType:function(e,t){var i=[],r=function(e){e.type===t&&i.push(e),(e.children||[]).forEach(function(e){r(e)})};return r(e),i},Delay:function(e){return new Promise(function(t,i){setTimeout(t,e)})}}}),function(){"use strict";var e,t=function(){this.version=null,this.WEBGL_INFO=function(){var e={WEBGL:!1},t=document.createElement("canvas");if(!t)return e;var i=t.getContext("webgl",{antialias:!0})||t.getContext("experimental-webgl",{antialias:!0});return e.WEBGL=!!i,e.WEBGL?(e.ANTIALIAS=i.getContextAttributes().antialias,i.getShaderPrecisionFormat?i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT).precision>0?e.FS_MAX_FLOAT_PRECISION="highp":i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_FLOAT).precision>0?e.FS_MAX_FLOAT_PRECISION="mediump":e.FS_MAX_FLOAT_PRECISION="lowp":e.FS_MAX_FLOAT_PRECISION="mediump",e.DEPTH_BUFFER_BITS=i.getParameter(i.DEPTH_BITS),e.MAX_TEXTURE_SIZE=i.getParameter(i.MAX_TEXTURE_SIZE),e.MAX_CUBE_MAP_SIZE=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),e.MAX_RENDERBUFFER_SIZE=i.getParameter(i.MAX_RENDERBUFFER_SIZE),e.MAX_TEXTURE_UNITS=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),e.MAX_VERTEX_ATTRIBS=i.getParameter(i.MAX_VERTEX_ATTRIBS),e.MAX_VERTEX_UNIFORM_VECTORS=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),e.MAX_FRAGMENT_UNIFORM_VECTORS=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),e.MAX_VARYING_VECTORS=i.getParameter(i.MAX_VARYING_VECTORS),e.SUPPORTED_EXTENSIONS={},i.getSupportedExtensions().forEach(function(t){e.SUPPORTED_EXTENSIONS[t]=!0}),e):e}(),this.stats={build:{version:t.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,tangents:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=[];var e=this;!function(){var t,i,r,s,n,a={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},o=10,h=0,l=[],c=0,u=function(){t=Date.now(),h>0&&(c+=i=1e3/(t-h),l.push(i),l.length>=30&&(c-=l.shift()),e.stats.frame.fps=Math.round(c/l.length)),function(){r=Date.now();var t=e._runScheduledTasks(r+o),i=e._taskQueue.length;for(s in e.stats.frame.tasksRun=t,e.stats.frame.tasksScheduled=i,e.stats.frame.tasksBudget=o,a.time=r,e.scenes)e.scenes.hasOwnProperty(s)&&(n=e.scenes[s],a.sceneId=s,a.startTime=n.startTime,a.deltaTime=null!=a.prevTime?a.time-a.prevTime:0,n.fire("tick",a,!0));a.prevTime=r}(),function(){var t,i,r,n=e.scenes,a=e._scenesRenderInfo;for(s in n)n.hasOwnProperty(s)&&(t=n[s],i=a[s],r=t.ticksPerRender,i.ticksPerRender!==r&&(i.ticksPerRender=r,i.renderCountdown=r),0==--i.renderCountdown&&(t.render(!1),i.renderCountdown=r))}(),h=t,window.requestAnimationFrame(u)};window.requestAnimationFrame(u)}()};t.prototype={constructor:t,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},_addScene:function(e){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,e.id){if(this.scenes[e.id])return void console.error("[ERROR] Scene "+t._inQuotes(e.id)+" already exists")}else e.id=this._sceneIDMap.addItem(e);this.scenes[e.id]=e;var i=e.ticksPerRender;this._scenesRenderInfo[e.id]={ticksPerRender:i,renderCountdown:i},this.stats.components.scenes++;var r=this;e.on("destroyed",function(){r._sceneIDMap.removeItem(e.id),delete r.scenes[e.id],delete r._scenesRenderInfo[e.id],r.stats.components.scenes--})},scheduleTask:function(e,t){this._taskQueue.push(e),this._taskQueue.push(t)},deferTask:function(e,t){t?e.call(t):e()},_runScheduledTasks:function(e){for(var t,i,r=(new Date).getTime(),s=this._taskQueue,n=0;s.length>0&&r<e;)t=s.shift(),(i=s.shift())?t.call(i):t(),r=(new Date).getTime(),n++;return n},clear:function(){var e;for(var t in this.scenes)this.scenes.hasOwnProperty(t)&&(e=this.scenes[t],"default.scene"===t?e.clear():e.destroy());this.scenes={}},_isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},_isString:function(e){return"string"==typeof e||e instanceof String},_isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},_isID:function(e){return t._isString(e)||t._isNumeric(e)},_isSameComponent:function(e,i){return!(!e||!i)&&(t.prototype._isNumeric(e)||t.prototype._isString(e)?""+e:e.id)===(t.prototype._isNumeric(i)||t.prototype._isString(i)?""+i:i.id)},_isFunction:function(e){return"function"==typeof e},_isObject:(e={}.constructor,function(t){return!!t&&t.constructor===e}),_isComponentType:function(e,t){if(e===(t=t||"xeogl.Component"))return!0;var i=this._superTypes[e];if(!i)return!1;for(var r=i.length-1;r>=0;r--)if(i[r]===t)return!0;return!1},_copy:function(e){return this._apply(e,{})},_apply:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},_apply2:function(e,t){for(var i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},_applyIf:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},_isEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},_inQuotes:function(e){return this._isNumeric(e)?""+e:"'"+e+"'"}},window.xeogl=window.xeogl=new t}();var Canvas2Image=function(){var e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var i=!!e.getContext("2d").getImageData,r=!!e.toDataURL,s=!!window.btoa,n=function(e){var i="",r=e.width,s=e.height;i+="BM";var n=r*s*4+54;i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);var a=r;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256);var o=s;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),i+=t(1,0,32,0),i+=t(0,0,0,0);var h=r*s*4;i+=t(h%256),h=Math.floor(h/256),i+=t(h%256),h=Math.floor(h/256),i+=t(h%256),h=Math.floor(h/256),i+=t(h%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var l,c,u,d,f=e.data,_="",p=s;do{for(u=r*(p-1)*4,d="",l=0;l<r;l++)d+=t(f[u+(c=4*l)+2],f[u+c+1],f[u+c],f[u+c+3]);_+=d}while(--p);return function(e){var i,r,s="";if("string"==typeof e)s=e;else for(r=e,i=0;i<r.length;i++)s+=t(r[i]);return btoa(s)}(i+_)},a=function(e){window.open(e)||(document.location.href=e)},o=function(e,t){return"data:"+t+";base64,"+e},h=function(e){var t=document.createElement("img");return t.src=e,t},l=function(e,t,i){if(t&&i){var r=document.createElement("canvas");return r.width=t,r.height=i,r.style.width=t+"px",r.style.height=i+"px",r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,t),r}return e};return{saveAsPNG:function(e,t,i,s){if(!r)return!1;var n=l(e,i,s).toDataURL("image/png");return t?h(n):(a(n),!0)},saveAsJPEG:function(e,t,i,s){if(!r)return!1;var n=l(e,i,s).toDataURL("image/jpeg");return 5==n.indexOf("image/jpeg")&&(t?h(n):(a(n),!0))},saveAsBMP:function(e,t,c,u){if(!(r&&i&&s))return!1;var d=function(e){var t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(l(e,c,u)),f=n(d);return t?h(o(f,"image/bmp")):(a(o(f,"image/bmp")),!0)}}}();function highlight(e,t){t.length&&bimSurfer.viewFit({ids:t,animate:!0}),bimSurfer.setSelection({ids:t,clear:!0,selected:!0})}!function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){var r=this.prototype;e=!0;var s=new this;for(var n in e=!1,i)if("_props"!==n)s[n]="function"==typeof i[n]&&"function"==typeof r[n]&&t.test(i[n])?function(e,t){return function(){var i=this._super;this._super=r[e];var s=t.apply(this,arguments);return this._super=i,s}}(n,i[n]):i[n];else{var o,h=i[n];for(var l in h)(o=h[l]).set||function(){var e=l;o.set=function(){this.warn("Property '"+e+"' is read-only, ignoring assignment")}}(),o.enumerable=!0,Object.defineProperty(s,l,o)}function c(){!e&&this.__init&&this.__init.apply(this,arguments)}return s.superTypes=r.superTypes?r.superTypes.concat(r.type):[],i.type?xeogl._superTypes[i.type]=s.superTypes:i.type=r.type+"_"+a(),c.prototype=s,c.prototype.constructor=c,c.extend=arguments.callee,window[i.type]=c,c};var i,r,s,n,a=(r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),n=0,function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?s[e]="-":14===e?s[e]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),i=15&n,n>>=4,s[e]=r[19===e?3&i|8:i]);return s.join("")})}(),function(){"use strict";xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(e,t){this.items=e||[];var i=(t=t||0)+1;this.addItem=function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(;;){e=arguments[0]||{};var r=i++;if(!this.items[r])return this.items[r]=e,r}},this.removeItem=function(e){var t=this.items[e];return delete this.items[e],t}}}(),function(){"use strict";var e,t,i,r,s,n,a=new Float32Array(16),o=new Float32Array(16),h=new Float32Array(4),l=xeogl.math={DEGTORAD:.0174532925,vec2:function(e){return new Float32Array(e||2)},vec3:function(e){return new Float32Array(e||3)},vec4:function(e){return new Float32Array(e||4)},mat3:function(e){return new Float32Array(e||9)},mat3ToMat4:function(e,t){},mat4:function(e){return new Float32Array(e||16)},mat4ToMat3:function(e,t){},createUUID:(r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),n=0,function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?s[e]="-":14===e?s[e]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),i=15&n,n>>=4,s[e]=r[19===e?3&i|8:i]);return s.join("")}),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},fmod:function(e,t){if(e<t)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},negateVec4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},addVec4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i},addVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i},addVec3:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i},addVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i},subVec4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i},subVec3:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i},subVec2:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i},subVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i},subScalarVec4:function(e,t,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i},mulVec4:function(e,t,i){return i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i},mulVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i},mulVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i},mulVec2Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i},divVec3:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i},divVec4:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i},divScalarVec3:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i},divVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i},divVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i},divScalarVec4:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i},dotVec4:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},cross3Vec4:function(e,t){var i=e[0],r=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return[r*o-s*a,s*n-i*o,i*a-r*n,0]},cross3Vec3:function(e,t,i){i||(i=e);var r=e[0],s=e[1],n=e[2],a=t[0],o=t[1],h=t[2];return i[0]=s*h-n*o,i[1]=n*a-r*h,i[2]=r*o-s*a,i},sqLenVec4:function(e){return l.dotVec4(e,e)},lenVec4:function(e){return Math.sqrt(l.sqLenVec4(e))},dotVec3:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dotVec2:function(e,t){return e[0]*t[0]+e[1]*t[1]},sqLenVec3:function(e){return l.dotVec3(e,e)},sqLenVec2:function(e){return l.dotVec2(e,e)},lenVec3:function(e){return Math.sqrt(l.sqLenVec3(e))},lenVec2:function(e){return Math.sqrt(l.sqLenVec2(e))},rcpVec3:function(e,t){return l.divScalarVec3(1,e,t)},normalizeVec4:function(e,t){var i=1/l.lenVec4(e);return l.mulVec4Scalar(e,i,t)},normalizeVec3:function(e,t){var i=1/l.lenVec3(e);return l.mulVec3Scalar(e,i,t)},normalizeVec2:function(e,t){var i=1/l.lenVec2(e);return l.mulVec2Scalar(e,i,t)},vec3FromMat4Scale:(t=new Float32Array(3),function(e,i){return t[0]=e[0],t[1]=e[1],t[2]=e[2],i[0]=l.lenVec3(t),t[0]=e[4],t[1]=e[5],t[2]=e[6],i[1]=l.lenVec3(t),t[0]=e[8],t[1]=e[9],t[2]=e[10],i[2]=l.lenVec3(t),i}),dupMat4:function(e){return e.slice(0,16)},mat4To3:function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]},m4s:function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]},setMat4ToZeroes:function(){return l.m4s(0)},setMat4ToOnes:function(){return l.m4s(1)},diagonalMat4v:function(e){return new Float32Array([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]])},diagonalMat4c:function(e,t,i,r){return l.diagonalMat4v([e,t,i,r])},diagonalMat4s:function(e){return l.diagonalMat4c(e,e,e,e)},identityMat4:function(e){return(e=e||new Float32Array(16))[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},isIdentityMat4:function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},negateMat4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},addMat4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i},addMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i},addScalarMat4:function(e,t,i){return l.addMat4Scalar(t,e,i)},subMat4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i},subMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i},subScalarMat4:function(e,t,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i},mulMat4:function(e,t,i){i||(i=e);var r=e[0],s=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],f=e[10],_=e[11],p=e[12],g=e[13],m=e[14],y=e[15],v=t[0],x=t[1],b=t[2],w=t[3],M=t[4],E=t[5],S=t[6],C=t[7],D=t[8],k=t[9],T=t[10],B=t[11],A=t[12],F=t[13],P=t[14],O=t[15];return i[0]=v*r+x*o+b*u+w*p,i[1]=v*s+x*h+b*d+w*g,i[2]=v*n+x*l+b*f+w*m,i[3]=v*a+x*c+b*_+w*y,i[4]=M*r+E*o+S*u+C*p,i[5]=M*s+E*h+S*d+C*g,i[6]=M*n+E*l+S*f+C*m,i[7]=M*a+E*c+S*_+C*y,i[8]=D*r+k*o+T*u+B*p,i[9]=D*s+k*h+T*d+B*g,i[10]=D*n+k*l+T*f+B*m,i[11]=D*a+k*c+T*_+B*y,i[12]=A*r+F*o+P*u+O*p,i[13]=A*s+F*h+P*d+O*g,i[14]=A*n+F*l+P*f+O*m,i[15]=A*a+F*c+P*_+O*y,i},mulMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i},mulMat4v4:function(e,t){var i=t[0],r=t[1],s=t[2],n=t[3];return[e[0]*i+e[4]*r+e[8]*s+e[12]*n,e[1]*i+e[5]*r+e[9]*s+e[13]*n,e[2]*i+e[6]*r+e[10]*s+e[14]*n,e[3]*i+e[7]*r+e[11]*s+e[15]*n]},transposeMat4:function(e,t){var i=e[4],r=e[14],s=e[8],n=e[13],a=e[12],o=e[9];if(!t||e===t){var h=e[1],l=e[2],c=e[3],u=e[6],d=e[7],f=e[11];return e[1]=i,e[2]=s,e[3]=a,e[4]=h,e[6]=o,e[7]=n,e[8]=l,e[9]=u,e[11]=r,e[12]=c,e[13]=d,e[14]=f,e}return t[0]=e[0],t[1]=i,t[2]=s,t[3]=a,t[4]=e[1],t[5]=e[5],t[6]=o,t[7]=n,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=r,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},determinantMat4:function(e){var t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11],f=e[12],_=e[13],p=e[14],g=e[15];return f*c*o*s-l*_*o*s-f*a*u*s+n*_*u*s+l*a*p*s-n*c*p*s-f*c*r*h+l*_*r*h+f*i*u*h-t*_*u*h-l*i*p*h+t*c*p*h+f*a*r*d-n*_*r*d-f*i*o*d+t*_*o*d+n*i*p*d-t*a*p*d-l*a*r*g+n*c*r*g+l*i*o*g-t*c*o*g-n*i*u*g+t*a*u*g},inverseMat4:function(e,t){t||(t=e);var i=e[0],r=e[1],s=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],f=e[11],_=e[12],p=e[13],g=e[14],m=e[15],y=i*o-r*a,v=i*h-s*a,x=i*l-n*a,b=r*h-s*o,w=r*l-n*o,M=s*l-n*h,E=c*p-u*_,S=c*g-d*_,C=c*m-f*_,D=u*g-d*p,k=u*m-f*p,T=d*m-f*g,B=1/(y*T-v*k+x*D+b*C-w*S+M*E);return t[0]=(o*T-h*k+l*D)*B,t[1]=(-r*T+s*k-n*D)*B,t[2]=(p*M-g*w+m*b)*B,t[3]=(-u*M+d*w-f*b)*B,t[4]=(-a*T+h*C-l*S)*B,t[5]=(i*T-s*C+n*S)*B,t[6]=(-_*M+g*x-m*v)*B,t[7]=(c*M-d*x+f*v)*B,t[8]=(a*k-o*C+l*E)*B,t[9]=(-i*k+r*C-n*E)*B,t[10]=(_*w-p*x+m*y)*B,t[11]=(-c*w+u*x-f*y)*B,t[12]=(-a*D+o*S-h*E)*B,t[13]=(i*D-r*S+s*E)*B,t[14]=(-_*b+p*v-g*y)*B,t[15]=(c*b-u*v+d*y)*B,t},traceMat4:function(e){return e[0]+e[5]+e[10]+e[15]},translationMat4v:function(e,t){var i=t||l.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat4c:(e=new Float32Array(3),function(t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,l.translationMat4v(e,s)}),translationMat4s:function(e,t){return l.translationMat4c(e,e,e,t)},translateMat4v:function(e,t){return l.translateMat4c(e[0],e[1],e[2],t)},OLDtranslateMat4c:function(e,t,i,r){var s=r[12];r[0]+=s*e,r[4]+=s*t,r[8]+=s*i;var n=r[13];r[1]+=n*e,r[5]+=n*t,r[9]+=n*i;var a=r[14];r[2]+=a*e,r[6]+=a*t,r[10]+=a*i;var o=r[15];return r[3]+=o*e,r[7]+=o*t,r[11]+=o*i,r},translateMat4c:function(e,t,i,r){var s=r[3];r[0]+=s*e,r[1]+=s*t,r[2]+=s*i;var n=r[7];r[4]+=n*e,r[5]+=n*t,r[6]+=n*i;var a=r[11];r[8]+=a*e,r[9]+=a*t,r[10]+=a*i;var o=r[15];return r[12]+=o*e,r[13]+=o*t,r[14]+=o*i,r},rotationMat4v:function(e,t,i){var r,s,n,a,o,h,c=l.normalizeVec4([t[0],t[1],t[2],0],[]),u=Math.sin(e),d=Math.cos(e),f=1-d,_=c[0],p=c[1],g=c[2];return r=_*p,s=p*g,n=g*_,a=_*u,o=p*u,h=g*u,(i=i||l.mat4())[0]=f*_*_+d,i[1]=f*r+h,i[2]=f*n-o,i[3]=0,i[4]=f*r-h,i[5]=f*p*p+d,i[6]=f*s+a,i[7]=0,i[8]=f*n+o,i[9]=f*s-a,i[10]=f*g*g+d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(e,t,i,r,s){return l.rotationMat4v(e,[t,i,r],s)},scalingMat4v:function(e,t){return(t=t||l.identityMat4())[0]=e[0],t[5]=e[1],t[10]=e[2],t},scalingMat4c:function(){var e=new Float32Array(3);return function(t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,l.scalingMat4v(e,s)}}(),scaleMat4c:function(e,t,i,r){return r[0]*=e,r[4]*=t,r[8]*=i,r[1]*=e,r[5]*=t,r[9]*=i,r[2]*=e,r[6]*=t,r[10]*=i,r[3]*=e,r[7]*=t,r[11]*=i,r},scaleMat4v:function(e,t){var i=e[0],r=e[1],s=e[2];return t[0]*=i,t[4]*=r,t[8]*=s,t[1]*=i,t[5]*=r,t[9]*=s,t[2]*=i,t[6]*=r,t[10]*=s,t[3]*=i,t[7]*=r,t[11]*=s,t},scalingMat4s:function(e){return l.scalingMat4c(e,e,e)},rotationTranslationMat4:function(e,t,i){i=i||l.mat4();var r=e[0],s=e[1],n=e[2],a=e[3],o=r+r,h=s+s,c=n+n,u=r*o,d=r*h,f=r*c,_=s*h,p=s*c,g=n*c,m=a*o,y=a*h,v=a*c;return i[0]=1-(_+g),i[1]=d+v,i[2]=f-y,i[3]=0,i[4]=d-v,i[5]=1-(u+g),i[6]=p+m,i[7]=0,i[8]=f+y,i[9]=p-m,i[10]=1-(u+_),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler:function(e,t,i){i=i||l.vec4();var r=l.clamp,s=e[0],n=e[4],a=e[8],o=e[1],h=e[5],c=e[9],u=e[2],d=e[6],f=e[10];return"XYZ"===t?(i[1]=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-c,f),i[2]=Math.atan2(-n,s)):(i[0]=Math.atan2(d,h),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-r(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(a,f),i[2]=Math.atan2(o,h)):(i[1]=Math.atan2(-u,s),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(r(d,-1,1)),Math.abs(d)<.99999?(i[1]=Math.atan2(-u,f),i[2]=Math.atan2(-n,h)):(i[1]=0,i[2]=Math.atan2(o,s))):"ZYX"===t?(i[1]=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(d,f),i[2]=Math.atan2(o,s)):(i[0]=0,i[2]=Math.atan2(-n,h))):"YZX"===t?(i[2]=Math.asin(r(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-c,h),i[1]=Math.atan2(-u,s)):(i[0]=0,i[1]=Math.atan2(a,f))):"XZY"===t&&(i[2]=Math.asin(-r(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(d,h),i[1]=Math.atan2(a,s)):(i[0]=Math.atan2(-c,f),i[1]=0)),i},lookAtMat4v:function(e,t,i,r){r||(r=l.mat4());var s,n,a,o,h,c,u,d,f,_,p=e[0],g=e[1],m=e[2],y=i[0],v=i[1],x=i[2],b=t[0],w=t[1],M=t[2];return p===b&&g===w&&m===M?l.identityMat4():(s=p-b,n=g-w,a=m-M,o=v*(a*=_=1/Math.sqrt(s*s+n*n+a*a))-x*(n*=_),h=x*(s*=_)-y*a,c=y*n-v*s,(_=Math.sqrt(o*o+h*h+c*c))?(o*=_=1/_,h*=_,c*=_):(o=0,h=0,c=0),u=n*c-a*h,d=a*o-s*c,f=s*h-n*o,(_=Math.sqrt(u*u+d*d+f*f))?(u*=_=1/_,d*=_,f*=_):(u=0,d=0,f=0),r[0]=o,r[1]=u,r[2]=s,r[3]=0,r[4]=h,r[5]=d,r[6]=n,r[7]=0,r[8]=c,r[9]=f,r[10]=a,r[11]=0,r[12]=-(o*p+h*g+c*m),r[13]=-(u*p+d*g+f*m),r[14]=-(s*p+n*g+a*m),r[15]=1,r)},lookAtMat4c:function(e,t,i,r,s,n,a,o,h){return l.lookAtMat4v([e,t,i],[r,s,n],[a,o,h],[])},orthoMat4c:function(e,t,i,r,s,n,a){a||(a=l.mat4());var o=t-e,h=r-i,c=n-s;return a[0]=2/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/h,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/c,a[11]=0,a[12]=-(e+t)/o,a[13]=-(r+i)/h,a[14]=-(n+s)/c,a[15]=1,a},frustumMat4v:function(e,t,i){i||(i=l.mat4());var r=[e[0],e[1],e[2],0],s=[t[0],t[1],t[2],0];l.addVec4(s,r,a),l.subVec4(s,r,o);var n=2*r[2],h=o[0],c=o[1],u=o[2];return i[0]=n/h,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=n/c,i[6]=0,i[7]=0,i[8]=a[0]/h,i[9]=a[1]/c,i[10]=-a[2]/u,i[11]=-1,i[12]=0,i[13]=0,i[14]=-n*s[2]/u,i[15]=0,i},frustumMat4:function(e,t,i,r,s,n,a){a||(a=l.mat4());var o=t-e,h=r-i,c=n-s;return a[0]=2*s/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*s/h,a[6]=0,a[7]=0,a[8]=(t+e)/o,a[9]=(r+i)/h,a[10]=-(n+s)/c,a[11]=-1,a[12]=0,a[13]=0,a[14]=-n*s*2/c,a[15]=0,a},perspectiveMat4:function(e,t,i,r,s){var n=[],a=[];return n[2]=i,a[2]=r,a[1]=n[2]*Math.tan(e/2),n[1]=-a[1],a[0]=a[1]*t,n[0]=-a[0],l.frustumMat4v(n,a,s)},transformPoint3:function(e,t,i){return(i=i||l.vec3())[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14],i},transformPoint4:function(e,t,i){return(i=i||l.vec4())[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i},transformPoints3:function(e,t,i){for(var r,s,n,a,o,h=i||[],l=t.length,c=e[0],u=e[1],d=e[2],f=e[3],_=e[4],p=e[5],g=e[6],m=e[7],y=e[8],v=e[9],x=e[10],b=e[11],w=e[12],M=e[13],E=e[14],S=e[15],C=0;C<l;++C)r=(a=t[C])[0],s=a[1],n=a[2],(o=h[C]||(h[C]=[0,0,0]))[0]=c*r+_*s+y*n+w,o[1]=u*r+p*s+v*n+M,o[2]=d*r+g*s+x*n+E,o[3]=f*r+m*s+b*n+S;return h.length=l,h},transformPositions3:function(e,t,i){var r;i=i||t;var s,n,a,o=t.length,h=e[0],l=e[1],c=e[2],u=e[3],d=e[4],f=e[5],_=e[6],p=e[7],g=e[8],m=e[9],y=e[10],v=e[11],x=e[12],b=e[13],w=e[14],M=e[15];for(r=0;r<o;r+=3)s=t[r+0],n=t[r+1],a=t[r+2],i[r+0]=h*s+d*n+g*a+x,i[r+1]=l*s+f*n+m*a+b,i[r+2]=c*s+_*n+y*a+w,i[r+3]=u*s+p*n+v*a+M;return i},transformVec3:function(e,t,i){var r=t[0],s=t[1],n=t[2];return(i=i||this.vec3())[0]=e[0]*r+e[4]*s+e[8]*n,i[1]=e[1]*r+e[5]*s+e[9]*n,i[2]=e[2]*r+e[6]*s+e[10]*n,i},transformVec4:function(e,t,i){var r=t[0],s=t[1],n=t[2],a=t[3];return(i=i||l.vec4())[0]=e[0]*r+e[4]*s+e[8]*n+e[12]*a,i[1]=e[1]*r+e[5]*s+e[9]*n+e[13]*a,i[2]=e[2]*r+e[6]*s+e[10]*n+e[14]*a,i[3]=e[3]*r+e[7]*s+e[11]*n+e[15]*a,i},rotateVec3X:function(e,t,i,r){var s=[],n=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],n[0]=s[0],n[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),n[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),r[0]=n[0]+t[0],r[1]=n[1]+t[1],r[2]=n[2]+t[2],r},rotateVec3Y:function(e,t,i,r){var s=[],n=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],n[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),n[1]=s[1],n[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),r[0]=n[0]+t[0],r[1]=n[1]+t[1],r[2]=n[2]+t[2],r},rotateVec3Z:function(e,t,i,r){var s=[],n=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],n[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),n[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),n[2]=s[2],r[0]=n[0]+t[0],r[1]=n[1]+t[1],r[2]=n[2]+t[2],r},projectVec4:function(e,t){var i=1/e[3];return(t=t||l.vec2())[0]=v[0]*i,t[1]=v[1]*i,t},lerpVec3:function(e,t,i,r,s,n){var a=n||l.vec3(),o=(e-t)/(i-t);return a[0]=r[0]+o*(s[0]-r[0]),a[1]=r[1]+o*(s[1]-r[1]),a[2]=r[2]+o*(s[2]-r[2]),a},flatten:function(e){var t,i,r,s,n,a=[];for(t=0,i=e.length;t<i;t++)for(r=0,s=(n=e[t]).length;r<s;r++)a.push(n[r]);return a},identityQuaternion:function(e){return(e=e||l.vec4())[0]=0,e[1]=0,e[2]=0,e[3]=1,e},eulerToQuaternion:function(e,t,i){i=i||l.vec4();var r=Math.cos(e[0]/2),s=Math.cos(e[1]/2),n=Math.cos(e[2]/2),a=Math.sin(e[0]/2),o=Math.sin(e[1]/2),h=Math.sin(e[2]/2);return"XYZ"===t?(i[0]=a*s*n+r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n-a*o*h):"YXZ"===t?(i[0]=a*s*n+r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n+a*o*h):"ZXY"===t?(i[0]=a*s*n-r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n-a*o*h):"ZYX"===t?(i[0]=a*s*n-r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n+a*o*h):"YZX"===t?(i[0]=a*s*n+r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n-a*o*h):"XZY"===t&&(i[0]=a*s*n-r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n+a*o*h),i},mat4ToQuaternion:function(e,t){t=t||l.vec4();var i,r=e[0],s=e[4],n=e[8],a=e[1],o=e[5],h=e[9],c=e[2],u=e[6],d=e[10],f=r+o+d;return f>0?(i=.5/Math.sqrt(f+1),t[3]=.25/i,t[0]=(u-h)*i,t[1]=(n-c)*i,t[2]=(a-s)*i):r>o&&r>d?(i=2*Math.sqrt(1+r-o-d),t[3]=(u-h)/i,t[0]=.25*i,t[1]=(s+a)/i,t[2]=(n+c)/i):o>d?(i=2*Math.sqrt(1+o-r-d),t[3]=(n-c)/i,t[0]=(s+a)/i,t[1]=.25*i,t[2]=(h+u)/i):(i=2*Math.sqrt(1+d-r-o),t[3]=(a-s)/i,t[0]=(n+c)/i,t[1]=(h+u)/i,t[2]=.25*i),t},vec3PairToQuaternion:function(e,t,i){i=i||l.vec4();var r=Math.sqrt(l.dotVec3(e,e)*l.dotVec3(t,t)),s=r+l.dotVec3(e,t);return s<1e-8*r?(s=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):l.cross3Vec3(e,t,i),i[3]=s,l.normalizeQuaternion(i)},angleAxisToQuaternion:function(e,t){t=t||l.vec4();var i=e[3]/2,r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t},quaternionToEuler:function(e,t,i){i=i||l.vec4();var r=e[3]/2,s=Math.sin(r);return i[0]=s*e[0],i[1]=s*e[1],i[2]=s*e[2],i[3]=Math.cos(r),i},mulQuaternions:function(e,t,i){i=i||l.vec4();var r=e[0],s=e[1],n=e[2],a=e[3],o=t[0],h=t[1],c=t[2],u=t[3];return i[0]=a*o+r*u+s*c-n*h,i[1]=a*h+s*u+n*o-r*c,i[2]=a*c+n*u+r*h-s*o,i[3]=a*u-r*o-s*h-n*c,i},vec3ApplyQuaternion:function(e,t,i){i=i||l.vec3();var r=t[0],s=t[1],n=t[2],a=e[0],o=e[1],h=e[2],c=e[3],u=c*r+o*n-h*s,d=c*s+h*r-a*n,f=c*n+a*s-o*r,_=-a*r-o*s-h*n;return i[0]=u*c+_*-a+d*-h-f*-o,i[1]=d*c+_*-o+f*-a-u*-h,i[2]=f*c+_*-h+u*-o-d*-a,i},quaternionToMat4:function(e,t){t=l.identityMat4(t);var i=e[0],r=e[1],s=e[2],n=e[3],a=2*i,o=2*r,h=2*s,c=a*n,u=o*n,d=h*n,f=a*i,_=o*i,p=h*i,g=o*r,m=h*r,y=h*s;return t[0]=1-(g+y),t[1]=_+d,t[2]=p-u,t[4]=_-d,t[5]=1-(f+y),t[6]=m+c,t[8]=p+u,t[9]=m-c,t[10]=1-(f+g),t},quaternionToRotationMat4:function(e,t){var i=e[0],r=e[1],s=e[2],n=e[3],a=i+i,o=r+r,h=s+s,l=i*a,c=i*o,u=i*h,d=r*o,f=r*h,_=s*h,p=n*a,g=n*o,m=n*h;return t[0]=1-(d+_),t[4]=c-m,t[8]=u+g,t[1]=c+m,t[5]=1-(l+_),t[9]=f-p,t[2]=u-g,t[6]=f+p,t[10]=1-(l+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion:function(e,t){t=t||e;var i=l.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:function(e,t){return(t=t||e)[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},inverseQuaternion:function(e,t){return l.normalizeQuaternion(l.conjugateQuaternion(e,t))},quaternionToAngleAxis:function(e,t){t=t||l.vec4();var i=(e=l.normalizeQuaternion(e,h))[3],r=2*Math.acos(i),s=Math.sqrt(1-i*i);return s<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/s,t[0]=e[1]/s,t[0]=e[2]/s),t[3]=r,t}}}(),function(){"use strict";var e,t,i,r=xeogl.math;r.AABB3=function(e){return new Float32Array(e||6)},r.AABB2=function(e){return new Float32Array(e||4)},r.OBB3=function(e){return new Float32Array(e||32)},r.OBB2=function(e){return new Float32Array(e||16)},r.transformOBB3=function(e,t,i){var r;i=i||t;var s,n,a,o=t.length,h=e[0],l=e[1],c=e[2],u=e[3],d=e[4],f=e[5],_=e[6],p=e[7],g=e[8],m=e[9],y=e[10],v=e[11],x=e[12],b=e[13],w=e[14],M=e[15];for(r=0;r<o;r+=4)s=t[r+0],n=t[r+1],a=t[r+2],i[r+0]=h*s+d*n+g*a+x,i[r+1]=l*s+f*n+m*a+b,i[r+2]=c*s+_*n+y*a+w,i[r+3]=u*s+p*n+v*a+M;return i},r.getAABB3Diag=(e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),function(s){return e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],r.subVec3(t,e,i),Math.abs(r.lenVec3(i))}),r.getAABB3DiagPoint=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return function(s,n){e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];var a=r.subVec3(t,e,i),o=n[0]-s[0],h=s[3]-n[0],l=n[1]-s[1],c=s[4]-n[1],u=n[2]-s[2],d=s[5]-n[2];return a[0]+=o>h?o:h,a[1]+=l>c?l:c,a[2]+=u>d?u:d,Math.abs(r.lenVec3(a))}}(),r.getAABB3Center=function(e,t){var i=t||r.vec3();return i[0]=.5*(e[3]+e[0]),i[1]=.5*(e[4]+e[1]),i[2]=.5*(e[5]+e[2]),i},r.getAABB2Center=function(e,t){var i=t||r.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},r.collapseAABB3=function(e){return(e=e||r.AABB3())[0]=1e7,e[1]=1e7,e[2]=1e7,e[3]=-1e7,e[4]=-1e7,e[5]=-1e7,e},r.AABB3ToOBB3=function(e,t){return(t=t||r.OBB3())[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t},r.positions3ToAABB3=function(e,t){t=t||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,c=-1e5,u=-1e5,d=0,f=e.length;d<f;d+=3)i=e[d+0],s=e[d+1],n=e[d+2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>c&&(c=s),n>u&&(u=n);return t[0]=a,t[1]=o,t[2]=h,t[3]=l,t[4]=c,t[5]=u,t},r.OBB3ToAABB3=function(e,t){t=t||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,c=-1e5,u=-1e5,d=0,f=e.length;d<f;d+=4)i=e[d+0],s=e[d+1],n=e[d+2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>c&&(c=s),n>u&&(u=n);return t[0]=a,t[1]=o,t[2]=h,t[3]=l,t[4]=c,t[5]=u,t},r.points3ToAABB3=function(e,t){t=t||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,c=-1e5,u=-1e5,d=0,f=e.length;d<f;d++)i=e[d][0],s=e[d][1],n=e[d][2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>c&&(c=s),n>u&&(u=n);return t[0]=a,t[1]=o,t[2]=h,t[3]=l,t[4]=c,t[5]=u,t},r.points3ToSphere3=function(){var e=new Float32Array(3);return function(t,i){i=i||r.vec4();var s,n=0,a=0,o=0,h=t.length;for(s=0;s<h;s++)n+=t[s][0],a+=t[s][1],o+=t[s][2];i[0]=n/h,i[1]=a/h,i[2]=o/h;var l,c=0;for(s=0;s<h;s++)(l=Math.abs(r.lenVec3(r.subVec3(t[s],i,e))))>c&&(c=l);return i[3]=c,i}}(),r.OBB3ToSphere3=function(){var e=new Float32Array(3),t=new Float32Array(3);return function(i,s){s=s||r.vec4();var n,a=0,o=0,h=0,l=i.length,c=l/4;for(n=0;n<l;n+=4)a+=i[n+0],o+=i[n+1],h+=i[n+2];s[0]=a/c,s[1]=o/c,s[2]=h/c;var u,d=0;for(n=0;n<l;n+=4)e[0]=i[n+0],e[1]=i[n+1],e[2]=i[n+2],(u=Math.abs(r.lenVec3(r.subVec3(e,s,t))))>d&&(d=u);return s[3]=d,s}}(),r.getSphere3Center=function(e,t){return(t=t||r.vec3())[0]=e[0],t[1]=e[1],t[2]=e[2],t},r.expandAABB3=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e},r.expandAABB3Point3=function(e,t){return e[0]<t[0]&&(e[0]=t[0]),e[1]<t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]>t[0]&&(e[3]=t[0]),e[4]>t[1]&&(e[4]=t[1]),e[5]>t[2]&&(e[5]=t[2]),e},r.collapseAABB2=function(e){return(e=e||r.AABB2())[0]=1e7,e[1]=1e7,e[2]=-1e7,e[3]=-1e7,e},r.OBB3ToAABB2=function(e,t){t=t||r.AABB2();for(var i,s,n,a=1e7,o=1e7,h=-1e7,l=-1e7,c=0,u=e.length;c<u;c+=4)i=e[c+0],s=e[c+1],s*=n=1/(e[c+3]||1),(i*=n)<a&&(a=i),s<o&&(o=s),i>h&&(h=i),s>l&&(l=s);return t[0]=a,t[1]=o,t[2]=h,t[3]=l,t},r.expandAABB2=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e},r.expandAABB2Point2=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e},r.AABB2ToCanvas=function(e,t,i,r){r=r||e;var s=.5*(e[0]+1),n=.5*(e[1]+1),a=.5*(e[2]+1),o=.5*(e[3]+1);return r[0]=Math.floor(s*t),r[1]=i-Math.floor(o*i),r[2]=Math.floor(a*t),r[3]=i-Math.floor(n*i),r}}(),function(){"use strict";var e,t,i,r,s,n=xeogl.math;n.triangleNormal=function(e,t,i,r){r=r||n.vec3();var s=t[0]-e[0],a=t[1]-e[1],o=t[2]-e[2],h=i[0]-e[0],l=i[1]-e[1],c=i[2]-e[2],u=a*c-o*l,d=o*h-s*c,f=s*l-a*h,_=Math.sqrt(u*u+d*d+f*f);return 0===_?(r[0]=0,r[1]=0,r[2]=0):(r[0]=u/_,r[1]=d/_,r[2]=f/_),r},n.rayTriangleIntersect=(e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),r=new Float32Array(3),s=new Float32Array(3),function(a,o,h,l,c,u){u=u||n.vec3();var d=n.subVec3(l,h,e),f=n.subVec3(c,h,t),_=n.cross3Vec3(o,f,i),p=n.dotVec3(d,_);if(p<1e-6)return null;var g=n.subVec3(a,h,r),m=n.dotVec3(g,_);if(m<0||m>p)return null;var y=n.cross3Vec3(g,d,s),v=n.dotVec3(o,y);if(v<0||m+v>p)return null;var x=n.dotVec3(f,y)/p;return u[0]=a[0]+x*o[0],u[1]=a[1]+x*o[1],u[2]=a[2]+x*o[2],u}),n.rayPlaneIntersect=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),r=new Float32Array(3);return function(s,a,o,h,l,c){c=c||n.vec3(),a=n.normalizeVec3(a,e);var u=n.subVec3(h,o,t),d=n.subVec3(l,o,i),f=n.cross3Vec3(u,d,r);n.normalizeVec3(f,f);var _=-n.dotVec3(o,f),p=-(n.dotVec3(s,f)+_)/n.dotVec3(a,f);return c[0]=s[0]+p*a[0],c[1]=s[1]+p*a[1],c[2]=s[2]+p*a[2],c}}(),n.cartesianToBarycentric=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return function(r,s,a,o,h){var l=n.subVec3(o,s,e),c=n.subVec3(a,s,t),u=n.subVec3(r,s,i),d=n.dotVec3(l,l),f=n.dotVec3(l,c),_=n.dotVec3(l,u),p=n.dotVec3(c,c),g=n.dotVec3(c,u),m=d*p-f*f;if(0===m)return null;var y=1/m,v=(p*_-f*g)*y,x=(d*g-f*_)*y;return h[0]=1-v-x,h[1]=x,h[2]=v,h}}(),n.barycentricInsideTriangle=function(e){var t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},n.barycentricToCartesian=function(e,t,i,r,s){s=s||n.vec3();var a=e[0],o=e[1],h=e[2];return s[0]=t[0]*a+i[0]*o+r[0]*h,s[1]=t[1]*a+i[1]*o+r[1]*h,s[2]=t[2]*a+i[2]*o+r[2]*h,s}}(),function(){"use strict";var e,t,i,r,s,n,a,o,h,l,c,u,d,f,_=xeogl.math;_.buildNormals=(e=_.vec3(),t=_.vec3(),i=_.vec3(),r=_.vec3(),s=_.vec3(),n=_.vec3(),a=_.vec3(),function(o,h){var l,c,u,d,f,p=new Array(o.length/3);for(l=0,c=h.length;l<c;l+=3)u=h[l],d=h[l+1],f=h[l+2],e[0]=o[3*u],e[1]=o[3*u+1],e[2]=o[3*u+2],t[0]=o[3*d],t[1]=o[3*d+1],t[2]=o[3*d+2],i[0]=o[3*f],i[1]=o[3*f+1],i[2]=o[3*f+2],_.subVec3(t,e,r),_.subVec3(i,e,s),_.normalizeVec3(_.cross3Vec3(r,s,n),a),p[u]||(p[u]=[]),p[d]||(p[d]=[]),p[f]||(p[f]=[]),p[u].push(a),p[d].push(a),p[f].push(a);var g=new Float32Array(o.length);for(l=0,c=p.length;l<c;l++){for(var m=p[l].length,y=0,v=0,x=0,b=0;b<m;b++)y+=p[l][b][0],v+=p[l][b][1],x+=p[l][b][2];g[3*l]=y/m,g[3*l+1]=v/m,g[3*l+2]=x/m}return g}),_.buildTangents=(o=new Float32Array(3),h=new Float32Array(3),l=new Float32Array(3),c=new Float32Array(3),u=new Float32Array(3),d=new Float32Array(3),f=new Float32Array(3),function(e,t,i){for(var r=new Float32Array(e.length),s=0;s<t.length;s+=3){var n=t[s],a=e.subarray(3*n,3*n+3),p=i.subarray(2*n,2*n+2);n=t[s+1];var g=e.subarray(3*n,3*n+3),m=i.subarray(2*n,2*n+2);n=t[s+2];for(var y,v=e.subarray(3*n,3*n+3),x=i.subarray(2*n,2*n+2),b=_.subVec3(g,a,o),w=_.subVec3(v,a,h),M=_.subVec2(m,p,l),E=_.subVec2(x,p,c),S=1/(M[0]*E[1]-M[1]*E[0]),C=_.mulVec3Scalar(_.subVec3(_.mulVec3Scalar(b,E[1],u),_.mulVec3Scalar(w,M[1],d),f),S,d),D=0;D<3;D++)r[y=3*t[s+D]]+=C[0],r[y+1]+=C[1],r[y+2]+=C[2]}return r}),_.buildPickTriangles=function(e,t){for(var i,r,s,n,a,o,h,l=t.length,c=new Float32Array(30*l),u=new Float32Array(40*l),d=0,f=0;f<l;f+=3)r=3*f,s=4*f,h=(d>>24&255)/255,o=(d>>16&255)/255,a=(d>>8&255)/255,n=(255&d)/255,i=3*t[f],c[r]=e[i],c[r+1]=e[i+1],c[r+2]=e[i+2],u[s]=n,u[s+1]=a,u[s+2]=o,u[s+3]=h,i=3*t[f+1],c[r+3]=e[i],c[r+4]=e[i+1],c[r+5]=e[i+2],u[s+4]=n,u[s+5]=a,u[s+6]=o,u[s+7]=h,i=3*t[f+2],c[r+6]=e[i],c[r+7]=e[i+1],c[r+8]=e[i+2],u[s+8]=n,u[s+9]=a,u[s+10]=o,u[s+11]=h,d++;return{positions:c,colors:u}}}(),function(){"use strict";var e=xeogl.math;e.tangentQuadraticBezier=function(e,t,i,r){return 2*(1-e)*(i-t)+2*e*(r-i)},e.tangentQuadraticBezier=function(e,t,i,r,s){return-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*s},e.tangentSpline=function(e){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},e.catmullRomInterpolate=function(e,t,i,r,s){var n=.5*(i-e),a=.5*(r-t),o=s*s;return(2*t-2*i+n+a)*(s*o)+(-3*t+3*i-2*n-a)*o+n*s+t},e.b2p0=function(e,t){var i=1-e;return i*i*t},e.b2p1=function(e,t){return 2*(1-e)*e*t},e.b2p2=function(e,t){return e*e*t},e.b2=function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},e.b3p0=function(e,t){var i=1-e;return i*i*i*t},e.b3p1=function(e,t){var i=1-e;return 3*i*i*e*t},e.b3p2=function(e,t){return 3*(1-e)*e*e*t},e.b3p3=function(e,t){return e*e*e*t},e.b3=function(e,t,i,r,s){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,s)}}(),function(){"use strict";var e,t,i,r,s;xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(e,t,i,r){r=r||{},this.stats=e||{},this.gl=i,this.canvas=t,this._programFactory=new xeogl.renderer.ProgramFactory(this.stats,i),this._objectFactory=new xeogl.renderer.ObjectFactory,this._chunkFactory=new xeogl.renderer.ChunkFactory,this.transparent=!0===r.transparent,this.bindOutputFramebuffer=null,this.unbindOutputFramebuffer=null,this.objects={},this._ambient=null,this.ambientColor=xeogl.math.vec4([0,0,0,1]),this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._frameCtx={canvas:this.canvas,renderTarget:null,renderBuf:null,depthbufEnabled:null,clearDepth:null,depthFunc:null,blendEnabled:!1,backfaces:!0,frontface:!0,textureUnit:0,transparent:!1,ambientColor:null,drawElements:0,useProgram:0,bindTexture:0,bindArray:null,pass:null,bindOutputFramebuffer:null,pickIndex:0},this.visibility=null,this.cull=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.billboard=null,this.stationary=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.viewport=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.imageDirty=!0},xeogl.renderer.Renderer.prototype.webglRestored=function(e){this.gl=e,this._programFactory.webglRestored(e),this._chunkFactory.webglRestored(),this.pickBuf&&this.pickBuf.webglRestored(e),this.imageDirty=!0},xeogl.renderer.Renderer.prototype.buildObject=function(e){var t=this.objects[e];t||((t=this._objectFactory.get(e)).hash=""),t.stage=this.stage,t.layer=this.layer,t.colorTarget=this.colorTarget,t.depthTarget=this.depthTarget,t.material=this.material,t.reflect=this.reflect,t.geometry=this.geometry,t.visibility=this.visibility,t.cull=this.cull,t.modes=this.modes,t.billboard=this.billboard,t.stationary=this.stationary,t.viewport=this.viewport;var i=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash,this.billboard.hash,this.stationary.hash].join(";");if(i!==t.hash){t.program&&this._programFactory.put(t.program),t.program=this._programFactory.get(i,this),t.hash=i,!0;var r=t.program;if(r){var s=r.program;if(!(s.allocated&&s.compiled&&s.validated&&s.linked))return this.objects[e]&&this.removeObject(e),{error:!0,errorLog:s.errorLog}}}return this._setChunk(t,0,"program",t.program),this._setChunk(t,1,"modelTransform",this.modelTransform),this._setChunk(t,2,"viewTransform",this.viewTransform),this._setChunk(t,3,"projTransform",this.projTransform),this._setChunk(t,4,"modes",this.modes),this._setChunk(t,5,"shader",this.shader),this._setChunk(t,6,"shaderParams",this.shaderParams),this._setChunk(t,7,"depthBuf",this.depthBuf),this._setChunk(t,8,"colorBuf",this.colorBuf),this._setChunk(t,9,"lights",this.lights),this._setChunk(t,10,this.material.type,this.material),this._setChunk(t,11,"clips",this.clips),this._setChunk(t,12,"viewport",this.viewport),this._setChunk(t,13,"geometry",this.geometry),this._setChunk(t,14,"draw",this.geometry,!0),this._setAmbient(this.lights),this.objects[e]?this.stateOrderDirty=!0:(this.objects[e]=t,this.objectListDirty=!0),t.compiled=!0,t},xeogl.renderer.Renderer.prototype._setChunk=function(e,t,i,r,s){var n,a=this._chunkFactory.types[i];n="program"===i?1e8*(e.program.id+1):a.constructor.prototype.programGlobal?r.id:1e8*(e.program.id+1)+(r.id+1),s&&(n*=1e5);var o=e.chunks[t];o&&this._chunkFactory.putChunk(o),e.chunks[t]=this._chunkFactory.getChunk(n,i,e.program.program,r)},xeogl.renderer.Renderer.prototype._setAmbient=function(e){for(var t,i=e.lights,r=0,s=i.length;r<s;r++)"ambient"===(t=i[r]).type&&(this._ambient=t)},xeogl.renderer.Renderer.prototype.removeObject=function(e){var t=this.objects[e];if(t){for(var i=t.chunks,r=0,s=i.length;r<s;r++)this._chunkFactory.putChunk(i[r]);this._programFactory.put(t.program),t.program=null,t.hash=null,this._objectFactory.put(t),delete this.objects[e],this.objectListDirty=!0}},xeogl.renderer.Renderer.prototype.render=function(e){e=e||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.imageDirty=!0),(this.imageDirty||e.force)&&(this._renderObjectList({clear:!1!==e.clear,opaqueOnly:e.opaqueOnly,pass:e.pass}),this.stats.frame.frameCount++,this.imageDirty=!1)},xeogl.renderer.Renderer.prototype._buildObjectList=function(){for(var e in this._objectListLen=0,this.objects)this.objects.hasOwnProperty(e)&&(this._objectList[this._objectListLen++]=this.objects[e])},xeogl.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var e,t=0,i=this._objectListLen;t<i;t++)(e=this._objectList[t]).program?e.sortKey=1e16*(e.stage.priority+1)+1e14*(e.modes.transparent?2:1)+1e13*(e.layer.priority+1)+1e8*(e.program.id+1)+1e4*(e.material.id+1)+e.geometry.id:e.sortKey=-1},xeogl.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(e,t){return e.sortKey-t.sortKey})},xeogl.renderer.Renderer.prototype._renderObjectList=function(e){var t=this.gl;xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&t.getExtension("OES_element_index_uint");var i=this._ambient;if(i){var r=i.color,s=i.intensity;this.ambientColor[0]=r[0]*s,this.ambientColor[1]=r[1]*s,this.ambientColor[2]=r[2]*s}else this.ambientColor[0]=0,this.ambientColor[1]=0,this.ambientColor[2]=0;var n,a,o,h,l,c,u=this._frameCtx;u.renderTarget=null,u.renderBuf=null,u.depthbufEnabled=null,u.clearDepth=null,u.depthFunc=t.LESS,u.blendEnabled=!1,u.backfaces=!0,u.frontface=!0,u.textureUnit=0,u.transparent=!1,u.ambientColor=this.ambientColor,u.drawElements=0,u.useProgram=0,u.bindTexture=0,u.bindArray=0,u.pass=e.pass,u.bindOutputFramebuffer=this.bindOutputFramebuffer,u.pickViewMatrix=e.pickViewMatrix,u.pickProjMatrix=e.pickProjMatrix,u.pickIndex=0,xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&t.getExtension("OES_element_index_uint"),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),this.transparent||e.pickObject||e.pickSurface?t.clearColor(0,0,0,0):t.clearColor(this.ambientColor[0],this.ambientColor[1],this.ambientColor[2],1),t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.disable(t.BLEND);var d,f=this._lastChunkId=this._lastChunkId||new Int32Array(30);for(n=0;n<20;n++)f[n]=-9999999999999;if(e.pickObject){for(t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this._objectPickListLen=0,n=0,a=this._objectListLen;n<a;n++)if((d=this._objectList[n]).compiled&&!0!==d.cull.culled&&!1!==d.visibility.visible&&!1!==d.modes.pickable)for(this._objectPickList[this._objectPickListLen++]=d,o=0,h=(l=d.chunks).length;o<h;o++)(c=l[o])&&c.pickObject&&(c.unique||f[o]!==c.id)&&(c.pickObject(u),f[o]=c.id)}else if(e.pickSurface){if(t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),e.object)for(n=0,a=(l=e.object.chunks).length;n<a;n++)(c=l[n]).pickPrimitive&&c.pickPrimitive(u)}else{var _=(new Date).getTime();for(this.bindOutputFramebuffer&&this.bindOutputFramebuffer(e.pass),e.clear&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),n=0,a=this._objectListLen;n<a;n++)if((d=this._objectList[n]).compiled&&!0!==d.cull.culled&&!1!==d.visibility.visible)for(o=0,h=(l=d.chunks).length;o<h;o++)(c=l[o])&&c.draw&&(c.unique||f[o]!==c.id)&&(c.draw(u),f[o]=c.id);var p=Date.now(),g=this.stats.frame;g.renderTime=(p-_)/1e3,g.drawElements=u.drawElements,g.useProgram=u.useProgram,g.bindTexture=u.bindTexture,g.bindArray=u.bindArray,u.renderBuf&&u.renderBuf.unbind();for(var m=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),y=0;y<m;++y)t.activeTexture(t.TEXTURE0+y),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);this.unbindOutputFramebuffer&&this.unbindOutputFramebuffer(e.pass)}},xeogl.renderer.Renderer.prototype.pick=(e=xeogl.math,t=e.vec3(),i=e.mat4(),r=e.vec3([0,1,0]),s=e.frustumMat4(-1,1,-1,1,.1,1e4),function(n){var a,o,h,l,c,u=null,d=this.pickBuf;d||(d=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl),this.pickBuf=d),this.render(),d.bind(),d.clear();var f=null,_=null;n.canvasPos?n.canvasPos?(a=n.canvasPos[0],o=n.canvasPos[1]):(a=.5*this.canvas.clientWidth,o=.5*this.canvas.clientHeight):(h=n.origin||e.vec3([0,0,0]),l=n.direction||e.vec3([0,0,1]),c=e.addVec3(h,l,t),f=e.lookAtMat4v(h,c,r,i),_=s,a=.5*this.canvas.clientWidth,o=.5*this.canvas.clientHeight),this._renderObjectList({pickObject:!0,clear:!0,pickViewMatrix:f,pickProjMatrix:_});var p=d.read(a,o),g=p[0]+256*p[1]+65536*p[2];g=g>=1?g-1:-1;var m=this._objectPickList[g];if(m&&(u={entity:m.id},n.pickSurface)){d.clear(),this._renderObjectList({pickSurface:!0,object:m,pickViewMatrix:f,pickProjMatrix:_,clear:!0}),this.gl.finish();var y=(p=d.read(a,o))[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;y*=3,u.primIndex=y,f&&(u.origin=h,u.direction=l)}return d.unbind(),u}),xeogl.renderer.Renderer.prototype.readPixels=function(e,t,i,r){var s,n,a,o;for(this._readPixelBuf||(this._readPixelBuf=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear(),this.render({force:!0,opaqueOnly:r}),n=0;n<i;n++)a=2*n,o=4*n,s=this._readPixelBuf.read(e[a],e[a+1]),t[o]=s[0],t[o+1]=s[1],t[o+2]=s[2],t[o+3]=s[3];this._readPixelBuf.unbind()},xeogl.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";xeogl.renderer.webgl.ArrayBuffer=function(e,t,i,r,s,n){this.allocated=!1,this.gl=e,this.type=t,this.itemType=i.constructor==Uint8Array?e.UNSIGNED_BYTE:i.constructor==Uint16Array?e.UNSIGNED_SHORT:i.constructor==Uint32Array?e.UNSIGNED_INT:e.FLOAT,this.usage=n,this.length=0,this.numItems=0,this.itemSize=s,this._allocate(i)},xeogl.renderer.webgl.ArrayBuffer.prototype._allocate=function(e){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,e,this.usage),this.gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.webgl.ArrayBuffer.prototype.setData=function(e,t){this.allocated&&(e.length>this.length?(this.destroy(),this._allocate(e,e.length)):t||0===t?this.gl.bufferSubData(this.type,t,e):this.gl.bufferData(this.type,e))},xeogl.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},xeogl.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},xeogl.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Attribute=function(e,t){this.gl=e,this.location=t},xeogl.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(e){e&&(e.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,e.itemSize,this.gl.FLOAT,!1,0,0))},xeogl.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(e,t,i){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,e,this.gl.FLOAT,!1,t,i)}}(),function(){"use strict";function e(e){for(var t,i,r=[],s=0,n=e.length;s<n;s++)(i=(t=e[s]).indexOf("/"))>0&&"/"===t.charAt(i+1)&&(t=t.substring(0,i)),r.push(t);return r.join("\n")}xeogl.renderer.webgl.Program=function(t,i,r,s){var n,a,o,h,l;if(this.stats=t,this.gl=i,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.webgl.Shader(i,i.VERTEX_SHADER,e(r)),this._fragmentShader=new xeogl.renderer.webgl.Shader(i,i.FRAGMENT_SHADER,e(s)),this._vertexShader.allocated)if(this._fragmentShader.allocated)if(this.allocated=!0,this._vertexShader.compiled)if(this._fragmentShader.compiled)if(this.compiled=!0,this.handle=i.createProgram(),this.handle){if(i.attachShader(this.handle,this._vertexShader.handle),i.attachShader(this.handle,this._fragmentShader.handle),i.linkProgram(this.handle),this.linked=i.getProgramParameter(this.handle,i.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(i.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(r),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(s));var c=i.getProgramParameter(this.handle,i.ACTIVE_UNIFORMS);for(a=0;a<c;++a)(o=i.getActiveUniform(this.handle,a))&&("\0"===(h=o.name)[h.length-1]&&(h=h.substr(0,h.length-1)),l=i.getUniformLocation(this.handle,h),o.type===i.SAMPLER_2D||o.type===i.SAMPLER_CUBE||35682===o.type?this.samplers[h]=new xeogl.renderer.webgl.Sampler(i,l):this.uniforms[h]=new xeogl.renderer.webgl.Uniform(t.frame,i,o.type,l));var u=i.getProgramParameter(this.handle,i.ACTIVE_ATTRIBUTES);for(a=0;a<u;a++)(n=i.getActiveAttrib(this.handle,a))&&(l=i.getAttribLocation(this.handle,n.name),this.attributes[n.name]=new xeogl.renderer.webgl.Attribute(i,l));this.allocated=!0}else this.errorLog=["Failed to allocate program"];else this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog);else this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog);else this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog);else this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog)},xeogl.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.webgl.Program.prototype.setUniform=function(e,t){if(this.allocated){var i=this.uniforms[e];i&&i.setValue(t)}},xeogl.renderer.webgl.Program.prototype.getUniform=function(e){if(this.allocated)return this.uniforms[e]},xeogl.renderer.webgl.Program.prototype.getAttribute=function(e){if(this.allocated)return this.attributes[e]},xeogl.renderer.webgl.Program.prototype.bindTexture=function(e,t,i){if(!this.allocated)return!1;var r=this.samplers[e];return!!r&&r.bindTexture(t,i)},xeogl.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.RenderBuffer=function(e,t,i){i=i||{},this.allocated=!1,this.canvas=e,this.gl=t,this.buffer=null,this.bound=!1,this.size=i.size},xeogl.renderer.webgl.RenderBuffer.prototype.setSize=function(e){this.size=e},xeogl.renderer.webgl.RenderBuffer.prototype.webglRestored=function(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},xeogl.renderer.webgl.RenderBuffer.prototype._touch=function(){var e,t;if(this.size?(e=this.size[0],t=this.size[1]):(e=this.canvas.clientWidth,t=this.canvas.clientHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:e,height:t},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(r){var i=new WebGLUnsignedByteArray(e*t*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,t),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var r=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(r){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+r}this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},xeogl.renderer.webgl.RenderBuffer.prototype.read=function(e,t){var i=e,r=this.canvas.height-t,s=new Uint8Array(4);return this.gl.readPixels(i,r,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s),s},xeogl.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var e=this;return{renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}}},xeogl.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Sampler=function(e,t){this.bindTexture=function(i,r){return!!i.bind(r)&&(e.uniform1i(t,r),!0)}}}(),function(){"use strict";xeogl.renderer.webgl.Shader=function(e,t,i){this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=i,this.handle=e.createShader(t),this.handle?(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),this.compiled||e.isContextLost()||(this.errorLog=[],this.errorLog.push(""),this.errorLog.push(e.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(this.source))):this.errorLog=["Failed to allocate"]}}(),function(){"use strict";xeogl.renderer.webgl.Texture2D=function(e){this.gl=e,this.target=e.TEXTURE_2D,this.texture=e.createTexture(),this.allocated=!0},xeogl.renderer.webgl.Texture2D.prototype.setImage=function(e,t){var i=this.gl;i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype.setProps=function(e){var t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){var i=this._getGLEnum(e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){var r=this._getGLEnum(e.magFilter);r&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,r)}if(e.wrapS){var s=this._getGLEnum(e.wrapS);s&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,s)}if(e.wrapT){var n=this._getGLEnum(e.wrapT);n&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,n)}t.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype._getGLEnum=function(e,t){if(void 0===e)return t;var i=xeogl.renderer.webgl.enums[e];return void 0===i?t:this.gl[i]},xeogl.renderer.webgl.Texture2D.prototype.bind=function(e){if(this.allocated){if(this.texture){var t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.webgl.Texture2D.prototype.unbind=function(e){if(this.allocated&&this.texture){var t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}},xeogl.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.webgl.clampImageSize=function(e,t){var i=e.width*e.height;if(i>t){var r=t/i,s=e.width*r,n=e.height*r,a=document.createElement("canvas");a.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(s),a.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(n),a.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),e=a}return e},xeogl.renderer.webgl.ensureImageSizePowerOfTwo=function(e){if(!xeogl.renderer.webgl.isPowerOfTwo(e.width)||!xeogl.renderer.webgl.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(e.width),t.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},xeogl.renderer.webgl.isPowerOfTwo=function(e){return 0==(e&e-1)},xeogl.renderer.webgl.nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}}(),function(){"use strict";xeogl.renderer.webgl.Uniform=function(e,t,i,r){var s=null,n=null;if(i===t.BOOL)s=function(e){n!==e&&(n=e,t.uniform1i(r,e))};else if(i===t.BOOL_VEC2)n=new Array(2),s=function(e){n[0]===e[0]&&n[1]===e[1]||(n[0]=e[0],n[1]=e[1],t.uniform2iv(r,e))};else if(i===t.BOOL_VEC3)n=new Array(3),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]||(n[0]=e[0],n[1]=e[1],n[2]=e[2],t.uniform3iv(r,e))};else if(i===t.BOOL_VEC4)n=new Array(4),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]||(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],t.uniform4iv(r,e))};else if(i===t.INT)s=function(e){n!==e&&(n=e,t.uniform1iv(r,e))};else if(i===t.INT_VEC2)n=new Uint32Array(2),s=function(e){n[0]===e[0]&&n[1]===e[1]||(n.set(e),t.uniform2iv(r,e))};else if(i===t.INT_VEC3)n=new Uint32Array(3),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]||(n.set(e),t.uniform3iv(r,e))};else if(i===t.INT_VEC4)n=new Uint32Array(4),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]||(n.set(e),t.uniform4iv(r,e))};else if(i===t.FLOAT)s=function(e){n!==e&&(n=e,t.uniform1f(r,e))};else if(i===t.FLOAT_VEC2)n=new Float32Array(2),s=function(e){n[0]===e[0]&&n[1]===e[1]||(n.set(e),t.uniform2fv(r,e))};else if(i===t.FLOAT_VEC3)n=new Float32Array(3),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]||(n.set(e),t.uniform3fv(r,e))};else if(i===t.FLOAT_VEC4)n=new Float32Array(4),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]||(n.set(e),t.uniform4fv(r,e))};else if(i===t.FLOAT_MAT2)n=new Float32Array(4),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]||(n.set(e),t.uniformMatrix2fv(r,t.FALSE,e))};else if(i===t.FLOAT_MAT3)n=new Float32Array(9),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]||(n.set(e),t.uniformMatrix3fv(r,t.FALSE,e))};else{if(i!==t.FLOAT_MAT4)throw"Unsupported shader uniform type: "+i;n=new Float32Array(16),s=function(e){n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]||(n.set(e),t.uniformMatrix4fv(r,t.FALSE,e))}}this.setValue=s,this.getLocation=function(){return r}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.State=Class.extend({__init:function(e){for(var t in this.id=this._ids.addItem({}),this.hash=e.hash||""+this.id,e)e.hasOwnProperty(t)&&(this[t]=e[t])},destroy:function(){this._ids.removeItem(this.id)}}),xeogl.renderer.Visibility=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Cull=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Modes=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Layer=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stage=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.DepthBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ColorBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Lights=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.PhongMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Reflect=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Transform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Billboard=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stationary=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget.DEPTH=0,xeogl.renderer.RenderTarget.COLOR=1,xeogl.renderer.Clips=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MorphTargets=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Shader=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ShaderParams=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Fresnel=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Geometry=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ProgramState=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Viewport=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})})}(),function(){"use strict";xeogl.renderer.Object=function(e){this.id=e,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null,this.compiled=!1}}(),function(){"use strict";xeogl.renderer.ObjectFactory=function(){var e=[],t=0;this.get=function(i){var r;return t>0?((r=e[--t]).id=i,r.compiled=!1,r):new xeogl.renderer.Object(i)},this.put=function(i){e[t++]=i}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Program=function(e,t,i,r){this.stats=e,this.hash=i.hash,this.source=i,this.gl=r,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(r)},xeogl.renderer.Program.prototype.build=function(e){this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new xeogl.renderer.webgl.Program(this.stats,e,this.source.vertexDraw,this.source.fragmentDraw),this.pickObject=new xeogl.renderer.webgl.Program(this.stats,e,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new xeogl.renderer.webgl.Program(this.stats,e,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.draw.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?(this.allocated=!0,this.draw.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?(this.compiled=!0,this.draw.linked?this.pickObject.linked?this.pickPrimitive.linked?(this.linked=!0,this.draw.validated?this.pickObject.validated?this.pickPrimitive.validated?this.validated=!0:this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog)}}(),function(){"use strict";xeogl.renderer.ProgramFactory=function(e,t){this.stats=e,this._gl=t,this._programStates={}},xeogl.renderer.ProgramFactory.prototype.get=function(e,t){var i=this._programStates[e];if(!i){var r=xeogl.renderer.ProgramSourceFactory.getSource(e,t),s=new xeogl.renderer.Program(this.stats,e,r,this._gl);i=new xeogl.renderer.ProgramState({program:s,useCount:0}),this._programStates[e]=i,this.stats.memory.programs++}return i.useCount++,i},xeogl.renderer.ProgramFactory.prototype.put=function(e){if(--e.useCount<=0){var t=e.program;t.draw.destroy(),t.pickObject.destroy(),t.pickPrimitive.destroy(),xeogl.renderer.ProgramSourceFactory.putSource(t.hash),delete this._programStates[t.hash],this.stats.memory.programs--}},xeogl.renderer.ProgramFactory.prototype.webglRestored=function(e){for(var t in this._gl=e,this._programStates)this._programStates.hasOwnProperty(t)&&this._programStates[t].build(e)},xeogl.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";xeogl.renderer.ProgramSource=function(e,t,i,r,s,n,a){this.hash=e,this.vertexPickObject=t,this.fragmentPickObject=i,this.vertexPickPrimitive=r,this.fragmentPickPrimitive=s,this.vertexDraw=n,this.fragmentDraw=a,this.useCount=0}}(),function(){"use strict";xeogl.renderer.ProgramSourceFactory=new function(){var e,t,i,r,s,n,a,o,h,l,c,u,d,f={},_="";function p(){_=[]}function g(e){_.push(e||"")}function m(e){if(e){for(var t=0,i=0,r=e.length;i<r;i++)" "===e.charAt(i)&&t++;var s=t>0?e.substring(0,t-1):"";_.push(s+"// "+e.substring(t-1))}}function y(){return _}function v(e){return e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?"highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}this.getSource=function(_,x){var b,w=f[_];return w?(w.useCount++,w):(e=x,t=function(){if(!e.geometry.uv)return!1;var t=e.material;return t.ambientMap||t.diffuseMap||t.specularMap||t.emissiveMap||t.opacityMap||t.reflectivityMap||e.material.normalMap}(),i=function(){var t=e.geometry.primitiveName;if(e.geometry.normals&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(),b=e.geometry,r=b.positions&&b.indices&&b.normals&&b.uv&&e.material.normalMap,!1,s=e.material.diffuseFresnel,n=e.material.specularFresnel,a=e.material.opacityFresnel,o=e.material.reflectivityFresnel,h=e.material.emissiveFresnel,w=new xeogl.renderer.ProgramSource(_,function(){if(l)return l;return p(),g("// Object picking vertex shader"),g("attribute vec3 xeo_aPosition;"),g("uniform mat4 xeo_uModelMatrix;"),g("uniform mat4 xeo_uViewMatrix;"),g("uniform mat4 xeo_uViewNormalMatrix;"),g("uniform mat4 xeo_uProjMatrix;"),g("varying vec4 xeo_vWorldPosition;"),g("varying vec4 xeo_vViewPosition;"),g("void main(void) {"),g("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),g("   xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),g("   xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),g("   gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),g("}"),l=y()}(),function(){if(c)return c;return p(),g("// Object picking fragment shader"),g("precision "+v(e.gl)+" float;"),g("uniform vec4 xeo_uPickColor;"),g("void main(void) {"),g("   gl_FragColor = xeo_uPickColor; "),g("}"),c=y()}(),function(){if(u)return u;return p(),g("// Triangle picking vertex shader"),g("attribute vec3 xeo_aPosition;"),g("attribute vec4 xeo_aColor;"),g("uniform vec3 xeo_uPickColor;"),g("uniform mat4 xeo_uModelMatrix;"),g("uniform mat4 xeo_uViewMatrix;"),g("uniform mat4 xeo_uProjMatrix;"),g("varying vec4 xeo_vWorldPosition;"),g("varying vec4 xeo_vViewPosition;"),g("varying vec4 xeo_vColor;"),g("void main(void) {"),g("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),g("   vec4 worldPosition = xeo_uModelMatrix * tmpVertex; "),g("   vec4 viewPosition = xeo_uViewMatrix * worldPosition;"),g("   xeo_vColor = xeo_aColor;"),g("   gl_Position = xeo_uProjMatrix * viewPosition;"),g("}"),u=y()}(),function(){if(d)return d;return p(),g("// Triangle picking fragment shader"),g("precision "+v(e.gl)+" float;"),g("varying vec4 xeo_vColor;"),g("void main(void) {"),g("   gl_FragColor = xeo_vColor;"),g("}"),d=y()}(),function(){var s,n,a,o=e.shader.vertex;if(o)return o;if(p(),g("// Drawing vertex shader"),g("uniform mat4 xeo_uModelMatrix;          // Modeling matrix"),g("uniform mat4 xeo_uViewMatrix;           // Viewing matrix"),g("uniform mat4 xeo_uProjMatrix;           // Projection matrix"),g("attribute vec3 xeo_aPosition;           // Local-space vertex position"),g(),g("varying vec4 xeo_vViewPosition;         // Output: View-space fragment position"),i)for(g(),g("attribute vec3 xeo_aNormal;             // Local-space vertex normal"),g("uniform mat4 xeo_uModelNormalMatrix;    // Modeling normal matrix"),g("uniform mat4 xeo_uViewNormalMatrix;     // Viewing normal matrix"),g("varying vec3 xeo_vViewEyeVec;           // Output: View-space vector from fragment position to eye"),g("varying vec3 xeo_vViewNormal;           // Output: View-space normal"),s=0,n=e.lights.lights.length;s<n;s++)"ambient"!==(a=e.lights.lights[s]).type&&("dir"===a.type&&g("uniform vec3 xeo_uLightDir"+s+";   // Directional light direction"),"point"===a.type&&g("uniform vec3 xeo_uLightPos"+s+";   // Positional light position"),"spot"===a.type&&g("uniform vec3 xeo_uLightPos"+s+";   // Spot light position"),g("varying vec4 xeo_vViewLightVecAndDist"+s+"; // Output: Vector from vertex to light, packaged with the pre-computed length of that vector"));r&&g("attribute vec3 xeo_aTangent;");t&&(g(),g("attribute vec2 xeo_aUV;"),g("varying vec2 xeo_vUV;"));e.geometry.colors&&(g("attribute vec4 xeo_aColor;"),g("varying vec4 xeo_vColor;"));"points"===e.geometry.primitiveName&&g("uniform float xeo_uPointSize;");e.billboard.active&&(g("void billboard(inout mat4 mat) {"),g("   mat[0][0] = 1.0;"),g("   mat[0][1] = 0.0;"),g("   mat[0][2] = 0.0;"),e.billboard.spherical&&(g("   mat[1][0] = 0.0;"),g("   mat[1][1] = 1.0;"),g("   mat[1][2] = 0.0;")),g("   mat[2][0] = 0.0;"),g("   mat[2][1] = 0.0;"),g("   mat[2][2] =1.0;"),g("}"));g(),g("void main(void) {"),g(),g("   vec4 localPosition = vec4(xeo_aPosition, 1.0); "),i&&(g("   vec4 localNormal = vec4(xeo_aNormal, 0.0); "),g("   mat4 modelNormalMatrix = xeo_uModelNormalMatrix;"),g("   mat4 viewNormalMatrix = xeo_uViewNormalMatrix;"));g("   mat4 modelMatrix = xeo_uModelMatrix;"),g("   mat4 viewMatrix = xeo_uViewMatrix;"),g("   vec4 worldPosition;"),e.stationary.active&&g("   viewMatrix[3][0] = viewMatrix[3][1] = viewMatrix[3][2] = 0.0;");e.billboard.active?(g("   mat4 modelViewMatrix =  xeo_uViewMatrix * xeo_uModelMatrix;"),g("   billboard(modelMatrix);"),g("   billboard(viewMatrix);"),g("   billboard(modelViewMatrix);"),i&&(g("   mat4 modelViewNormalMatrix =  xeo_uViewNormalMatrix * xeo_uModelNormalMatrix;"),g("   billboard(modelNormalMatrix);"),g("   billboard(viewNormalMatrix);"),g("   billboard(modelViewNormalMatrix);")),g("   worldPosition = modelMatrix * localPosition;"),g("   vec4 viewPosition = modelViewMatrix * localPosition;")):(g("   worldPosition = modelMatrix * localPosition;"),g("   vec4 viewPosition  = viewMatrix * worldPosition; "));if(i){for(g("   vec3 worldNormal = (modelNormalMatrix * localNormal).xyz; "),g("   xeo_vViewNormal = normalize((viewNormalMatrix * vec4(worldNormal, 1.0)).xyz);"),r&&(g("   vec3 tangent = normalize((xeo_uViewNormalMatrix * xeo_uModelNormalMatrix * vec4(xeo_aTangent, 1.0)).xyz);"),g("   vec3 bitangent = cross(xeo_vViewNormal, tangent);"),g("   mat3 TBN = mat3(tangent, bitangent, xeo_vViewNormal);")),g("   vec3 tmpVec3;"),g("   float lightDist;"),s=0,n=e.lights.lights.length;s<n;s++)"ambient"!==(a=e.lights.lights[s]).type&&("dir"===a.type&&("world"===a.space?(g("   tmpVec3 = xeo_uLightDir"+s+";"),g("   tmpVec3 = vec3(viewMatrix * vec4(tmpVec3, 1.0)).xyz;"),r&&g("   tmpVec3 *= TBN;")):(g("   tmpVec3 = xeo_uLightDir"+s+";"),r&&g("   tmpVec3 *= TBN;")),g("   xeo_vViewLightVecAndDist"+s+" = vec4(tmpVec3, 0.0);")),"point"===a.type&&("world"===a.space?(g("   tmpVec3 = (viewMatrix * vec4(xeo_uLightPos"+s+", 1.0)).xyz - viewPosition.xyz;"),g("   lightDist = abs(length(tmpVec3));"),r&&g("   tmpVec3 *= TBN;")):(g("   tmpVec3 = xeo_uLightPos"+s+".xyz - viewPosition.xyz;"),g("   lightDist = abs(length(tmpVec3));"),r&&g("   tmpVec3 *= TBN;")),g("   xeo_vViewLightVecAndDist"+s+" = vec4(tmpVec3, lightDist);")));g("   xeo_vViewEyeVec = -viewPosition.xyz;"),r&&g("   xeo_vViewEyeVec *= TBN;")}t&&g("   xeo_vUV = xeo_aUV;");e.geometry.colors&&g("   xeo_vColor = xeo_aColor;");"points"===e.geometry.primitiveName&&g("   gl_PointSize = xeo_uPointSize;");return g("   xeo_vViewPosition = viewPosition;"),g("   gl_Position = xeo_uProjMatrix * viewPosition;"),g("}"),y()}(),function(){var l,c,u,d=e.shader.fragment;if(d)return d;p(),g("// Drawing fragment shader"),g("precision "+v(e.gl)+" float;"),g(),i&&(g("varying vec4 xeo_vViewPosition;"),g(),g("uniform vec3 xeo_uSpecular;"),g("uniform float xeo_uShininess;"),g("uniform float xeo_uReflectivity;"));g("uniform vec3 xeo_uEmissive;"),g("uniform float xeo_uOpacity;"),g("uniform vec3 xeo_uDiffuse;"),g(),e.geometry.colors&&g("varying vec4 xeo_vColor;");t&&(g(),m("Texture variables"),g(),e.geometry.uv&&g("varying vec2 xeo_vUV;"),e.material.emissiveMap&&(g("uniform sampler2D xeo_uEmissiveMap;"),e.material.emissiveMap.matrix&&g("uniform mat4 xeo_uEmissiveMapMatrix;")),e.material.opacityMap&&(g("uniform sampler2D xeo_uOpacityMap;"),e.material.opacityMap.matrix&&g("uniform mat4 xeo_uOpacityMapMatrix;")),e.material.ambientMap&&(g("uniform sampler2D xeo_uAmbientMap;"),e.material.ambientMap.matrix&&g("uniform mat4 xeo_uAmbientMapMatrix;")),e.material.diffuseMap&&(g("uniform sampler2D xeo_uDiffuseMap;"),e.material.diffuseMap.matrix&&g("uniform mat4 xeo_uDiffuseMapMatrix;")),i&&(e.material.specularMap&&(g("uniform sampler2D xeo_uSpecularMap;"),e.material.specularMap.matrix&&g("uniform mat4 xeo_uSpecularMapMatrix;")),e.material.reflectivityMap&&(g("uniform sampler2D xeo_uTextureReflectivity;"),e.material.reflectivityMap.matrix&&g("uniform mat4 xeo_uTextureReflectivityMatrix;")),r&&(g("uniform sampler2D xeo_uNormalMap;"),e.material.normalMap.matrix&&g("uniform mat4 xeo_uNormalMapMatrix;"))));if(g("uniform vec3 xeo_uLightAmbientColor;"),g("uniform float xeo_uLightAmbientIntensity;"),i){for(g("varying vec3 xeo_vViewEyeVec;"),g("varying vec3 xeo_vViewNormal;"),l=0,c=e.lights.lights.length;l<c;l++)"ambient"!==(u=e.lights.lights[l]).type&&(g("uniform vec3 xeo_uLightColor"+l+";"),g("uniform float xeo_uLightIntensity"+l+";"),"point"===u.type&&g("uniform vec3 xeo_uLightAttenuation"+l+";"),g("varying vec4 xeo_vViewLightVecAndDist"+l+";"));(s||n||a||h||o)&&(g(),m("Fresnel variables"),g(),s&&(g("uniform float xeo_uDiffuseFresnelCenterBias;"),g("uniform float xeo_uDiffuseFresnelEdgeBias;"),g("uniform float xeo_uDiffuseFresnelPower;"),g("uniform vec3 xeo_uDiffuseFresnelCenterColor;"),g("uniform vec3 xeo_uDiffuseFresnelEdgeColor;"),g()),n&&(g("uniform float xeo_uSpecularFresnelCenterBias;"),g("uniform float xeo_uSpecularFresnelEdgeBias;"),g("uniform float xeo_uSpecularFresnelPower;"),g("uniform vec3 xeo_uSpecularFresnelCenterColor;"),g("uniform vec3 xeo_uSpecularFresnelEdgeColor;"),g()),a&&(g("uniform float xeo_uOpacityFresnelCenterBias;"),g("uniform float xeo_uOpacityFresnelEdgeBias;"),g("uniform float xeo_uOpacityFresnelPower;"),g("uniform vec3 xeo_uOpacityFresnelCenterColor;"),g("uniform vec3 xeo_uOpacityFresnelEdgeColor;"),g()),o&&(g("uniform float xeo_uReflectivityFresnelCenterBias;"),g("uniform float xeo_uReflectivityFresnelEdgeBias;"),g("uniform float xeo_uReflectivityFresnelPower;"),g("uniform vec3 xeo_uReflectivityFresnelCenterColor;"),g("uniform vec3 xeo_uReflectivityFresnelEdgeColor;"),g()),h&&(g("uniform float xeo_uEmissiveFresnelCenterBias;"),g("uniform float xeo_uEmissiveFresnelEdgeBias;"),g("uniform float xeo_uEmissiveFresnelPower;"),g("uniform vec3 xeo_uEmissiveFresnelCenterColor;"),g("uniform vec3 xeo_uEmissiveFresnelEdgeColor;"),g()),m("Fresnel calculation"),g(),g("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),g("    float fr = abs(dot(eyeDir, normal));"),g("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),g("    return pow(finalFr, power);"),g("}"))}g(),g("void main(void) {"),g(),g("   vec3 ambient = xeo_uLightAmbientColor;"),g("   vec3 emissive = xeo_uEmissive;"),g("   float opacity = xeo_uOpacity;"),e.geometry.colors?g("   vec3 diffuse = xeo_vColor.rgb;"):g("   vec3 diffuse = xeo_uDiffuse;");i&&(g("vec3 viewEyeVec = normalize(xeo_vViewEyeVec);"),g("   vec3 specular = xeo_uSpecular;"),g("   float shininess = xeo_uShininess;"),g("   float reflectivity = xeo_uReflectivity;"),g(r?"   vec3 viewNormal = vec3(0.0, 1.0, 0.0);":"   vec3 viewNormal = normalize(xeo_vViewNormal);"));if(t){g(),m("   Apply textures"),g(),g("   vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),g("   vec2 textureCoord;");var f=e.material;f.emissiveMap&&(g(),f.emissiveMap.matrix?g("   textureCoord = (xeo_uEmissiveMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   emissive = texture2D(xeo_uEmissiveMap, textureCoord).rgb;")),f.opacityMap&&(g(),f.opacityMap.matrix?g("   textureCoord = (xeo_uOpacityMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   opacity = texture2D(xeo_uOpacityMap, textureCoord).b;")),f.ambientMap&&(g(),f.ambientMap.matrix?g("   textureCoord = (xeo_uAmbientMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   ambient = texture2D(xeo_uAmbientMap, textureCoord).rgb;")),f.diffuseMap&&(g(),f.diffuseMap.matrix?g("   textureCoord = (xeo_uDiffuseMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   diffuse = texture2D(xeo_uDiffuseMap, textureCoord).rgb;")),i&&(f.specularMap&&(g(),f.specularMap.matrix?g("   textureCoord = (xeo_uSpecularMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   specular = texture2D(xeo_uSpecularMap, textureCoord).rgb;")),f.reflectivityMap&&(g(),f.reflectivityMap.matrix?g("   textureCoord = (xeo_uReflectivityMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   reflectivity = texture2D(xeo_uReflectivityMap, textureCoord).b;"))),r&&(g(),f.normalMap.matrix?g("   textureCoord = (xeo_uNormalMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   viewNormal = normalize(texture2D(xeo_uNormalMap, vec2(textureCoord.x, textureCoord.y)).xyz * 2.0 - 1.0);"))}if(g("   vec4 fragColor;"),i){for(g(),g("   vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),g("   vec3  specularLight = vec3(0.0, 0.0, 0.0);"),g(),g("   vec3  viewLightVec;"),g("   float specAngle;"),g("   float lightDist;"),g("   float attenuation;"),l=0,c=e.lights.lights.length;l<c;l++)"ambient"!==(u=e.lights.lights[l]).type&&(g("   viewLightVec = normalize(xeo_vViewLightVecAndDist"+l+".xyz);"),"point"===u.type&&(g(),g("   specAngle = max(dot(viewNormal, viewLightVec), 0.0);"),g("   lightDist = xeo_vViewLightVecAndDist"+l+".w;"),g("   attenuation = 1.0 - (  xeo_uLightAttenuation"+l+"[0] +   xeo_uLightAttenuation"+l+"[1] * lightDist +   xeo_uLightAttenuation"+l+"[2] * lightDist * lightDist);"),g("   diffuseLight += xeo_uLightIntensity"+l+" * specAngle * xeo_uLightColor"+l+" * attenuation;"),g("   specularLight += xeo_uLightIntensity"+l+" *  pow(max(dot(reflect(-viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess) * attenuation;")),"dir"===u.type&&(g("   specAngle = max(dot(viewNormal, -viewLightVec), 0.0);"),g("   diffuseLight += xeo_uLightIntensity"+l+" * specAngle * xeo_uLightColor"+l+";"),g("   specularLight += xeo_uLightIntensity"+l+" * pow(max(dot(reflect(viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess);")));g(),(s||n||a||h||o)&&(g(),m("   Apply Fresnels"),s&&(g(),g("float diffuseFresnel = fresnel(viewEyeVec, viewNormal, xeo_uDiffuseFresnelEdgeBias, xeo_uDiffuseFresnelCenterBias, xeo_uDiffuseFresnelPower);"),g("diffuse *= mix(xeo_uDiffuseFresnelEdgeColor, xeo_uDiffuseFresnelCenterColor, diffuseFresnel);")),n&&(g(),g("float specularFresnel = fresnel(viewEyeVec, viewNormal, xeo_uSpecularFresnelEdgeBias, xeo_uSpecularFresnelCenterBias, xeo_uSpecularFresnelPower);"),g("specular *= mix(xeo_uSpecularFresnelEdgeColor, xeo_uSpecularFresnelCenterColor, specularFresnel);")),a&&(g(),g("float opacityFresnel = fresnel(viewEyeVec, viewNormal, xeo_uOpacityFresnelEdgeBias, xeo_uOpacityFresnelCenterBias, xeo_uOpacityFresnelPower);"),g("opacity *= mix(xeo_uOpacityFresnelEdgeColor.r, xeo_uOpacityFresnelCenterColor.r, opacityFresnel);")),h&&(g(),g("float emissiveFresnel = fresnel(viewEyeVec, viewNormal, xeo_uEmissiveFresnelEdgeBias, xeo_uEmissiveFresnelCenterBias, xeo_uEmissiveFresnelPower);"),g("emissive *= mix(xeo_uEmissiveFresnelEdgeColor, xeo_uEmissiveFresnelCenterColor, emissiveFresnel);"))),g(),m("   Phong BRDF"),g(),g("   fragColor = vec4((specular * specularLight) + ((diffuseLight + (ambient * xeo_uLightAmbientIntensity) ) * diffuse) + emissive, opacity);")}else g(),m("   Non-Lambertian BRDF"),g(),g("   fragColor = vec4(emissive + diffuse, opacity);");return g("   fragColor.rgb *= fragColor.a;"),g("   gl_FragColor = fragColor;"),g("}"),y()}()),f[_]=w,w)},this.putSource=function(e){var t=f[e];t&&0==--t.useCount&&(f[t.hash]=null)}}}(),function(){"use strict";xeogl.renderer.Chunk=function(){},xeogl.renderer.Chunk.prototype.init=function(e,t,i){this.id=e,this.program=t,this.state=i,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory=function(){this.types=xeogl.renderer.ChunkFactory.types},xeogl.renderer.ChunkFactory.types={},xeogl.renderer.ChunkFactory.createChunkType=function(e){if(!e.type)throw"'type' expected in params";var t=xeogl.renderer.Chunk,i=function(){this.useCount=0,this.init.apply(this,arguments)};return(i.prototype=new t).constructor=i,xeogl._apply(e,i.prototype),xeogl.renderer.ChunkFactory.types[e.type]={constructor:i,chunks:{},freeChunks:[],freeChunksLen:0},i},xeogl.renderer.ChunkFactory.prototype.getChunk=function(e,t,i,r){var s=this.types[t];if(!s)throw"chunk type not supported: '"+t+"'";var n=s.chunks[e];return n?(n.useCount++,n):(s.freeChunksLen>0&&(n=s.freeChunks[--s.freeChunksLen]),n?n.init(e,i,r):n=new s.constructor(e,i,r),n.useCount=1,s.chunks[e]=n,n)},xeogl.renderer.ChunkFactory.prototype.putChunk=function(e){if(0!==e.useCount&&--e.useCount<=0){var t=this.types[e.type];delete t.chunks[e.id],t.freeChunks[t.freeChunksLen++]=e}},xeogl.renderer.ChunkFactory.prototype.webglRestored=function(e){var t,i,r=this.types;for(var s in r)if(r.hasOwnProperty(s))for(var n in t=r[s].chunks)t.hasOwnProperty(n)&&(i=t[n]).build&&i.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){var e,t;this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];var i=this.program.draw;for(e=0,t=this.state.clips.length;e<t;e++)this._uClipModeDraw[e]=i.getUniform("xeo_uClipMode"+e),this._uClipPlaneDraw[e]=i.getUniform("xeo_uClipPlane"+e);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];var r=this.program.pick;for(e=0,t=this.state.clips.length;e<t;e++)this._uClipModePick[e]=r.getUniform("xeo_uClipMode"+e),this._uClipPlanePick[e]=r.getUniform("xeo_uClipPlane"+e)},drawPick:function(e){}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,draw:function(e){if(!e.transparent){var t=this.state,i=t.blendEnabled,r=this.program.gl;e.blendEnabled!==i&&(i?r.enable(r.BLEND):r.disable(r.BLEND),e.blendEnabled=i);var s=t.colorMask;r.colorMask(s[0],s[1],s[2],s[3])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(e){}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,draw:function(e){var t=this.program.gl,i=this.state,r=i.active;e.depthbufEnabled!==r&&(r?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),e.depthbufEnabled=r);var s=i.clearDepth;e.clearDepth!==s&&(t.clearDepth(s),e.clearDepth=s);var n=i.depthFunc;e.depthFunc!==n&&(t.depthFunc(n),e.depthFunc=n),i.clear&&t.clear(t.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("xeo_uPickColor")},draw:function(e){var t=this.state,i=this.program.gl;t.indices&&(i.drawElements(t.primitive,t.indices.numItems,t.indices.itemType,0),e.drawElements++)},pickObject:function(e){var t=this.state,i=this.program.gl;if(this._uPickColorObject){e.pickIndex++;var r=e.pickIndex>>16&255,s=e.pickIndex>>8&255,n=255&e.pickIndex;this._uPickColorObject.setValue([n/255,s/255,r/255,1])}t.indices&&(i.drawElements(t.primitive,t.indices.numItems,t.indices.itemType,0),e.drawElements++)},pickPrimitive:function(){var e=this.state,t=this.program.gl,i=e.getPickPositions();i&&t.drawArrays(e.primitive,0,i.numItems/3)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var e=this.program.draw;this._aPositionDraw=e.getAttribute("xeo_aPosition"),this._aNormalDraw=e.getAttribute("xeo_aNormal"),this._aUVDraw=e.getAttribute("xeo_aUV"),this._aTangentDraw=e.getAttribute("xeo_aTangent"),this._aColorDraw=e.getAttribute("xeo_aColor");var t=this.program.pickObject;this._aPositionPickObject=t.getAttribute("xeo_aPosition");var i=this.program.pickPrimitive;this._aPositionPickPrimitive=i.getAttribute("xeo_aPosition"),this._aColorPickPrimitive=i.getAttribute("xeo_aColor")},draw:function(e){var t=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(t.positions),e.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(t.normals),e.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(t.uv),e.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(t.colors),e.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(t.getTangents()),e.bindArray++),t.indices&&(t.indices.bind(),e.bindArray++)},pickObject:function(){var e=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(e.positions),e.indices&&e.indices.bind()},pickPrimitive:function(){var e=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(e.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(e.getPickColors())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var e=this.state.lights,t=this.program,i=0,r=e.length;i<r;i++)switch(e[i].type){case"ambient":this._uLightAmbientColor[i]=t.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[i]=t.draw.getUniform("xeo_uLightAmbientIntensity");break;case"dir":this._uLightColor[i]=t.draw.getUniform("xeo_uLightColor"+i),this._uLightIntensity[i]=t.draw.getUniform("xeo_uLightIntensity"+i),this._uLightPos[i]=null,this._uLightDir[i]=t.draw.getUniform("xeo_uLightDir"+i);break;case"point":this._uLightColor[i]=t.draw.getUniform("xeo_uLightColor"+i),this._uLightIntensity[i]=t.draw.getUniform("xeo_uLightIntensity"+i),this._uLightPos[i]=t.draw.getUniform("xeo_uLightPos"+i),this._uLightDir[i]=null,this._uLightAttenuation[i]=t.draw.getUniform("xeo_uLightAttenuation"+i)}},draw:function(){for(var e,t=this.state.lights,i=0,r=t.length;i<r;i++)e=t[i],this._uLightAmbientColor[i]?(this._uLightAmbientColor[i].setValue(e.color),this._uLightAmbientIntensity[i]&&this._uLightAmbientIntensity[i].setValue(e.intensity)):(this._uLightColor[i]&&this._uLightColor[i].setValue(e.color),this._uLightIntensity[i]&&this._uLightIntensity[i].setValue(e.intensity),this._uLightPos[i]&&(this._uLightPos[i].setValue(e.pos),this._uLightAttenuation[i]&&this._uLightAttenuation[i].setValue(e.attenuation)),this._uLightDir[i]&&this._uLightDir[i].setValue(e.dir))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("xeo_uModelNormalMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("xeo_uModelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uModelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.getMatrix()),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.getMatrix())},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){},draw:function(e){var t=this.state,i=this.program.gl,r=t.backfaces;e.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=r);var s=t.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s);var n=t.transparent;e.transparent!==n&&(e.pick||(n?(i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),e.blendEnabled=!0):(i.disable(i.BLEND),e.blendEnabled=!1)),e.transparent=n)},pickObject:function(e){var t=this.state,i=this.program.gl,r=t.backfaces;e.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=r);var s=t.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s)},pickPrimitive:function(e){var t=this.state,i=this.program.gl,r=t.backfaces;e.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=r);var s=t.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var e=this.state,t=this.program.draw;this._uDiffuse=t.getUniform("xeo_uDiffuse"),this._uSpecular=t.getUniform("xeo_uSpecular"),this._uEmissive=t.getUniform("xeo_uEmissive"),this._uOpacity=t.getUniform("xeo_uOpacity"),this._uShininess=t.getUniform("xeo_uShininess"),this._uPointSize=t.getUniform("xeo_uPointSize"),e.ambientMap&&(this._uAmbientMap="xeo_uAmbientMap",this._uAmbientMapMatrix=t.getUniform("xeo_uAmbientMapMatrix")),e.diffuseMap&&(this._uDiffuseMap="xeo_uDiffuseMap",this._uDiffuseMapMatrix=t.getUniform("xeo_uDiffuseMapMatrix")),e.specularMap&&(this._uSpecularMap="xeo_uSpecularMap",this._uSpecularMapMatrix=t.getUniform("xeo_uSpecularMapMatrix")),e.emissiveMap&&(this._uEmissiveMap="xeo_uEmissiveMap",this._uEmissiveMapMatrix=t.getUniform("xeo_uEmissiveMapMatrix")),e.opacityMap&&(this._uOpacityMap="xeo_uOpacityMap",this._uOpacityMapMatrix=t.getUniform("xeo_uOpacityMapMatrix")),e.reflectivityMap&&(this._uReflectivityMap="xeo_uReflectivityMap",this._uReflectivityMapMatrix=t.getUniform("xeo_uReflectivityMapMatrix")),e.normalMap&&(this._uNormalMap="xeo_uNormalMap",this._uNormalMapMatrix=t.getUniform("xeo_uNormalMapMatrix")),e.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=t.getUniform("xeo_uDiffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=t.getUniform("xeo_uDiffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=t.getUniform("xeo_uDiffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=t.getUniform("xeo_uDiffuseFresnelCenterColor"),this._uDiffuseFresnelPower=t.getUniform("xeo_uDiffuseFresnelPower")),e.specularFresnel&&(this._uSpecularFresnelEdgeBias=t.getUniform("xeo_uSpecularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=t.getUniform("xeo_uSpecularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=t.getUniform("xeo_uSpecularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=t.getUniform("xeo_uSpecularFresnelCenterColor"),this._uSpecularFresnelPower=t.getUniform("xeo_uSpecularFresnelPower")),e.opacityFresnel&&(this._uOpacityFresnelEdgeBias=t.getUniform("xeo_uOpacityFresnelEdgeBias"),this._uOpacityFresnelCenterBias=t.getUniform("xeo_uOpacityFresnelCenterBias"),this._uOpacityFresnelEdgeColor=t.getUniform("xeo_uOpacityFresnelEdgeColor"),this._uOpacityFresnelCenterColor=t.getUniform("xeo_uOpacityFresnelCenterColor"),this._uOpacityFresnelPower=t.getUniform("xeo_uOpacityFresnelPower")),e.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=t.getUniform("xeo_uReflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=t.getUniform("xeo_uReflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=t.getUniform("xeo_uReflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=t.getUniform("xeo_uReflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=t.getUniform("xeo_uReflectivityFresnelPower")),e.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=t.getUniform("xeo_uEmissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=t.getUniform("xeo_uEmissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=t.getUniform("xeo_uEmissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=t.getUniform("xeo_uEmissiveFresnelCenterColor"),this._uEmissiveFresnelPower=t.getUniform("xeo_uEmissiveFresnelPower"))},draw:function(e){var t=this.program.draw,i=this.state,r=this.program.gl;this._uShininess&&this._uShininess.setValue(i.shininess),e.lineWidth!==i.lineWidth&&(r.lineWidth(i.lineWidth),e.lineWidth=i.lineWidth),this._uPointSize&&this._uPointSize.setValue(i.pointSize),i.ambientMap&&i.ambientMap.texture&&(t.bindTexture(this._uAmbientMap,i.ambientMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(i.ambientMap.matrix)),i.diffuseMap&&i.diffuseMap.texture?(t.bindTexture(this._uDiffuseMap,i.diffuseMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(i.diffuseMap.matrix)):this._uDiffuse&&this._uDiffuse.setValue(i.diffuse),i.specularMap&&i.specularMap.texture?(t.bindTexture(this._uSpecularMap,i.specularMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(i.specularMap.matrix)):this._uSpecular&&this._uSpecular.setValue(i.specular),i.emissiveMap&&i.emissiveMap.texture?(t.bindTexture(this._uEmissiveMap,i.emissiveMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(i.emissiveMap.matrix)):this._uEmissive&&this._uEmissive.setValue(i.emissive),i.opacityMap&&i.opacityMap.texture?(t.bindTexture(this._uOpacityMap,i.opacityMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(i.opacityMap.matrix)):this._uOpacity&&this._uOpacity.setValue(i.opacity),i.reflectivityMap&&i.reflectivityMap.texture&&(t.bindTexture(this._uReflectivityMap,i.reflectivityMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(i.reflectivityMap.matrix)),i.normalMap&&i.normalMap.texture&&(t.bindTexture(this._uNormalMap,i.normalMap.texture,e.textureUnit<8?e.textureUnit++:e.textureUnit=0),e.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(i.normalMap.matrix)),i.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(i.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(i.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(i.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(i.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(i.diffuseFresnel.power)),i.specularFresnel&&(this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(i.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(i.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(i.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(i.specularFresnel.centerColor),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(i.specularFresnel.power)),i.opacityFresnel&&(this._uOpacityFresnelEdgeBias&&this._uOpacityFresnelEdgeBias.setValue(i.opacityFresnel.edgeBias),this._uOpacityFresnelCenterBias&&this._uOpacityFresnelCenterBias.setValue(i.opacityFresnel.centerBias),this._uOpacityFresnelEdgeColor&&this._uOpacityFresnelEdgeColor.setValue(i.opacityFresnel.edgeColor),this._uOpacityFresnelCenterColor&&this._uOpacityFresnelCenterColor.setValue(i.opacityFresnel.centerColor),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(i.opacityFresnel.power)),i.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&this._uReflectivityFresnelEdgeBias.setValue(i.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&this._uReflectivityFresnelCenterBias.setValue(i.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&this._uReflectivityFresnelEdgeColor.setValue(i.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&this._uReflectivityFresnelCenterColor.setValue(i.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(i.reflectivityFresnel.power)),i.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&this._uEmissiveFresnelEdgeBias.setValue(i.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&this._uEmissiveFresnelCenterBias.setValue(i.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&this._uEmissiveFresnelEdgeColor.setValue(i.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&this._uEmissiveFresnelCenterColor.setValue(i.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(i.emissiveFresnel.power))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},draw:function(e){this.program.draw.bind(),e.useProgram++},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uProjMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.getMatrix())},pickObject:function(e){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(e.pickProjMatrix||this.state.getMatrix())},pickPrimitive:function(e){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(e.pickProjMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(e){var t=this.program.gl,i=this.state;e.renderBuf&&(t.flush(),e.renderBuf.unbind(),e.renderBuf=null,e.bindOutputFramebuffer&&e.bindOutputFramebuffer(e.pass));var r=i.renderBuf;r?(r.bind(),e.depthMode=i.type===i.DEPTH,e.blendEnabled&&!e.depthMode&&(t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(e.ambientColor[0],e.ambientColor[1],e.ambientColor[2],1),e.renderBuf=r):e.depthMode=!1}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shader",draw:function(){var e=this.state.params;if(e){var t,i=this.program.draw;for(t in e)e.hasOwnProperty(t)&&i.setUniform(t,e[t])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shaderParams",draw:function(){var e=this.state.params;if(e){var t,i=this.program.draw;for(t in e)e.hasOwnProperty(t)&&i.setUniform(t,e[t])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("xeo_uViewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uViewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.getMatrix()),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(e){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(e.pickViewMatrix||this.state.getMatrix())},pickPrimitive:function(e){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(e.pickViewMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewport",programGlobal:!0,draw:function(){var e=this.state.boundary;this.program.gl.viewport(e[0],e[1],e[2],e[3])},pickObject:function(){var e=this.state.boundary;this.program.gl.viewport(e[0],e[1],e[2],e[3])},pickPrimitive:function(){var e=this.state.boundary;this.program.gl.viewport(e[0],e[1],e[2],e[3])}})}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var e={},t=arguments[0],i=arguments[1];this.scene=null,"xeogl.Scene"===this.type?(this.scene=this,t&&(e=t)):(t?"xeogl.Scene"===t.type?(this.scene=t,i&&(e=i)):(this.scene=xeogl.scene,e=t):this.scene=xeogl.scene,this._renderer=this.scene._renderer),this.meta=e.meta||{},this.isDefault=e.isDefault,this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._events=null,this._handleMap=null,this._handleEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._sharedComponents=null,this.scene&&"xeogl.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(e)},type:"xeogl.Component",superTypes:[],isType:function(e){return!(!xeogl._isString(e)&&!(e=e.type))&&xeogl._isComponentType(this.type,e)},_init:function(e){},fire:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t);var r,s=this._eventSubs[e];if(s)for(var n in s)s.hasOwnProperty(n)&&(r=s[n],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)},on:function(e,t,i){this._events||(this._events={}),this._handleMap||(this._handleMap=new xeogl.utils.Map),this._handleEvents||(this._handleEvents={}),this._eventSubs||(this._eventSubs={});var r=this._eventSubs[e];r||(r={},this._eventSubs[e]=r);var s=this._handleMap.addItem();r[s]={callback:t,scope:i||this},this._handleEvents[s]=e;var n=this._events[e];return void 0!==n&&t.call(i||this,n),s},off:function(e){if(void 0!==e&&null!==e&&this._handleEvents){var t=this._handleEvents[e];if(t){delete this._handleEvents[e];var i=this._eventSubs[t];i&&delete i[e],this._handleMap.removeItem(e)}}},once:function(e,t,i){var r=this,s=this.on(e,function(e){r.off(s),t(e)},i)},log:function(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)},_message:function(e){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+e},warn:function(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)},error:function(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)},clone:function(e){if(!this.destroyed){e=e||{};var t=this.json;return delete t.id,new this.constructor(this.scene,xeogl._apply(e,t))}this.error("Clone failed - component has been destroyed")},_attach:function(e){var t=e.name;if(t){var i=e.component,r=e.sceneDefault,s=e.sceneSingleton,n=e.type,a=e.on,o=!1!==e.recompiles,h=!1;if(i)if(xeogl._isNumeric(i)||xeogl._isString(i)){var l=i;if(!(i=this.scene.components[l]))return void this.error("Component not found: "+xeogl._inQuotes(l))}else if(xeogl._isObject(i)){var c=i,u=c.type||n||"xeogl.Component",d=window[u];if(!d)return void this.error("Component type not found: "+u);if(n&&!xeogl._isComponentType(u,n))return void this.error("Expected a "+n+" type or subtype, not a "+u);i=new d(c),h=!0}if(!i)if(!0===s){var f=this.scene.types[n];for(var _ in f)if(f.hasOwnProperty){i=f[_];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===r&&!(i=this.scene[t]))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+xeogl._inQuotes(i.id));if(n&&!i.isType(n))return void this.error("Expected a "+n+" type or subtype: "+i.type+" "+xeogl._inQuotes(i.id))}this._attachments||(this._attachments={});var p,g,m,y=this._attached[t];if(y){if(i&&y.id===i.id)return;var v=this._attachments[y.id];for(g=0,m=(p=v.subs).length;g<m;g++)y.off(p[g]);delete this._attached[t],delete this._attachments[y.id];var x=v.params.onDetached;x&&(xeogl._isFunction(x)?x(y):x.scope?x.callback.call(x.scope,y):x.callback(y)),v.managingLifecycle&&y.destroy()}if(i){var b={params:e,component:i,subs:[],managingLifecycle:h};b.subs.push(i.on("destroyed",function(){b.params.component=null,this._attach(b.params)},this)),o&&b.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[t]=i,this._attachments[i.id]=b;var w,M,E,S,C=e.onAttached;if(C&&(xeogl._isFunction(C)?C(i):C.scope?C.callback.call(C.scope,i):C.callback(i)),a)for(w in a)if(a.hasOwnProperty(w)){if(M=a[w],xeogl._isFunction(M)?(E=M,S=null):(E=M.callback,S=M.scope),!E)continue;b.subs.push(i.on(w,E,S))}}return o&&this.fire("dirty",this),this.fire(t,i),i}this.error("Component 'name' expected")},create:function(e,t){var i=this.scene._getSharedComponent(e,t);return i&&(this._sharedComponents||(this._sharedComponents={}),this._sharedComponents[i.id]||(this._sharedComponents[i.id]=i),i.on("destroyed",function(){delete this._sharedComponents[i.id]},this)),i},_scheduleUpdate:function(e){this._updateScheduled||(this._updateScheduled=!0,0===e?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._update&&this._update(),this._updateScheduled=!1)},_update:null,_compile:function(){},_props:{json:{get:function(){var e={type:this.type,id:this.id};return xeogl._isEmptyObject(this.meta)||(e.meta=this.meta),this._getJSON?xeogl._apply(this._getJSON(),e):e}},string:{get:function(){return JSON.stringify(this.json,"\n",4)}},js:{get:function(){var e=this.json;delete e.id;var t=JSON.stringify(e,"\n",4);return"new "+this.type+"("+t+");"}}},destroy:function(){var e,t,i,r,s,n;if(this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=(t=this._attachments[e]).component,s=0,n=(r=t.subs).length;s<n;s++)i.off(r[s]);t.managingLifecycle&&i.destroy()}if(this._sharedComponents)for(e in this._sharedComponents)this._sharedComponents.hasOwnProperty(e)&&(i=this._sharedComponents[e],delete this._sharedComponents[e],this.scene._putSharedComponent(i));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";var e;xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(e){var t=this,i=!!e.transparent;this._componentIDMap=new xeogl.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this._sharedComponents={},this._sharedComponentIDs={},this._sharedCounts={},this._dirtyEntities={},this.configs=new xeogl.Configs(this,e.configs),this.canvas=new xeogl.Canvas(this,{canvas:e.canvas,transparent:i,backgroundColor:e.backgroundColor,backgroundImage:e.backgroundImage,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{}}),this.canvas.on("boundary",function(){t._renderer.imageDirty=!0}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this.canvas.canvas,this.canvas.gl,{transparent:i}),this.input=new xeogl.Input(this,{element:this.canvas.overlay}),xeogl._addScene(this);var r=e.components;if(r)for(var s,n,a,o=0,h=r.length;o<h;o++)(n=(s=r[o]).type)&&(a=window[n])&&new a(this,s);this._initDefaults(),this.ticksPerRender=e.ticksPerRender,this.passes=e.passes,this.clearEachPass=e.clearEachPass},_initDefaults:function(){this.view,this.project,this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.cull,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform,this.viewport},_addComponent:function(e){if(e.id){if(this.components[e.id])return void this.error("Component "+xeogl._inQuotes(e.id)+" already exists in Scene")}else e.id=this._componentIDMap.addItem(e);this.components[e.id]=e;var t=e.type,i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.on("destroyed",function(){this._componentDestroyed(e)},this),e.isType("xeogl.Entity")&&(e.on("dirty",this._entityDirty,this),this.entities[e.id]=e,this._worldBoundary&&e.worldBoundary.on("updated",this._setWorldBoundaryDirty,this),xeogl.stats.components.entities++),this.fire("componentCreated",e,!0)},_componentDestroyed:function(e){this._componentIDMap.removeItem(e.id),delete this.components[e.id];var t=this.types[e.type];t&&(delete t[e.id],xeogl._isEmptyObject(t)&&delete this.types[e.type]),e.isType("xeogl.Entity")&&(xeogl.stats.components.entities--,delete this.entities[e.id],delete this._dirtyEntities[e.id]),this.fire("componentDestroyed",e,!0)},_entityDirty:function(e){this._dirtyEntities[e.id]||(this._dirtyEntities[e.id]=e)},render:(e={sceneId:null,pass:null},function(t){e.sceneId=this.id;var i,r,s=this._passes,n=this._clearEachPass;for(i=0;i<s;i++)e.pass=i,this.fire("rendering",e,!0),r=n||0===i,this._compile(i,r,t),this.fire("rendered",e,!0)}),_props:{ticksPerRender:{set:function(e){void 0===e||null===e?e=1:(!xeogl._isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e,this.fire("ticksPerRender",this._ticksPerRender))},get:function(){return this._ticksPerRender}},passes:{set:function(e){void 0===e||null===e?e=1:(!xeogl._isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this._renderer.imageDirty=!0,this.fire("passes",this._passes))},get:function(){return this._passes}},clearEachPass:{set:function(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this._renderer.imageDirty=!0,this.fire("clearEachPass",this._clearEachPass))},get:function(){return this._clearEachPass}},project:{get:function(){return this.components["default.project"]||new xeogl.Perspective(this,{id:"default.project",isDefault:!0})}},view:{get:function(){return this.components["default.view"]||new xeogl.Lookat(this,{id:"default.view",isDefault:!0})}},camera:{get:function(){return this.components["default.camera"]||new xeogl.Camera(this,{id:"default.camera",isDefault:!0,project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new xeogl.Transform(this,{id:"default.transform",isDefault:!0})}},billboard:{get:function(){return this.components["default.billboard"]||new xeogl.Billboard(this,{id:"default.billboard",active:!1,isDefault:!0})}},stationary:{get:function(){return this.components["default.stationary"]||new xeogl.Stationary(this,{id:"default.stationary",active:!1,isDefault:!0})}},clips:{get:function(){return this.components["default.clips"]||new xeogl.Clips(this,{id:"default.clips",isDefault:!0})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new xeogl.ColorBuf(this,{id:"default.colorBuf",isDefault:!0})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new xeogl.ColorTarget(this,{id:"default.colorTarget",isDefault:!0,active:!1})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new xeogl.DepthBuf(this,{id:"default.depthBuf",isDefault:!0,active:!0})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new xeogl.DepthTarget(this,{id:"default.depthTarget",isDefault:!0,active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new xeogl.Visibility(this,{id:"default.visibility",isDefault:!0,visible:!0})}},cull:{get:function(){return this.components["default.cull"]||new xeogl.Cull(this,{id:"default.cull",isDefault:!0,culled:!1})}},modes:{get:function(){return this.components["default.modes"]||new xeogl.Modes(this,{id:"default.modes",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},layer:{get:function(){return this.components["default.layer"]||new xeogl.Layer(this,{id:"default.layer",isDefault:!0,priority:0})}},lights:{get:function(){return this.components["default.lights"]||new xeogl.Lights(this,{id:"default.lights",isDefault:!0,lights:[new xeogl.AmbientLight(this,{id:"default.light0",color:[.45,.45,.5],intensity:.9}),new xeogl.DirLight(this,{id:"default.light1",dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new xeogl.DirLight(this,{id:"default.light2",dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new xeogl.MorphTargets(this,{id:"default.morphTargets",isDefault:!0})}},reflect:{get:function(){return this.components["default.reflect"]||new xeogl.Reflect(this,{id:"default.reflect",isDefault:!0})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new xeogl.Shader(this,{id:"default.shader",isDefault:!0})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new xeogl.ShaderParams(this,{id:"default.shaderParams",isDefault:!0})}},stage:{get:function(){return this.components["default.stage"]||new xeogl.Stage(this,{id:"default.stage",priority:0,isDefault:!0})}},viewport:{get:function(){return this.components["default.viewport"]||new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0,isDefault:!0})}},worldBoundary:{get:function(){if(!this._worldBoundary){var e=this,t=xeogl.math.AABB3();this._worldBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return e._worldBoundaryDirty},getAABB:function(){xeogl.math.collapseAABB3(t);var i,r=e.entities;for(var s in r)r.hasOwnProperty(s)&&(i=r[s]).modes.collidable&&xeogl.math.expandAABB3(t,i.worldBoundary.aabb);return t}}),this._worldBoundary.on("destroyed",function(){e._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){var e=xeogl.math,t=e.vec3(),i=e.vec3(),r=e.vec3(),s=e.vec3(),n=e.vec3(),a=e.vec3(),o=e.vec4(),h=e.vec3(),l=e.vec3(),c=e.vec3(),u=e.vec3(),d=e.vec3(),f=e.vec3(),_=e.vec3(),p=e.vec3(),g=e.vec3(),m=e.vec4(),y=e.vec4(),v=e.vec4(),x=e.vec4(),b=(e.vec4(),e.vec3()),w=e.vec3(),M=e.vec3(),E=e.vec3(),S=e.vec3(),C=e.vec3(),D=e.vec3(),k=e.vec3(),T=e.vec3(),B=e.vec3(),A=e.vec3(),F=e.mat4(),P=e.mat4(),O=e.mat4();return function(R){(R=R||{}).pickSurface=R.pickSurface||R.rayPick,R.canvasPos||R.origin&&R.direction||this.warn("picking without canvasPos or ray origin and direction");var L=this._renderer.pick(R);if(L){var U=this.entities[L.entity];if(L.entity=U,R.pickSurface&&void 0!==L.primIndex&&L.primIndex>-1){var I=U.geometry;if("triangles"===I.primitive){L.primitive="triangle";var N,V=L.primIndex,j=I.indices,z=I.positions,Y=j[V],G=j[V+1],K=j[V+2],H=3*Y,W=3*G,X=3*K;a[0]=Y,a[1]=G,a[2]=K,L.indices=a,r[0]=z[H],r[1]=z[H+1],r[2]=z[H+2],s[0]=z[W],s[1]=z[W+1],s[2]=z[W+2],n[0]=z[X],n[1]=z[X+1],n[2]=z[X+2],R.canvasPos?(N=R.canvasPos,L.canvasPos=R.canvasPos,function(t,i,r,s){var n=t.scene.canvas.canvas,a=t.transform.leafMatrix,o=t.camera.view.matrix,h=t.camera.project.matrix,l=e.mulMat4(o,a,F),c=e.mulMat4(h,l,P),u=e.inverseMat4(c,O),d=n.width,f=n.height,_=(i[0]-d/2)/(d/2),p=-(i[1]-f/2)/(f/2);m[0]=_,m[1]=p,m[2]=-1,m[3]=1,e.transformVec4(u,m,y),e.mulVec4Scalar(y,1/y[3]),v[0]=_,v[1]=p,v[2]=1,v[3]=1,e.transformVec4(u,v,x),e.mulVec4Scalar(x,1/x[3]),r[0]=x[0],r[1]=x[1],r[2]=x[2],e.subVec3(x,y,s),e.normalizeVec3(s)}(U,N,t,i)):R.origin&&R.direction&&function(t,i,r,s,n){var a=t.transform.leafMatrix,o=e.inverseMat4(a,F);m[0]=i[0],m[1]=i[1],m[2]=i[2],m[3]=1,e.transformVec4(o,m,y),s[0]=y[0],s[1]=y[1],s[2]=y[2],e.transformVec3(o,r,n)}(U,R.origin,R.direction,t,i),e.normalizeVec3(i),e.rayPlaneIntersect(t,i,r,s,n,o),L.localPos=o,L.position=o,m[0]=o[0],m[1]=o[1],m[2]=o[2],m[3]=1,e.transformVec4(U.transform.leafMatrix,m,y),h[0]=y[0],h[1]=y[1],h[2]=y[2],L.worldPos=h,e.transformVec4(U.camera.view.matrix,y,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],L.viewPos=l,e.cartesianToBarycentric(o,r,s,n,c),L.bary=c;var J=I.normals;if(J){u[0]=J[H],u[1]=J[H+1],u[2]=J[H+2],d[0]=J[W],d[1]=J[W+1],d[2]=J[W+2],f[0]=J[X],f[1]=J[X+1],f[2]=J[X+2];var q=e.addVec3(e.addVec3(e.mulVec3Scalar(u,c[0],b),e.mulVec3Scalar(d,c[1],w),M),e.mulVec3Scalar(f,c[2],E),S);L.normal=e.transformVec3(U.transform.leafMatrix,q,C)}var Q=I.uv;Q&&(_[0]=Q[2*Y],_[1]=Q[2*Y+1],p[0]=Q[2*G],p[1]=Q[2*G+1],g[0]=Q[2*K],g[1]=Q[2*K+1],L.uv=e.addVec3(e.addVec3(e.mulVec2Scalar(_,c[0],D),e.mulVec2Scalar(p,c[1],k),T),e.mulVec2Scalar(g,c[2],B),A))}}return L}}}(),clear:function(){for(var e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this._initDefaults(),this._dirtyEntities={}},_getSharedComponent:function(e,t){var i,r;if(xeogl._isObject(e)?(i=e.type||"xeogl.Component",r=xeogl[i.substring(6)]):xeogl._isString(e)?(i=e,r=xeogl[i.substring(6)]):(r=e,i=e.prototype.type),r){var s,n;if(xeogl._isComponentType(i,"xeogl.Component"))return void 0!==t&&(n="__shared."+i+"."+t,s=this._sharedComponents[n])?(this._sharedCounts[n]++,s):e&&e.id&&this.components[e.id]?(this.error("Component "+xeogl._inQuotes(e.id)+" already exists in Scene"),null):(s=new r(this,e),void 0!==t&&(this._sharedComponents[n]=s,this._sharedComponentIDs[s.id]=n,this._sharedCounts[n]=1,s.on("destroyed",function(){void 0!==this._sharedComponentIDs[s.id]&&this._putSharedComponent(s)},this)),s);this.error("Expected a xeogl.Component type or subtype")}else this.error("Component type not found: "+i)},_putSharedComponent:function(e){var t=this._sharedComponentIDs[e.id];if(void 0!==t){if(--this._sharedCounts[t]>0)return;delete this._sharedComponents[t],delete this._sharedComponentIDs[e.id],delete this._sharedCounts[t]}e.destroy()},_compile:function(e,t,i){var r;for(var s in this._dirtyEntities)this._dirtyEntities.hasOwnProperty(s)&&(r=this._dirtyEntities[s])._valid()&&(r._compile(),delete this._dirtyEntities[s],0);this._renderer.render({pass:e,clear:t,force:i});var n=this.canvas;if(n.transparent||n.backgroundImage||n.backgroundColor)this._lastAmbientColor=null;else{var a=this._renderer.ambientColor;this._lastAmbientColor&&this._lastAmbientColor[0]===a[0]&&this._lastAmbientColor[1]===a[1]&&this._lastAmbientColor[2]===a[2]&&this._lastAmbientColor[3]===a[3]||(n.backgroundColor=a,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4()),this._lastAmbientColor.set(a))}},_getJSON:function(){var e,t=[];for(var i in this.components)if(this.components.hasOwnProperty(i)){if(!(e=this.components[i])._getJSON)continue;t.unshift(e)}t.sort(function(e,t){return e._componentOrder-t._componentOrder});for(var r=[],s=0,n=t.length;s<n;s++)r.push(t[s].json);return{passes:this._passes,clearEachPass:this._clearEachPass,components:r}},_destroy:function(){this.clear()}})}(),function(){"use strict";xeogl.MorphTargets=xeogl.Component.extend({type:"xeogl.MorphTargets",_init:function(e){this.scene.on("webglContextRestored",function(){}),this.targets=e.targets,this.factor=e.factor},_props:{targets:{set:function(e){},get:function(){}},factor:{set:function(e){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";var e,t,i,r,s,n,a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(e){this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._flying=!1,this._flyEyeLookUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail,this.camera=e.camera,this._aabbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this._obbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})})},flyTo:(n=a.vec3(),function(e,t,i){e=e||this.scene,this._flying&&this.stop();var r=this._attached.camera;if(r){this._flying=!1,this._callback=t,this._callbackScope=i;var s,o,h,l,c,u=r.view;if(this._eye1[0]=u.eye[0],this._eye1[1]=u.eye[1],this._eye1[2]=u.eye[2],this._look1[0]=u.look[0],this._look1[1]=u.look[1],this._look1[2]=u.look[2],this._up1[0]=u.up[0],this._up1[1]=u.up[1],this._up1[2]=u.up[2],e.worldBoundary)s=e.worldBoundary.aabb;else if(e.aabb)s=e.aabb;else if(6===e.length)s=e;else if(e.eye||e.look||e.up)o=e.eye,h=e.look,l=e.up;else{var d=e;if((xeogl._isNumeric(d)||xeogl._isString(d))&&(c=d,!(d=this.scene.components[c])))return this.error("Component not found: "+xeogl._inQuotes(c)),void(t&&(i?t.call(i):t()));var f=d.worldBoundary;if(!f)return this.error("Can't fly to component "+xeogl._inQuotes(c)+" - does not have a worldBoundary"),void(t&&(i?t.call(i):t()));s=f.aabb}var _=e.offset;if(s){if(s[3]<=s[0]||s[4]<=s[1]||s[5]<=s[2])return;this._aabbHelper.geometry.aabb=s,this._aabbHelper.visibility.visible=!0;var p=a.getAABB3Center(s);this._look2=e.look||p,_&&(this._look2[0]+=_[0],this._look2[1]+=_[1],this._look2[2]+=_[2]);var g=a.normalizeVec3(a.subVec3(this._eye1,this._look1,n)),m=(e.look,a.getAABB3Diag(s)),y=Math.abs(m/Math.tan((e.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD));this._eye2[0]=this._look2[0]+g[0]*y,this._eye2[1]=this._look2[1]+g[1]*y,this._eye2[2]=this._look2[2]+g[2]*y,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(o||h||l)&&(h=h||this._look1,o=o||this._eye1,l=l||this._up1,this._look2[0]=h[0],this._look2[1]=h[1],this._look2[2]=h[2],this._eye2[0]=o[0],this._eye2[1]=o[1],this._eye2[2]=o[2],this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2],this._flyEyeLookUp=!0);this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}else t&&(i?t.call(i):t())}),jumpTo:function(){a.vec3();var e=a.vec3(),t=a.vec3(),i=a.vec3(),r=a.vec3(),s=a.vec3();return function(n){this._flying&&this.stop();var o=this._attached.camera;if(o){var h,l,c,u=o.view;if(n.worldBoundary)l=n.worldBoundary.sphere;else if(n.sphere)l=n.sphere;else if(n.aabb)h=n.aabb;else if(6===n.length)h=n;else if(4===n.length)l=n;else if(n.eye||n.look||n.up)e=n.eye,t=n.look,i=n.up;else{var d=n;if((xeogl._isNumeric(d)||xeogl._isString(d))&&(c=d,!(d=this.scene.components[c])))return void this.error("Component not found: "+xeogl._inQuotes(c));var f=d.worldBoundary;if(!f)return void this.error("Can't jump to component "+xeogl._inQuotes(c)+" - does not have a worldBoundary");l=f.sphere}n.offset;if(h||l){var _,p;if(h){if(h[3]<=h[0]||h[4]<=h[1]||h[5]<=h[2])return;_=a.getAABB3Diag(h),a.getAABB3Center(h,t)}else{if(l[3]<=0)return;_=2*l[3],t[0]=l[0],t[1]=l[1],t[2]=l[2]}this._trail?a.subVec3(u.look,t,r):a.subVec3(u.eye,u.look,r),a.normalizeVec3(r),p=(void 0!==n.fit?n.fit:this._fit)?Math.abs(_/Math.tan((n.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(u.eye,u.look,s)),a.mulVec3Scalar(r,p),u.eye=a.addVec3(t,r,e),u.look=t}else(e||t||i)&&(e&&(u.eye=e),t&&(u.look=t),i&&(u.up=i))}}}(),_update:(e=a.vec3(),t=a.vec3(),i=a.vec3(),r=a.vec3(),s=a.vec3(),function(){if(this._flying){var n=(Date.now()-this._time1)/(this._time2-this._time1),o=n>=1;n>1&&(n=1),n=this.easing?this._ease(n,0,1,1):n;var h,l=this._attached.camera.view;this._flyEyeLookUp?(l.eye=a.lerpVec3(n,0,1,this._eye1,this._eye2,t),l.look=a.lerpVec3(n,0,1,this._look1,this._look2,i),l.up=a.lerpVec3(n,0,1,this._up1,this._up2,r)):(a.lerpVec3(n,0,1,this._look1,this._look2,i),this._trail?a.subVec3(i,l.look,e):a.subVec3(l.eye,l.look,e),a.normalizeVec3(e),a.lerpVec3(n,0,1,this._eye1,this._eye2,t),a.subVec3(t,i,s),h=a.lenVec3(s),a.mulVec3Scalar(e,h),l.eye=a.addVec3(i,e,t),l.look=i),o?this.stop():xeogl.scheduleTask(this._update,this)}}),_ease:function(e,t,i,r){return-i*(e/=r)*(e-2)+t},stop:function(){if(this._flying){this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0}),this.stop()},get:function(){return this._attached.camera}},duration:{set:function(e){e=e||.5,this._duration=1e3*e,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(e){this._fit=!1!==e,this.fire("fit",this._fit)},get:function(){return this._fit}},fitFOV:{set:function(e){e=e||45,this._fitFOV=e},get:function(){return this._fitFOV}},trail:{set:function(e){this._trail=!!e,this.fire("trail",this._trail)},get:function(){return this._trail}}},_getJSON:function(){var e={duration:this._duration,fitFOV:this._fitFOV,fit:this._fit,trail:this._trail};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(e){this.project=e.project,this.view=e.view},_props:{project:{set:function(e){this._attach({name:"project",type:"xeogl.Transform",component:e,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("projectMatrix")},scope:this}}})},get:function(){return this._attached.project}},view:{set:function(e){this._attach({name:"view",type:"xeogl.Transform",component:e,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("viewMatrix")},scope:this}}})},get:function(){return this._attached.view}}},_compile:function(){this._renderer.projTransform=this._attached.project._state,this._renderer.viewTransform=this._attached.view._state},_getJSON:function(){return{project:this._attached.project.id,view:this._attached.view.id}}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(e){if(this.canvas=null,this.overlay=null,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!1,e.canvas?xeogl._isString(e.canvas)?(this.canvas=document.getElementById(e.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(e.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=e.canvas:this._createCanvas(),this.canvas){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),this._createOverlay(),this._resizeBackground(),this._resizeOverlay(),this._initWebGL(e);var t=this;this.canvas.addEventListener("webglcontextlost",function(){t.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){t._initWebGL(),t.gl&&t.fire("webglContextRestored",t.gl)},!1);var i=null,r=null,s=null,n=null;this._tick=this.scene.on("tick",function(){var e=t.canvas,a=window.innerWidth!==i||window.innerHeight!==r,o=e.clientWidth!==s||e.clientHeight!==n,h=null!==e.offsetLeft||null!==e.offsetTop;if((a||o||h)&&(t._spinner._adjustPosition(),t._resizeBackground(),t._resizeOverlay(),o)){var l,c=e.clientWidth,u=e.clientHeight,d=0;for(var f in xeogl.scenes)xeogl.scenes.hasOwnProperty(f)&&(d+=(l=xeogl.scenes[f]).canvas.canvas.clientWidth*l.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=d,e.width=e.clientWidth,e.height=e.clientHeight;var _=t.boundary;_[0]=e.offsetLeft,_[1]=e.offsetTop,_[2]=c,_[3]=u,t.fire("boundary",_),s=c,n=u,i=window.innerWidth,r=window.innerHeight}}),this.canvas.oncontextmenu=function(e){e.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=e.backgroundColor,this.backgroundImage=e.backgroundImage}else this.error("Faied to create canvas")},_createCanvas:function(){var e="xeogl-canvas-"+xeogl.math.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r.height="100%",r.width="100%",r.padding="0",r.margin="0",r.background="rgba(0,0,0,0);",r.float="left",r.left="0",r.top="0",r.position="absolute",r.opacity="1.0",r["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)},_createBackground:function(){var e=document.getElementsByTagName("body")[0],t=document.createElement("div"),i=t.style;i.padding="0",i.margin="0",i.background=null,i.backgroundImage=null,i.float="left",i.left="0",i.top="0",i.width="0px",i.height="0px",i.position="absolute",i.opacity=1,i["z-index"]="-20000",e.appendChild(t),this._backgroundElement=t},_createOverlay:function(){var e=document.getElementsByTagName("body")[0],t=document.createElement("div"),i=t.style;i.padding="0",i.margin="0",i.background="black",i.float="left",i.left="0",i.top="0",i.width="0px",i.height="0px",i.position="absolute",i.opacity=0,i["z-index"]="100000",e.appendChild(t),this.overlay=t},_resizeOverlay:function(){if(this.canvas&&this.overlay){var e=this.canvas,t=this.overlay.style,i=this._getElementXY(e);t.left=i.x+"px",t.top=i.y+"px",t.width=e.clientWidth+"px",t.height=e.clientHeight+"px"}},_resizeBackground:function(){if(this.canvas&&this._backgroundElement){var e=this.canvas,t=this._backgroundElement.style,i=this._getElementXY(e);t.left=i.x+"px",t.top=i.y+"px",t.width=e.clientWidth+"px",t.height=e.clientHeight+"px"}},_getElementXY:function(e){for(var t=0,i=0;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;var r=document.body.getBoundingClientRect();return{x:t-r.left,y:i-r.top}},_initWebGL:function(e){if(e.webgl2){try{this.gl=this.canvas.getContext("webgl2",this.contextAttr)}catch(e){}this.gl?this.webgl2=!0:this.warn("Failed to get a WebGL 2 context - defaulting to WebGL 1.")}if(!this.gl)for(var t=0;!this.gl&&t<this._WEBGL_CONTEXT_NAMES.length;t++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[t],this.contextAttr)}catch(e){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},getSnapshot:function(e){if(this.canvas){this.scene.render();var t,i=(e=e||{}).width||this.canvas.width,r=e.height||this.canvas.height,s=e.format||"jpeg";switch(s){case"jpeg":t=Canvas2Image.saveAsJPEG(this.canvas,!0,i,r);break;case"png":t=Canvas2Image.saveAsPNG(this.canvas,!0,i,r);break;case"bmp":t=Canvas2Image.saveAsBMP(this.canvas,!0,i,r);break;default:this.error("Unsupported snapshot format: '"+s+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),t=Canvas2Image.saveAsJPEG(this.canvas,!0,i,r)}return t.src}this.error("Can't get snapshot - no canvas.")},readPixels:function(e,t,i,r){return this.scene._renderer.readPixels(e,t,i,r)},_props:{backgroundColor:{set:function(e){if(e){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(e||[0,0,0,1]),!this._backgroundImageSrc){var t="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=t}}else this._backgroundColor=null;this.fire("backgroundColor",this._backgroundColor)},get:function(){return this._backgroundColor}},backgroundImage:{set:function(e){if(e)if(xeogl._isString(e)){if(e!==this._backgroundImageSrc){if(this._backgroundElement.style.backgroundImage="url('"+e+"')",this._backgroundImageSrc=e,!this._backgroundImageSrc){var t="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=t}this.fire("backgroundImage",this._backgroundImageSrc)}}else this.error("Value for 'backgroundImage' should be a string")},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var e=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(e){this._canvas=e.canvas,this._injectSpinnerCSS();var t=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r["z-index"]="9000",r.position="absolute",i.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',t.appendChild(i),this._element=i,this._adjustPosition(),this.processes=0,this.textures=e.textures},_props:{textures:{set:function(e){e=!1!==e,this._textures=e,this.fire("textures",this._textures)},get:function(){return this._textures}},processes:{set:function(e){e=e||0,this._processes!==e&&(e<0||(this._processes=e,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!e){var t=document.createElement("style");t.innerHTML=this._spinnerCSS,document.body.appendChild(t),e=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(e){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=e.mode,this.dir=e.dir,this.dist=e.dist},_props:{mode:{set:function(e){this._state.mode=e||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(e){this._state.dir=e||xeogl.math.vec3([1,0,0]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(e){this._state.dist=void 0!==e?e:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";xeogl.Clips=xeogl.Component.extend({type:"xeogl.Clips",_init:function(e){this._state=new xeogl.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=e.clips},_props:{clips:{set:function(e){var t,i,r,s;for(e=e||[],i=0,r=this._clips.length;i<r;i++)(t=this._clips[i]).off(this._dirtySubs[i]),t.off(this._destroyedSubs[i]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var n=this;function a(){n.fire("dirty",!0)}function o(){for(var e=this.id,t=0,i=n._clips.length;t<i;t++)if(n._clips[t].id===e)return n._clips=n._clips.slice(t,t+1),n._dirtySubs=n._dirtySubs.slice(t,t+1),n._destroyedSubs=n._destroyedSubs.slice(t,t+1),n._dirty=!0,n.fire("dirty",!0),void n.fire("clips",n._clips)}for(i=0,r=e.length;i<r;i++)t=e[i],!xeogl._isString(t)||(s=t,t=this.components[s])?"xeogl.Clip"===t.type?(this._clips.push(t),this._dirtySubs.push(t.on("dirty",a)),this._destroyedSubs.push(t.on("destroyed",o))):this.error("Component "+xeogl._inQuotes(s)+" is not a xeogl.Clip"):this.error("Component not found: "+xeogl._inQuotes(s));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var e=this._state;if(this._dirty){e.clips=[];for(var t=0,i=this._clips.length;t<i;t++)e.clips.push(this._clips[t]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=e},_makeHash:function(){var e,t=this._state.clips;if(0===t.length)return";";for(var i=[],r=0,s=t.length;r<s;r++)e=t[r],i.push(e._state.mode);i.push(";"),this._state.hash=i.join("")},_getJSON:function(){for(var e=[],t=0,i=this._clips.length;t<i;t++)e.push(this._clips[t].id);return{clips:e}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Configs=xeogl.Component.extend({type:"xeogl.Configs",_init:function(e){for(var t in this.props={},e)e.hasOwnProperty(t)&&this.set(t,e[t])},set:function(e,t){this.props[e]=t,this.fire(e,t)},_toJSON:function(){return xeogl._copy(this.props)}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",exclusive:!0,_init:function(e){this.scene;this._boundaryHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this.keyboardAxis=this.create(xeogl.KeyboardAxisCamera,{camera:e.camera}),this.keyboardRotate=this.create(xeogl.KeyboardRotateCamera,{camera:e.camera}),this.mouseRotate=this.create(xeogl.MouseRotateCamera,{camera:e.camera}),this.keyboardPan=this.create(xeogl.KeyboardPanCamera,{camera:e.camera}),this.mousePan=this.create(xeogl.MousePanCamera,{camera:e.camera}),this.keyboardZoom=this.create(xeogl.KeyboardZoomCamera,{camera:e.camera}),this.mouseZoom=this.create(xeogl.MouseZoomCamera,{camera:e.camera}),this.mousePickEntity=this.create(xeogl.MousePickEntity,{pickSurface:!0}),this.mousePickEntity.on("pick",this._entityPicked,this),this.mousePickEntity.on("nopick",function(){}),this.cameraFlight=this.create(xeogl.CameraFlightAnimation,{camera:e.camera,duration:.5}),this.firstPerson=e.firstPerson,this.camera=e.camera,this.active=!1!==e.active},_entityPicked:function(e){var t;e.worldPos&&(t=e.worldPos);var i=e.entity.worldBoundary,r=i.aabb;i.sphere;if(this._boundaryHelper.geometry.aabb=r,t){var s=this.camera.view;xeogl.math.subVec3(s.eye,s.look,[]);this.cameraFlight.flyTo({look:t,aabb:r},this._hideEntityBoundary,this)}else this.cameraFlight.flyTo({aabb:r},this._hideEntityBoundary,this)},_hideEntityBoundary:function(){this._boundaryHelper.visibility.visible=!1},_props:{firstPerson:{set:function(e){e=!!e,this._firstPerson=e,this.keyboardRotate.firstPerson=e,this.mouseRotate.firstPerson=e,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var t=this._attached.camera;this.keyboardAxis.camera=t,this.keyboardRotate.camera=t,this.mouseRotate.camera=t,this.keyboardPan.camera=t,this.mousePan.camera=t,this.keyboardZoom.camera=t,this.mouseZoom.camera=t,this.cameraFlight.camera=t},get:function(){return this._attached.camera}},active:{set:function(e){e=!!e,this._active!==e&&(this.keyboardAxis.active=e,this.keyboardRotate.active=e,this.mouseRotate.active=e,this.keyboardPan.active=e,this.mousePan.active=e,this.keyboardZoom.active=e,this.mouseZoom.active=e,this.mousePickEntity.active=e,this.cameraFlight.active=e,this.fire("active",this._active=e))},get:function(){return this._active}}},_getJSON:function(){var e={firstPerson:this._firstPerson,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.CameraController=xeogl.Component.extend({type:"xeogl.CameraController",_init:function(e){this.camera=e.camera,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0,onAddedScope:this})},get:function(){return this._attached.camera}},active:{set:function(e){e=!!e,this._active!==e&&(this._active=e,this.fire("active",this._active))},get:function(){return this._active}}},_getJSON:function(){var e={active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardAxisCamera=xeogl.Component.extend({type:"xeogl.KeyboardAxisCamera",_init:function(e){this._onKeyDown=null,this._cameraFly=new xeogl.CameraFlightAnimation(this.scene,{duration:1}),this.camera=e.camera,this.active=!1!==e.active},_props:{camera:{set:function(e){var t=this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0});this._cameraFly.camera=t},get:function(){return this._attached.camera}},active:{set:function(e){if(e=!!e,this._active!==e){this._cameraFly.active=e;var t=this,i=this.scene.input;e?this._onKeyDown=i.on("keydown",function(e){t._attached.camera&&i.mouseover&&(e!==i.KEY_NUM_1&&e!==i.KEY_NUM_2&&e!==i.KEY_NUM_3&&e!==i.KEY_NUM_4&&e!==i.KEY_NUM_5&&e!==i.KEY_NUM_6||xeogl.scheduleTask(function(){t._fly(e)}))}):this.scene.off(this._onKeyDown),this.fire("active",this._active=e)}},get:function(){return this._active}}},_fly:function(e){var t=this.scene.input,i=this.scene.worldBoundary,r=i.aabb,s=i.center,n=xeogl.math.getAABB3Diag(r);this._fitFOV=55;var a=Math.abs(n/Math.tan(this._fitFOV/2));switch(e){case t.KEY_NUM_1:this._cameraFly.flyTo({look:s,eye:[s[0]-a,s[1],s[2]],up:[0,1,0]});break;case t.KEY_NUM_2:this._cameraFly.flyTo({look:s,eye:[s[0],s[1],s[2]+a],up:[0,1,0]});break;case t.KEY_NUM_3:this._cameraFly.flyTo({look:s,eye:[s[0]+a,s[1],s[2]],up:[0,1,0]});break;case t.KEY_NUM_4:this._cameraFly.flyTo({look:s,eye:[s[0],s[1],s[2]-a],up:[0,1,0]});break;case t.KEY_NUM_5:this._cameraFly.flyTo({look:s,eye:[s[0],s[1]-a,s[2]],up:[0,0,-1]});break;case t.KEY_NUM_6:this._cameraFly.flyTo({look:s,eye:[s[0],s[1]+a,s[2]],up:[0,0,1]})}},_getJSON:function(){var e={active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";xeogl.KeyboardRotateCamera=xeogl.Component.extend({type:"xeogl.KeyboardRotateCamera",_init:function(e){this._onTick=null,this.camera=e.camera,this.active=!1!==e.active,this.sensitivity=e.sensitivity},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(e){e=!!e,this._firstPerson=e,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i=this;this._onTick=this.scene.on("tick",function(e){var r=i._attached.camera;if(r&&t.mouseover){var s=e.deltaTime,n=.3*i._sensitivity,a=.3*i._sensitivity;if(!t.ctrlDown&&!t.altDown){var o=t.keyDown[t.KEY_LEFT_ARROW],h=t.keyDown[t.KEY_RIGHT_ARROW],l=t.keyDown[t.KEY_UP_ARROW],c=t.keyDown[t.KEY_DOWN_ARROW];if(o||h||l||c){var u=0,d=0;h?u=-s*n:o&&(u=s*n),c?d=s*a:l&&(d=-s*a),Math.abs(u)>Math.abs(d)?d=0:u=0,0!==u&&r.view.rotateEyeY(u),0!==d&&r.view.rotateEyeX(d)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardPanCamera=xeogl.Component.extend({type:"xeogl.KeyboardPanCamera",_init:function(e){this._onTick=null,this.camera=e.camera,this.sensitivity=e.sensitivity,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i=this;this._onTick=this.scene.on("tick",function(e){var r=i._attached.camera;if(r&&t.mouseover){var s=e.deltaTime;if(!t.ctrlDown&&!t.altDown){var n=t.keyDown[t.KEY_W],a=t.keyDown[t.KEY_S],o=t.keyDown[t.KEY_A],h=t.keyDown[t.KEY_D],l=t.keyDown[t.KEY_Z],c=t.keyDown[t.KEY_X];if(n||a||o||h||c||l){var u=0,d=0,f=0,_=.01*i._sensitivity;a?d=s*_:n&&(d=-s*_),h?u=s*_:o&&(u=-s*_),c?f=s*_:l&&(f=-s*_),r.view.pan([u,d,f])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardZoomCamera=xeogl.Component.extend({type:"xeogl.KeyboardZoomCamera",_init:function(e){this._onTick=null,this.camera=e.camera,this.sensitivity=e.sensitivity,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i=this;this._onTick=this.scene.on("tick",function(e){var r=i._attached.camera;if(r&&t.mouseover){var s=e.deltaTime;if(!t.ctrlDown&&!t.altDown){var n=t.keyDown[t.KEY_ADD],a=t.keyDown[t.KEY_SUBTRACT];if(n||a){var o=0,h=.01*i.sensitivity;a?o=s*h:n&&(o=-s*h),r.view.zoom(o)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseRotateCamera=xeogl.Component.extend({type:"xeogl.MouseRotateCamera",_init:function(e){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=e.camera,this.sensitivity=e.sensitivity,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(e){e=!!e,this._firstPerson=e,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i,r,s,n=!1,a=!1;this._onMouseDown=t.on("mousedown",function(e){t.mouseover&&(0,0,a&&(!t.mouseDownLeft||t.mouseDownRight||t.keyDown[t.KEY_SHIFT]||t.mouseDownMiddle?n=!1:(n=!0,i=e[0],r=e[1])))},this),this._onMouseUp=t.on("mouseup",function(){n=!1,0,0}),this._onMouseEnter=t.on("mouseenter",function(){a=!0,0,0}),this._onMouseLeave=t.on("mouseleave",function(){a=!1,0,0}),this._onMouseMove=t.on("mousemove",function(e){if(a&&n){var t=(e[0]-i)*this._sensitivity,o=(e[1]-r)*this._sensitivity;i=e[0],r=e[1];var h=this._attached.camera;h&&a&&n&&(0!==t&&(s=-t*this._sensitivity,this._firstPerson?h.view.rotateLookY(s):h.view.rotateEyeY(s)),0!==o&&(s=o*this._sensitivity,this._firstPerson?h.view.rotateLookX(-s):h.view.rotateEyeX(s)))}},this)}else t.off(this._onTick),t.off(this._onMouseDown),t.off(this._onMouseUp),t.off(this._onMouseMove),t.off(this._onMouseEnter),t.off(this._onMouseLeave);this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePanCamera=xeogl.Component.extend({type:"xeogl.MousePanCamera",_init:function(e){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=e.camera,this.sensitivity=e.sensitivity,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e?.03*e:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i,r,s=0,n=0,a=!1,o=this;this._onTick=this.scene.on("tick",function(){var e=o._attached.camera;e&&(0===s&&0===n||(e.view.pan([s,n,0]),s=0,n=0))}),this._onMouseDown=t.on("mousedown",function(e){t.mouseDownLeft&&t.mouseDownRight||t.mouseDownLeft&&t.keyDown[t.KEY_SHIFT]||t.mouseDownMiddle?(i=e[0],r=e[1],a=!0):a=!1}),this._onMouseUp=t.on("mouseup",function(){a=!1}),this._onMouseUp=t.on("mouseout",function(){a=!1}),this._onMouseMove=t.on("mousemove",function(e){a&&(s+=(e[0]-i)*o._sensitivity,n+=(e[1]-r)*o._sensitivity,i=e[0],r=e[1])})}else t.off(this._onTick),t.off(this._onMouseDown),t.off(this._onMouseUp),t.off(this._onMouseMove);this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePickEntity=xeogl.Component.extend({type:"xeogl.MousePickEntity",_init:function(e){this.pickSurface=e.pickSurface,this.active=!1!==e.active},_props:{active:{set:function(e){if(this._active!==e){var t=this.scene.input;if(e){var i,r,s=this,n=!1,a=!1;this._onMouseEnter=t.on("mouseenter",function(){n=!0}),this._onMouseLeave=t.on("mouseleave",function(){n=!1}),this._onMouseDown=t.on("mousedown",function(e){n&&(a=!0,i=e[0],r=e[1])}),this._onMouseUp=t.on("mouseup",function(e){if(a&&n){if(i>=e[0]-2&&i<=e[0]+2&&r>=e[1]-2&&r<=e[1]+2){var t=s.scene.pick({canvasPos:e,pickSurface:s._pickSurface});t?s.fire("pick",t):s.fire("nopick",{canvasPos:e})}a=!1}})}else t.off(this._onMouseDown),t.off(this._onMouseUp);this.fire("active",this._active=e)}},get:function(){return this._active}},pickSurface:{set:function(e){e=!!e,this._pickSurface!==e&&(this._dirty=!1,this.fire("pickSurface",this._pickSurface=e))},get:function(){return this._pickSurface}}},_getJSON:function(){return{pickSurface:this._pickSurface,active:this._active}},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseZoomCamera=xeogl.Component.extend({type:"xeogl.MouseZoomCamera",_init:function(e){this._onTick=null,this._onMouseWheel=null,this.camera=e.camera,this.sensitivity=e.sensitivity,this.active=!1!==e.active},_props:{camera:{set:function(e){this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(e){this._sensitivity=e||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(e){if(this._active!==e){if(e){var t=0,i=0,r=!1,s=!1,n=0,a=xeogl.math.vec3(),o=xeogl.math.vec3(),h=xeogl.math.vec3(),l=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(e){0===(t=e)?(s=!1,r=!1):r=!0}),this._onTick=this.scene.on("tick",function(){var e=l._attached.camera;if(e){var c=e.view.eye,u=e.view.look;a[0]=c[0],a[1]=c[1],a[2]=c[2],o[0]=u[0],o[1]=u[1],o[2]=u[2],xeogl.math.subVec3(a,o,h);var d=Math.abs(xeogl.math.lenVec3(h)),f=l._sensitivity*(2+d/1e3);r&&(i=t*f,n=0,r=!1,s=!0),s&&(t>0?(n+=.2*f)>i&&(s=!1):t<0&&(n-=.2*f)<i&&(s=!1),s&&(e.view.zoom(n),e.project.isType("xeogl.Ortho")))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=e)}},get:function(){return this._active}}},_getJSON:function(){var e={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(e.camera=this._attached.camera.id),e},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.Cull=xeogl.Component.extend({type:"xeogl.Cull",_init:function(e){this._state=new xeogl.renderer.Cull({culled:!0}),this.culled=e.culled},_props:{culled:{set:function(e){(e=!!e)!==this._state.culled&&(this._state.culled=e,this._renderer.imageDirty=!0,this.fire("culled",this._state.culled))},get:function(){return this._state.culled}}},_compile:function(){this._renderer.cull=this._state},_getJSON:function(){return{culled:this.culled}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Visibility=xeogl.Component.extend({type:"xeogl.Visibility",_init:function(e){this._state=new xeogl.renderer.Visibility({visible:!0}),this.visible=e.visible},_props:{visible:{set:function(e){this._state.visible=!1!==e,this._renderer.imageDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(e){var t=this;if(this._state=new xeogl.renderer.Geometry({primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,hash:"",getTangents:function(){return t._tangentsDirty&&t._buildTangents(),t._tangents},getPickPositions:function(){return t._pickVBOsDirty&&t._buildPickVBOs(),t._pickPositions},getPickColors:function(){return t._pickVBOsDirty&&t._buildPickVBOs(),t._pickColors}}),this._positionsData=null,this._colorsData=null,this._normalsData=null,this._uvData=null,this._tangentsData=null,this._indicesData=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._updateScheduled=!1,this._geometryUpdateScheduled=!1,this._hashDirty=!0,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._localBoundary=null,this._boundaryDirty=!0,e.positions||e.normals||e.uv||e.indices)if((!e.primitive||"line-strip"===e.primitive)&&e.positions&&!e.indices){for(var i=[],r=0,s=e.positions.length/3;r<s;r++)i.push(r);this.primitive="line-strip",this.positions=e.positions,this.indices=i}else this.primitive=e.primitive,this.positions=e.positions,this.colors=e.colors,this.normals=e.normals,this.uv=e.uv,this.tangents=e.tangents,this.indices=e.indices;else this.primitive=e.primitive;this.autoNormals=e.autoNormals,this.usage=e.usage,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._scheduleGeometryUpdate,this),xeogl.stats.memory.meshes++},_scheduleUpdate:function(){this._updateScheduled||(this._updateScheduled=!0,xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._geometryUpdateScheduled=!0,this._update&&this._update(),this._updateScheduled=!1),this._geometryUpdateScheduled&&this._updateGeometry()},_scheduleGeometryUpdate:function(){this._geometryUpdateScheduled||(this._geometryUpdateScheduled=!0,xeogl.scheduleTask(this._updateGeometry,this))},_updateGeometry:function(){if(this._updateScheduled)this._update&&(this._geometryUpdateScheduled=!0,this._update()),this._updateScheduled=!1,this._geometryUpdateScheduled=!0;else if(!this._geometryUpdateScheduled)return;var e=this.scene.canvas.gl;switch(this._state.primitiveName){case"points":this._state.primitive=e.POINTS;break;case"lines":this._state.primitive=e.LINES;break;case"line-loop":this._state.primitive=e.LINE_LOOP;break;case"line-strip":this._state.primitive=e.LINE_STRIP;break;case"triangles":this._state.primitive=e.TRIANGLES;break;case"triangle-strip":this._state.primitive=e.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=e.TRIANGLE_FAN;break;default:this._state.primitive=e.TRIANGLES}var t=e.STATIC_DRAW,i=xeogl.stats.memory;this._positionsDirty&&(this._state.positions&&(i.positions-=this._state.positions.numItems,this._state.positions.destroy()),this._state.positions=this._positionsData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,this._positionsData,this._positionsData.length,3,t):null,this._state.positions&&(i.positions+=this._state.positions.numItems),this._positionsDirty=!1,this._pickVBOsDirty=!0),this._colorsDirty&&(this._state.colors&&(i.colors-=this._state.colors.numItems,this._state.colors.destroy()),this._state.colors=this._colorsData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,this._colorsData,this._colorsData.length,4,t):null,this._state.colors&&(i.colors+=this._state.colors.numItems),this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&(i.normals-=this._state.normals.numItems,this._state.normals.destroy()),this._autoNormals&&this._positionsData&&this._indicesData&&(this._normalsData=xeogl.math.buildNormals(this._positionsData,this._indicesData)),this._state.normals=this._normalsData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,this._normalsData,this._normalsData.length,3,t):null,this._state.normals&&(i.normals+=this._state.normals.numItems),this._normalsDirty=!1,this._tangentsDirty=!0),this._uvDirty&&(this._state.uv&&(i.uvs-=this._state.uv.numItems,this._state.uv.destroy()),this._state.uv=this._uvData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,this._uvData,this._uvData.length,2,t):null,this._state.uv&&(i.uvs+=this._state.uv.numItems),this._uvDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._state.indices&&(i.indices-=this._state.indices.numItems,this._state.indices.destroy()),this._state.indices=this._indicesData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ELEMENT_ARRAY_BUFFER,this._indicesData,this._indicesData.length,1,t):null,this._state.indices&&(i.indices+=this._state.indices.numItems),this._indicesDirty=!1,this._pickVBOsDirty=!0),this._geometryUpdateScheduled=!1,this._setBoundaryDirty()},_buildTangents:function(){if(this._tangentsDirty){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate();var e=xeogl.stats.memory;if(this._tangents&&(e.tangents-=this._tangents.numItems,this._tangents.destroy()),!this._positionsData||!this._indicesData||!this._uvData)return null;this._tangentsData=xeogl.math.buildTangents(this._positionsData,this._indicesData,this._uvData);var t=this.scene.canvas.gl,i=t.STATIC_DRAW;this._tangents=this._tangentsData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,this._tangentsData,this._tangentsData.length,3,i):null,this._tangents&&(e.tangents+=this._tangents.numItems),this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if((this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._destroyPickVBOs(),this._positionsData&&this._indicesData){var e=this.scene.canvas.gl,t=e.STATIC_DRAW,i=xeogl.math.buildPickTriangles(this._positionsData,this._indicesData),r=i.positions,s=i.colors;this._pickPositions=new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,r,r.length,3,t),this._pickColors=new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,s,s.length,4,t);var n=xeogl.stats.memory;n.positions+=this._pickPositions.numItems,n.colors+=this._pickColors.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var e=xeogl.stats.memory;this._pickPositions&&(this._pickPositions.destroy(),e.positions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),e.colors-=this._pickColors.numItems,this._pickColors=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(e){"static"!==(e=e||"static")&&"dynamic"!==e&&"stream"!==e&&(this.error("Unsupported value for 'usage': '"+e+"' - supported values are 'static', 'dynamic' and 'stream'."),e="static"),this._state.usageName=e,this._scheduleGeometryUpdate(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)},get:function(){return this._state.usageName}},primitive:{set:function(e){"points"!==(e=e||"triangles")&&"lines"!==e&&"line-loop"!==e&&"line-strip"!==e&&"triangles"!==e&&"triangle-strip"!==e&&"triangle-fan"!==e&&(this.error("Unsupported value for 'primitive': '"+e+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),e="triangles"),this._state.primitiveName!==e&&(this._state.primitiveName=e,this._scheduleGeometryUpdate(),this._hashDirty=!0,this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName))},get:function(){return this._state.primitiveName}},positions:{set:function(e){var t=!this._positionsData!=!e;e&&e.constructor!=Float32Array&&(e=new Float32Array(e)),this._positionsData=e,this._positionsDirty=!0,this._scheduleGeometryUpdate(),t&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("positions",this._positionsData),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._positionsData}},normals:{set:function(e){var t=!this._normalsData!=!e;e&&e.constructor!=Float32Array&&(e=new Float32Array(e)),this._normalsData=e,this._normalsDirty=!0,this._scheduleGeometryUpdate(),t&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire(" normals",this._normalsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._normalsData}},uv:{set:function(e){var t=!this._uvData!=!e;e&&e.constructor!=Float32Array&&(e=new Float32Array(e)),this._uvData=e,this._uvDirty=!0,this._scheduleGeometryUpdate(),t&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("uv",this._uvData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._uvData}},colors:{set:function(e){var t=!this._colorsData!=!e;e&&e.constructor!=Float32Array&&(e=new Float32Array(e)),this._colorsData=e,this._colorsDirty=!0,this._scheduleGeometryUpdate(),t&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("colors",this._colorsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._colorsData}},indices:{set:function(e){var t=!this._indicesData&&!e;if(e){var i=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(!i&&e.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");var r=i?Uint32Array:Uint16Array;e.constructor!=Uint16Array&&e.constructor!=Uint32Array&&(e=new r(e))}this._indicesData=e,this._indicesDirty=!0,this._scheduleGeometryUpdate(),t&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("indices",this._indicesData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._indicesData}},localBoundary:{get:function(){if(!this._localBoundary){var e=this;this._localBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return!!e._boundaryDirty&&(e._boundaryDirty=!1,!0)},getPositions:function(){return(e._updateScheduled||e._geometryUpdateScheduled)&&e._doUpdate(),e._positionsData}}),this._localBoundary.on("destroyed",function(){e._localBoundary=null})}return this._localBoundary}},autoNormals:{set:function(e){e=!!e,this._autoNormals!==e&&(this._autoNormals=e,this._normalsDirty=!0,this._scheduleGeometryUpdate(),this.fire("autoNormals",this._autoNormals))},get:function(){return this._autoNormals}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0))},_compile:function(){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.geometry=this._state},_makeHash:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("0"),e.colors&&t.push("1"),e.normals&&t.push("2"),e.uv&&t.push("3"),t.push(";"),e.hash=t.join("")},_getJSON:function(){return(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),{primitive:this._state.primitiveName,positions:this._positionsData,normals:this._normalsData,uv:this._uvData,colors:this._colorsData,indices:this._indicesData}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangentsData&&this._tangentsData.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.destroy(),xeogl.stats.memory.meshes--}})}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(e){this._super(e),this.center=e.center,this.xSize=e.xSize,this.ySize=e.ySize,this.zSize=e.zSize},_update:function(){var e=-this._xSize+this._center[0],t=-this._ySize+this._center[1],i=-this._zSize+this._center[2],r=this._xSize+this._center[0],s=this._ySize+this._center[1],n=this._zSize+this._center[2];this.positions=[r,s,n,e,s,n,e,t,n,r,t,n,r,s,n,r,t,n,r,t,i,r,s,i,r,s,n,r,s,i,e,s,i,e,s,n,e,s,n,e,s,i,e,t,i,e,t,n,e,t,i,r,t,i,r,t,n,e,t,n,r,t,i,e,t,i,e,s,i,r,s,i],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.tangents=null},_props:{center:{set:function(e){(this._center=this._center||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(e){e=e||1,this._xSize!==e&&(e<0&&(this.warn("negative xSize not allowed - will invert"),e*=-1),this._xSize=e,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(e){e=e||1,this._ySize!==e&&(e<0&&(this.warn("negative ySize not allowed - will invert"),e*=-1),this._ySize=e,this._scheduleUpdate(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(e){e=e||1,this._zSize!==e&&(e<0&&(this.warn("negative zSize not allowed - will invert"),e*=-1),this._zSize=e,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,ySize:this._ySize,zSize:this._zSize}}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(e){this._super(e),this.lod=e.lod,this.center=e.center,this.radius=e.radius,this.tube=e.tube,this.radialSegments=e.radialSegments,this.tubeSegments=e.tubeSegments,this.arc=e.arc},_update:function(){var e=this._center[0],t=this._center[1],i=this._center[2],r=this._radius,s=this._tube,n=Math.floor(this._radialSegments*this._lod),a=Math.floor(this._tubeSegments*this._lod),o=this._arc;n<4&&(n=4),a<4&&(a=4);var h,l,c,u,d,f,_,p,g,m,y,v,x,b,w=[],M=[],E=[],S=[];for(m=0;m<=n;m++)for(g=0;g<=a;g++)h=g/a*o,l=m/n*Math.PI*2,c=r*Math.cos(h),u=r*Math.sin(h),d=(r+s*Math.cos(l))*Math.cos(h),f=(r+s*Math.cos(l))*Math.sin(h),_=s*Math.sin(l),w.push(d+e),w.push(f+t),w.push(_+i),E.push(1-g/a),E.push(1-m/n),p=xeogl.math.normalizeVec3(xeogl.math.subVec3([d,f,_],[c,u,0],[]),[]),M.push(p[0]),M.push(p[1]),M.push(p[2]);for(m=1;m<=n;m++)for(g=1;g<=a;g++)y=(a+1)*m+g-1,v=(a+1)*(m-1)+g-1,x=(a+1)*(m-1)+g,b=(a+1)*m+g,S.push(y),S.push(v),S.push(x),S.push(x),S.push(b),S.push(y);this.positions=w,this.normals=M,this.uv=E,this.indices=S},_props:{lod:{set:function(e){e=void 0!==e?e:1,this._lod!==e&&((e<0||e>1)&&(this.warn("clamping lod to [0..1]"),e=e<0?0:1),this._lod=e,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(e){(this._center=this._center||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(e){e=e||1,this._radius!==e&&(e<0&&(this.warn("negative radius not allowed - will invert"),e*=-1),this._radius=e,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},tube:{set:function(e){e=e||.3,this._tube!==e&&(e<0&&(this.warn("negative tube not allowed - will invert"),e*=-1),this._tube=e,this._scheduleUpdate(),this.fire("tube",this._tube))},get:function(){return this._tube}},radialSegments:{set:function(e){e=e||32,this._radialSegments!==e&&(e<0&&(this.warn("negative radialSegments not allowed - will invert"),e*=-1),this._radialSegments=e,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},tubeSegments:{set:function(e){e=e||24,this._tubeSegments!==e&&(e<0&&(this.warn("negative tubeSegments not allowed - will invert"),e*=-1),this._tubeSegments=e,this._scheduleUpdate(),this.fire("tubeSegments",this._tubeSegments))},get:function(){return this._tubeSegments}},arc:{set:function(e){e=e||2*Math.PI,this._arc!==e&&(e<0&&(this.warn("negative arc not allowed - will invert"),e*=-1),this._arc=e,this._scheduleUpdate(),this.fire("arc",this._arc))},get:function(){return this._arc}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,tube:this._tube,radialSegments:this._radialSegments,tubeSegments:this._tubeSegments,arc:this._arc}}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(e){this._super(e),this.lod=e.lod,this.center=e.center,this.radius=e.radius,this.heightSegments=e.heightSegments,this.widthSegments=e.widthSegments},_update:function(){var e=this._radius,t=Math.floor(this._lod*this._heightSegments),i=Math.floor(this._lod*this._widthSegments);t<18&&(t=18),i<18&&(i=18);var r,s,n,a,o,h,l,c,u,d,f,_,p,g,m=[],y=[],v=[],x=[],b=this._center[0],w=this._center[1],M=this._center[2];for(r=0;r<=t;r++)for(n=r*Math.PI/t,a=Math.sin(n),o=Math.cos(n),s=0;s<=i;s++)h=2*s*Math.PI/i,l=Math.sin(h),c=Math.cos(h)*a,u=o,d=l*a,f=1-s/i,_=1-r/t,y.push(c),y.push(u),y.push(d),v.push(f),v.push(_),m.push(b+e*c),m.push(w+e*u),m.push(M+e*d);for(r=0;r<t;r++)for(s=0;s<i;s++)g=(p=r*(i+1)+s)+i+1,x.push(p+1),x.push(g+1),x.push(g),x.push(p+1),x.push(g),x.push(p);this.positions=m,this.normals=y,this.uv=v,this.indices=x},_props:{lod:{set:function(e){e=void 0!==e?e:1,this._lod!==e&&((e<0||e>1)&&(this.warn("clamping lod to [0..1]"),e=e<0?0:1),this._lod=e,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(e){(this._center=this._center||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(e){e=e||1,this._radius!==e&&(e<0&&(this.warn("negative radius not allowed - will invert"),e*=-1),this._radius=e,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},heightSegments:{set:function(e){e=e||18,this._heightSegments!==e&&(e<0&&(this.warn("negative heightSegments not allowed - will invert"),e*=-1),this._heightSegments=e,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},widthSegments:{set:function(e){e=e||24,this._widthSegments!==e&&(e<0&&(this.warn("negative widthSegments not allowed - will invert"),e*=-1),this._widthSegments=e,this._scheduleUpdate(),this.fire("widthSegments",this._widthSegments))},get:function(){return this._widthSegments}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),function(){"use strict";var e;xeogl.BoundingSphereGeometry=xeogl.SphereGeometry.extend({type:"xeogl.BoundingSphereGeometry",_init:function(e){this._super(e),e.boundary?this.boundary=e.boundary:e.sphere&&(this.sphere=e.sphere)},_props:{boundary:{set:function(e){var t=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:e,sceneDefault:!1,on:{updated:function(){t||(t=!0,xeogl.scheduleTask(function(){i._setFromSphere(i._attached.boundary.sphere),t=!1}))}},onAttached:function(){i._setFromSphere(i._attached.boundary.sphere)}})},get:function(){return this._attached.boundary}},sphere:{set:function(e){e&&(this._attached.boundary&&(this.boundary=null),this._setFromSphere(e))}}},_setFromSphere:(e=xeogl.math.vec3(),function(t){e[0]=t[0],e[1]=t[1],e[2]=t[2],this.center=e,this.radius=t[4]})})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(e){this._super(e),this.primitive=e.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],e.boundary?this.boundary=e.boundary:e.obb?this.obb=e.obb:e.positions?this.positions=e.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(e){var t=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:e,sceneDefault:!1,on:{updated:function(){t||(t=!0,xeogl.scheduleTask(function(){i._setPositionsFromOBB(i._attached.boundary.obb),t=!1}))}},onAttached:function(){i._setPositionsFromOBB(i._attached.boundary.obb)}})},get:function(){return this._attached.boundary}},obb:{set:function(e){e&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(e))}}},_setPositionsFromOBB:function(e){this.positions=[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10],e[12],e[13],e[14],e[16],e[17],e[18],e[20],e[21],e[22],e[24],e[25],e[26],e[28],e[29],e[30]]},_getJSON:function(){var e={};return this._attached.boundary?e.boundary=this._attached.boundary.id:this.positions&&(e.positions=this.positions),e}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(e){this._super(e),this.primitive=e.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],e.boundary?this.boundary=e.boundary:e.aabb?this.aabb=e.aabb:e.positions?this.positions=e.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(e){var t=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:e,sceneDefault:!1,on:{updated:function(){t||(t=!0,xeogl.scheduleTask(function(){i._setPositionsFromAABB(i._attached.boundary.aabb),t=!1}))}},onAttached:function(){i._setPositionsFromAABB(i._attached.boundary.aabb)}})},get:function(){return this._attached.boundary}},aabb:{set:function(e){e&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromAABB(e))}}},_setPositionsFromAABB:function(e){this.positions=[e[3],e[4],e[5],e[3],e[1],e[5],e[0],e[1],e[5],e[0],e[4],e[5],e[3],e[4],e[2],e[3],e[1],e[2],e[0],e[1],e[2],e[0],e[4],e[2]]},_getJSON:function(){var e={};return this._attached.boundary?e.boundary=this._attached.boundary.id:this.positions&&(this.positions=this.positions),e}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(e){this._super(e),this.path=e.path,this.divisions=e.divisions},_update:function(){var e=this._attached.path;if(e){var t,i,r,s=e.getPoints(this._divisions),n=[];for(t=0,i=s.length;t<i;t++)r=s[t],n.push(r[0]),n.push(r[1]),n.push(r[2]);var a=[];for(t=0,i=s.length-1;t<i;t++)a.push(t),a.push(t+1);this.primitive="lines",this.positions=n,this.indices=a,this.normals=null,this.uv=null}},_props:{path:{set:function(e){this._attach({name:"path",type:"xeogl.Curve",component:e,sceneDefault:!1,on:{curves:{callback:this._scheduleUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(e){e=e||6,this._divisions=e,this._scheduleUpdate(),this.fire("divisions",this._divisions)},get:function(){return this._divisions}}},_getJSON:function(){var e={divisions:this._divisions};return this._attached.path&&(e.path=this._attached.path.id),e}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(e){this._super(e),this.center=e.center,this.lod=e.lod,this.center=e.center,this.radiusTop=e.radiusTop,this.radiusBottom=e.radiusBottom,this.height=e.height,this.radialSegments=e.radialSegments,this.heightSegments=e.heightSegments,this.openEnded=e.openEnded},_update:function(){var e=this._center[0],t=this._center[1],i=this._center[2],r=this._radiusTop,s=this._radiusBottom,n=this._height,a=Math.floor(this._radialSegments*this._lod),o=Math.floor(this._heightSegments*this._lod);a<3&&(a=3),o<1&&(o=1);var h,l,c,u,d,f,_,p,g,m,y,v,x=this._openEnded,b=n/2,w=n/o,M=2*Math.PI/a,E=1/a,S=(r-s)/o,C=[],D=[],k=[],T=[],B=(90-180*Math.atan(n/(s-r))/Math.PI)/90;for(h=0;h<=o;h++)for(d=r-h*S,f=b-h*w,l=0;l<=a;l++)c=Math.sin(l*M),u=Math.cos(l*M),D.push(d*c),D.push(B),D.push(d*u),k.push(l*E),k.push(1-1*h/o),C.push(d*c+e),C.push(f+t),C.push(d*u+i);for(h=0;h<o;h++)for(l=0;l<=a;l++)g=(p=h*(a+1)+l)+a,T.push(p),T.push(g),T.push(g+1),T.push(p),T.push(g+1),T.push(p+1);if(!x&&r>0){for(m=C.length/3,D.push(0),D.push(1),D.push(0),k.push(.5),k.push(.5),C.push(0+e),C.push(b+t),C.push(0+i),l=0;l<=a;l++)c=Math.sin(l*M),u=Math.cos(l*M),y=.5*Math.sin(l*M)+.5,v=.5*Math.cos(l*M)+.5,D.push(r*c),D.push(1),D.push(r*u),k.push(y),k.push(v),C.push(r*c+e),C.push(b+t),C.push(r*u+i);for(l=0;l<a;l++)_=m,p=m+1+l,T.push(p),T.push(p+1),T.push(_)}if(!x&&s>0){for(m=C.length/3,D.push(0),D.push(-1),D.push(0),k.push(.5),k.push(.5),C.push(0+e),C.push(0-b+t),C.push(0+i),l=0;l<=a;l++)c=Math.sin(l*M),u=Math.cos(l*M),y=.5*Math.sin(l*M)+.5,v=.5*Math.cos(l*M)+.5,D.push(s*c),D.push(-1),D.push(s*u),k.push(y),k.push(v),C.push(s*c+e),C.push(0-b+t),C.push(s*u+i);for(l=0;l<a;l++)_=m,p=m+1+l,T.push(_),T.push(p+1),T.push(p)}this.positions=C,this.normals=D,this.uv=k,this.indices=T},_props:{lod:{set:function(e){e=void 0!==e?e:1,this._lod!==e&&((e<0||e>1)&&(this.warn("clamping lod to [0..1]"),e=e<0?0:1),this._lod=e,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(e){(this._center=this._center||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radiusTop:{set:function(e){e=void 0!==e?e:1,this._radiusTop!==e&&(e<0&&(this.warn("negative radiusTop not allowed - will invert"),e*=-1),this._radiusTop=e,this._scheduleUpdate(),this.fire("radiusTop",this._radiusTop))},get:function(){return this._radiusTop}},radiusBottom:{set:function(e){e=void 0!==e?e:1,this._radiusBottom!==e&&(e<0&&(this.warn("negative radiusBottom not allowed - will invert"),e*=-1),this._radiusBottom=e,this._scheduleUpdate(),this.fire("radiusBottom",this._radiusBottom))},get:function(){return this._radiusBottom}},height:{set:function(e){e=e||1,this._height!==e&&(e<0&&(this.warn("negative height not allowed - will invert"),e*=-1),this._height=e,this._scheduleUpdate(),this.fire("height",this._height))},get:function(){return this._height}},radialSegments:{set:function(e){e=e||60,this._radialSegments!==e&&(e<0&&(this.warn("negative radialSegments not allowed - will invert"),e*=-1),this._radialSegments=e,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},heightSegments:{set:function(e){e=e||1,this._heightSegments!==e&&(e<0&&(this.warn("negative heightSegments not allowed - will invert"),e*=-1),this._heightSegments=e,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},openEnded:{set:function(e){e=void 0!==e&&e,this._openEnded!==e&&(this._openEnded=e,this._scheduleUpdate(),this.fire("openEnded",this._openEnded))},get:function(){return this._openEnded}}},_getJSON:function(){return{center:this._center.slice(),radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(e){this._super(e),this.center=e.center,this.xSize=e.xSize,this.zSize=e.zSize,this.xSegments=e.xSegments,this.zSegments=e.zSegments,this.lod=e.lod,this.autoNormals=!1!==e.autoNormals},_update:function(){var e=this._center[0],t=this._center[1],i=this._center[2],r=this._xSize,s=this._zSize,n=Math.floor(this._lod*this._xSegments),a=Math.floor(this._lod*this._zSegments);a<1&&(a=1),a<1&&(a=1);var o,h,l,c,u,d,f,_=r/2,p=s/2,g=Math.floor(n)||1,m=Math.floor(a)||1,y=g+1,v=m+1,x=r/g,b=s/m,w=new Float32Array(y*v*3),M=new Float32Array(y*v*3),E=new Float32Array(y*v*2),S=0,C=0;for(o=0;o<v;o++){var D=o*b-p;for(h=0;h<y;h++)l=h*x-_,w[S]=l+e,w[S+1]=t,w[S+2]=-D+i,M[S+2]=-1,E[C]=(g-h)/g,E[C+1]=(m-o)/m,S+=3,C+=2}S=0;var k=new(w.length/3>65535?Uint32Arraz:Uint16Array)(g*m*6);for(o=0;o<m;o++)for(h=0;h<g;h++)c=h+y*o,u=h+y*(o+1),d=h+1+y*(o+1),f=h+1+y*o,k[S]=f,k[S+1]=u,k[S+2]=c,k[S+3]=f,k[S+4]=d,k[S+5]=u,S+=6;this.positions=w,this.normals=M,this.uv=E,this.indices=k},_props:{lod:{set:function(e){e=void 0!==e?e:1,this._lod!==e&&((e<0||e>1)&&(this.warn("clamping lod to [0..1]"),e=e<0?0:1),this._lod=e,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(e){(this._center=this._center||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(e){e=e||1,this._xSize!==e&&(e<0&&(this.warn("negative xSize not allowed - will invert"),e*=-1),this._xSize=e,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},zSize:{set:function(e){e=e||1,this._zSize!==e&&(e<0&&(this.warn("negative zSize not allowed - will invert"),e*=-1),this._zSize=e,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(e){e=e||1,this._xSegments!==e&&(e<0&&(this.warn("negative xSegments not allowed - will invert"),e*=-1),this._xSegments=e,this._scheduleUpdate(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},zSegments:{set:function(e){e=e||1,this._zSegments!==e&&(e<0&&(this.warn("negative zSegments not allowed - will invert"),e*=-1),this._zSegments=e,this._scheduleUpdate(),this.fire("zSegments",this._zSegments))},get:function(){return this._zSegments}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,zSize:this._zSize,xSegments:this._xSegments,zSegments:this._zSegments}}})}(),function(){"use strict";xeogl.LatheGeometry=xeogl.Geometry.extend({type:"xeogl.LatheGeometry",_init:function(e){this._super(e),this.points=e.points,this.segments=e.segments,this.phiStart=e.phiStart,this.phiLength=e.phiLength,this.lod=e.lod,this.autoNormals=!1!==e.autoNormals},_update:function(){var e=[],t=[],i=Math.floor(this._lod*this._segments);i<4&&(i=4);for(var r=this._phiStart*xeogl.math.DEGTORAD,s=this._phiLength*xeogl.math.DEGTORAD,n=this._points,a=(n.length,1/i),o=0,h=i;o<=h;o++)for(var l=r+o*a*s,c=Math.cos(l),u=Math.sin(l),d=0,f=n.length;d<f;d++){var _=n[d];e.push(c*_[0]-u*_[1]),e.push(u*_[0]+c*_[1]),e.push(_[2])}var p=n.length;for(o=0,h=i;o<h;o++)for(d=0,f=n.length-1;d<f;d++){var g=d+p*o,m=g,y=g+p,v=(c=g+1+p,g+1);t.push(v),t.push(y),t.push(m),t.push(v),t.push(c),t.push(y)}this.positions=e,this.indices=t},_props:{points:{set:function(e){this._points=e||[],this._scheduleUpdate(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(e){e=void 0!==e?e:1,this._lod!==e&&((e<0||e>1)&&(this.warn("clamping lod to [0..1]"),e=e<0?0:1),this._lod=e,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(e){e=e||0,this._phiStart!==e&&(e<0&&(this.warn("negative phiStart not allowed - will invert"),e*=-1),this._phiStart=e,this._scheduleUpdate(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(e){e=e||1,this._phiLength!==e&&(e<0&&(this.warn("negative phiLength not allowed - will invert"),e*=-1),this._phiLength=e,this._scheduleUpdate(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(e){e=Math.floor(e||4),this._segments!==e&&(e<0&&(this.warn("negative segments not allowed - will invert"),e*=-1),this._segments=e,this._scheduleUpdate(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(e){var t,i,r,s,n,a,o,h,l,c,u=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(e){u.enabled&&("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?u.ctrlDown=!0:e.altKey?u.altDown=!0:(u.keyDown[e.keyCode]=!0,u.fire("keydown",e.keyCode,!0))),u.mouseover&&e.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(e){u.enabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?u.ctrlDown=!1:e.altKey?u.altDown=!1:(u.keyDown[e.keyCode]=!1,u.fire("keyup",e.keyCode,!0)))}),e.element.addEventListener("mouseenter",this._mouseDownListener=function(e){if(u.enabled){u.mouseover=!0;var t=u._getClickCoordsWithinElement(e);u.fire("mouseenter",t,!0)}}),e.element.addEventListener("mouseleave",this._mouseDownListener=function(e){if(u.enabled){u.mouseover=!1;var t=u._getClickCoordsWithinElement(e);u.fire("mouseleave",t,!0)}}),document.addEventListener("mousedown",this._mouseDownListener=function(e){if(u.enabled){switch(e.which){case 1:u.mouseDownLeft=!0;break;case 2:u.mouseDownMiddle=!0;break;case 3:u.mouseDownRight=!0}var t=u._getClickCoordsWithinElement(e);u.fire("mousedown",t,!0),u.mouseover&&e.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(e){if(u.enabled){switch(e.which){case 1:u.mouseDownLeft=!1;break;case 2:u.mouseDownMiddle=!1;break;case 3:u.mouseDownRight=!1}var t=u._getClickCoordsWithinElement(e);u.fire("mouseup",t,!0),u.mouseover&&e.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(e){if(u.enabled){switch(e.which){case 1:u.mouseDownLeft=!1,u.mouseDownRight=!1;break;case 2:u.mouseDownMiddle=!1;break;case 3:u.mouseDownLeft=!1,u.mouseDownRight=!1}var t=u._getClickCoordsWithinElement(e);u.fire("dblclick",t,!0),u.mouseover&&e.preventDefault()}}),document.addEventListener("mousemove",this._mouseMoveListener=function(e){if(u.enabled){var t=u._getClickCoordsWithinElement(e);u.fire("mousemove",t,!0),u.mouseover&&e.preventDefault()}}),e.element.addEventListener("wheel",this._mouseWheelListener=function(e,t){if(u.enabled){var i=Math.max(-1,Math.min(1,40*-e.deltaY));u.fire("mousewheel",i,!0),u.mouseover&&e.preventDefault()}}),u.on("mousedown",function(e){t=e[0],i=e[1]}),u.on("mouseup",function(e){t>=e[0]-2&&t<=e[0]+2&&i>=e[1]-2&&i<=e[1]+2&&u.fire("mouseclicked",e,!0)}),n={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},a=xeogl.math.vec3(),o=xeogl.math.vec3(),h={orientation:null,orientationAngle:0},l={orientationAngle:0,acceleration:null,accelerationIncludingGravity:o,rotationRate:xeogl.math.vec3(),interval:0},c={alpha:0,beta:0,gamma:0,absolute:!1},window.OrientationChangeEvent?window.addEventListener("orientationchange",u._orientationchangedListener=function(){r=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=r&&n[r]||0,h.orientation=r,h.orientationAngle=s,u.fire("orientationchange",h)},!1):u.warn("Browser event not supported: orientationchange"),window.DeviceMotionEvent?window.addEventListener("devicemotion",u._deviceMotionListener=function(e){l.interval=e.interval,l.orientationAngle=s;var t=e.acceleration;t?(a[0]=t.x,a[1]=t.y,a[2]=t.z,l.acceleration=a):l.acceleration=null;var i=e.accelerationIncludingGravity;i?(o[0]=i.x,o[1]=i.y,o[2]=i.z,l.accelerationIncludingGravity=o):l.accelerationIncludingGravity=null,l.rotationRate=e.rotationRate,u.fire("devicemotion",l)},!1):u.warn("Browser event not supported: devicemotion"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",u._deviceOrientListener=function(e){c.gamma=e.gamma,c.beta=e.beta,c.alpha=e.alpha,c.absolute=e.absolute,u.fire("deviceorientation",c)},!1):u.warn("Browser event not supported: deviceorientation")},_getClickCoordsWithinElement:function(e){var t=[0,0];if(e){for(var i=e.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-s}else e=window.event,t.x=e.x,t.y=e.y;return t},setEnabled:function(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";xeogl.Lights=xeogl.Component.extend({type:"xeogl.Lights",_init:function(e){this._state=new xeogl.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=e.lights},_props:{lights:{set:function(e){var t,i,r;for(e=e||[],i=0,r=this._lights.length;i<r;i++)(t=this._lights[i]).off(this._dirtySubs[i]),t.off(this._destroyedSubs[i]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var s=this;function n(){s.fire("dirty",!0)}function a(){for(var e=this.id,t=0,i=s._lights.length;t<i;t++)if(s._lights[t].id===e)return s._lights=s._lights.slice(t,t+1),s._dirtySubs=s._dirtySubs.slice(t,t+1),s._destroyedSubs=s._destroyedSubs.slice(t,t+1),s._dirty=!0,s.fire("dirty",!0),void s.fire("lights",s._lights)}for(i=0,r=e.length;i<r;i++){if(t=e[i],xeogl._isNumeric(t)||xeogl._isString(t)){var o=t;if(!(t=this.scene.components[o])){this.error("Component not found: "+xeogl._inQuotes(o));continue}}var h=t.type;"xeogl.AmbientLight"===h||"xeogl.DirLight"===h||"xeogl.PointLight"===h?(this._lights.push(t),this._dirtySubs.push(t.on("dirty",n)),this._destroyedSubs.push(t.on("destroyed",a))):this.error("Component "+xeogl._inQuotes(t.id)+" is not an xeogl.AmbientLight, xeogl.DirLight or xeogl.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}}},_compile:function(){var e=this._state;if(this._dirty){e.lights=[];for(var t=0,i=this._lights.length;t<i;t++)e.lights.push(this._lights[t]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=e},_makeHash:function(){var e=this._state.lights;if(0===e.length)return";";for(var t,i=[],r=0,s=e.length;r<s;r++)t=e[r],i.push(t.type),i.push("world"===t.space?"w":"v");i.push(";"),this._state.hash=i.join("")},_getJSON:function(){for(var e=[],t=0,i=this._lights.length;t<i;t++)e.push(this._lights[t].id);return{lights:e}},_destroy:function(){var e,t,i;for(e=0,t=this._lights.length;e<t;e++)(i=this._lights[e]).off(this._dirtySubs[e]),i.off(this._destroyedSubs[e]);this._state.destroy()}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(e){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity},_props:{color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(e){this._state.intensity=void 0!==e?e:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(e){this._state={type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:"view"},this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.space=e.space},_props:{dir:{set:function(e){this._state.dir.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(e){this._state.space=e||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(e){this._state={type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view"},this.pos=e.pos,this.color=e.color,this.intensity=e.intensity,this.constantAttenuation=e.constantAttenuation,this.linearAttenuation=e.linearAttenuation,this.quadraticAttenuation=e.quadraticAttenuation,this.space=e.space},_props:{pos:{set:function(e){this._state.pos.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(e){this._state.attenuation[0]=e||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(e){this._state.attenuation[1]=e||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(e){this._state.attenuation[2]=e||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(e){this._state.space=e||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";xeogl.Model=xeogl.Component.extend({type:"xeogl.Model",_init:function(e){this.components={},this.numComponents=0,this.types={},this._onDestroyed={},this._onWorldBoundaryUpdated={},this._aabbDirty=!0,this._dummyRootTransform=this.create({type:"xeogl.Transform",meta:"dummy"}),this.transform=e.transform,e.components&&this.add(e.components)},add:function(e){for(var t=0,i=(e=xeogl._isArray(e)?e:[e]).length;t<i;t++)this._add(e[t])},_add:function(e){var t,i,r;if(xeogl._isNumeric(e)||xeogl._isString(e)){if(this.scene.types[e]){if(s=e,!(r=this.scene.types[s]))return void this.warn("Component type not found: '"+s+"'");for(t in r)r.hasOwnProperty(t)&&this._add(r[t]);return}if(!(i=this.scene.components[e]))return void this.warn("Component not found: "+xeogl._inQuotes(e))}else if(xeogl._isObject(e)){var s=e.type||"xeogl.Component";if(!xeogl._isComponentType(s))return void this.error("Not a xeogl component type: "+s);i=new window[s](this.scene,e)}else{if(!e.type)return;i=e}if(i.scene===this.scene){if(!this.components[i.id]){this.components[i.id]=i,(r=this.types[i.type])||(r=this.types[i.type]={}),r[i.id]=i,this.numComponents++;var n=this;if(this._onDestroyed[i.id]=i.on("destroyed",function(){n._remove(i)}),i.isType("xeogl.Entity")){var a=i.transform;if(a){for(;a.parent;){if(a.id===n._dummyRootTransform.id)return;a=a.parent}a.id!==n._dummyRootTransform.id&&(a.parent=n._dummyRootTransform)}else i.transform=n._dummyRootTransform}i.worldBoundary&&(this._onWorldBoundaryUpdated[e.id]=i.worldBoundary.on("updated",this._updated,this),this._aabbDirty||this._setAABBDirty()),this.fire("added",i),this._dirty||this._scheduleUpdate()}}else this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(i.id))},_scheduleUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._dirty=!1},destroyAll:function(){this.iterate(function(e){e.destroy()})},removeAll:function(){},_remove:function(e){var t=e.id;if(e.scene===this.scene){delete this.components[t],e.off(this._onDestroyed[t]),delete this._onDestroyed[t];var i=this.types[e.type];i&&delete i[e.id],this.numComponents--,e.worldBoundary&&(e.worldBoundary.off(this._onWorldBoundaryUpdated[e.id]),delete this._onWorldBoundaryUpdated[e.id]),this._aabbDirty||this._setAABBDirty(),this.fire("removed",e),this._dirty||this._scheduleUpdate()}else this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+t+"'")},iterate:function(e,t){t=t||this;var i=this.components;for(var r in i)i.hasOwnProperty(r)&&e.call(t,i[r])},_props:{transform:{set:function(e){this._attach({name:"transform",type:"xeogl.Transform",component:e,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}},worldBoundary:{get:function(){if(!this._worldBoundary){var e=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!e._aabbDirty&&(e._buildAABB(),e._aabbDirty=!1,!0)},getAABB:function(){return e._aabb}}),this._worldBoundary.on("destroyed",function(){e._worldBoundary=null})}return this._worldBoundary}}},_transformUpdated:function(e){this._dummyRootTransform.parent=e},_updated:function(){this._aabbDirty||this._setAABBDirty()},_setAABBDirty:function(){this._aabbDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},_buildAABB:function(){this._aabb||(this._aabb=xeogl.math.AABB3());var e,t,i=1e5,r=1e5,s=1e5,n=-1e5,a=-1e5,o=-1e5,h=this.components;for(var l in h)h.hasOwnProperty(l)&&(e=h[l].worldBoundary)&&((t=e.aabb)[0]<i&&(i=t[0]),t[1]<r&&(r=t[1]),t[2]<s&&(s=t[2]),t[3]>n&&(n=t[3]),t[4]>a&&(a=t[4]),t[5]>o&&(o=t[5]));this._aabb[0]=i,this._aabb[1]=r,this._aabb[2]=s,this._aabb[3]=n,this._aabb[4]=a,this._aabb[5]=o},_destroy:function(){this.removeAll()}})}(),function(){"use strict";var e=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","scenes","animations"],t={accessors:!0,nodes:!0,meshes:!0};xeogl.glTFParser=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(e){this._rootDescription=e},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(e){var t=new RegExp("^"+window.location.protocol,"i");return!!e.match(t)}},resolvePathIfNeeded:{value:function(e){if(this._isAbsolutePath(e))return e;return/^data:/.test(e)?e:this.baseURL+e}},_resolvePathsForCategories:{value:function(e){e.forEach(function(e){var t=this.json[e];t&&Object.keys(t).forEach(function(e){var i=t[e];i.uri=this.resolvePathIfNeeded(i.uri)},this)},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(e){this._json!==e&&(this._json=e,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(e,t){var i,r=t;return(i=this.rootDescription[r])?i?i[e]:null:(console.log("ERROR:CANNOT find expected category named:"+r),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),-1!==this._state.categoryIndex&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var e=this._state.categoryState,t=e.keys;return t?(e.index++,e.keys=null,e.index>=t.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(e){return!!this.rootDescription[e]}},_handleState:{value:function(){for(var i=performance.now(),r=!0,s=e[this._state.categoryIndex],n=this.handlers[s];-1!==this._state.categoryIndex;)if(t[s])this._stepToNextCategory(),s=e[this._state.categoryIndex],n=this.handlers[s];else{var a=this._state.categoryState,o=a.keys;if(o||(s=e[this._state.categoryIndex],n=this.handlers[s],a.keys=o=Object.keys(this.rootDescription[s]),!o||0!==o.length)){var h=o[a.index],l=this.getEntryDescription(h,s);if(l){if(n&&!1===n.call(this,h,l,this._state.userInfo)){r=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),r=!1;break}}else this._stepToNextDescription()}var c=(performance.now()-i)/1e3;console.log("glTF parsed in "+c+"s"),this.handleLoadCompleted&&this.handleLoadCompleted(r)}},_loadJSONIfNeeded:{enumerable:!0,value:function(e){var t=this;if(this.json)e&&e(this.json);else{var i=this._path,r=i.lastIndexOf("/");this.baseURL=0!==r?i.substring(0,r+1):"";var s=new XMLHttpRequest;s.open("GET",i,!0),s.onreadystatechange=function(){4===s.readyState&&200===s.status&&(t.json=JSON.parse(s.responseText),e&&e(t.json))},s.send(null)}}},_buildLoader:{value:function(e){var t=this;this._loadJSONIfNeeded(function(i){t.rootDescription=i,e&&e(this)})}},_state:{value:null,writable:!0},_getEntryType:{value:function(t){for(var i=e,r=0;r<i.length;r++){if(this.rootDescription[i[r]])return i[r]}return null}},getNextCategoryIndex:{value:function(t){for(var i=t;i<e.length;i++)if(this.hasCategory(e[i]))return i;return-1}},load:{enumerable:!0,value:function(e,t){var i=this;this._buildLoader(function(r){var s=i.getNextCategoryIndex.call(i,0);-1!==s&&(i._state={userInfo:e,options:t,categoryIndex:s,categoryState:{index:"0"}},i._handleState())})}},initWithPath:{value:function(e,t){return this._idPrefix=e,this._path=t,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return void 0===this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(e,t){return this.json=e,this.baseURL=t,t||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}})}(),xeogl.GLTFLoaderUtils=Object.create(Object,{ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(e){return!!this._resources[e]}},_storeResource:{enumerable:!1,value:function(e,t){e?(this._containsResource[e]&&console.log("WARNING: resource:"+e+" is already stored, overriding"),this._resources[e]=t):console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(e){return this._resources[e]}},_loadStream:{value:function(e,t,i){function r(e,t){var i=decodeURIComponent(t);return e?atob(i):i}function s(e,t){for(var i=r(e,t),s=new ArrayBuffer(i.length),n=new Uint8Array(s),a=0;a<i.length;a++)n[a]=i.charCodeAt(a);return s}var n=/^data:(.*?)(;base64)?,(.*)$/.exec(e);if(null===n)if(t)if(e){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType=t===this.ARRAY_BUFFER?"arraybuffer":"text",a.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),a.onload=function(){200===a.status||206===a.status?i.streamAvailable(e,a.response):i.handleError(xeogl.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},a.send(null)}else i.handleError(xeogl.GLTFLoaderUtils.INVALID_PATH);else i.handleError(xeogl.GLTFLoaderUtils.INVALID_TYPE,null);else i.streamAvailable(e,function(e,t){t=void 0!==t?t:"";var i=e[1],n=!!e[2],a=e[3];switch(t){case"":case"text":return r(n,a);case"ArrayBuffer":return s(n,a);case"blob":var o=s(n,a);return new Blob([o],{type:i});case"document":return(new DOMParser).parseFromString(r(n,a),i);case"json":return JSON.parse(r(n,a));default:throw"Unhandled responseType: "+t}}(n,t))}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(e){this._resourcesStatus[e.id]?this._resourcesStatus[e.id]++:this._resourcesStatus[e.id]=1;var t=this._streamsStatus[e.uri];if(t&&"loading"===t.status)t.requests.push(e);else{this._streamsStatus[e.uri]={status:"loading",requests:[e]};var i=this,r={streamAvailable:function(e,t){i._streamsStatus[e].requests.forEach(function(e){var r=t.slice(e.range[0],e.range[1]),s=e.delegate.convert(r,e.ctx);i._storeResource(e.id,s),e.delegate.resourceAvailable(s,e.ctx),--i._resourcesStatus[e.id]},this),delete i._streamsStatus[e]},handleError:function(t,i){e.delegate.handleError(t,i)}};this._loadStream(e.uri,e.type,r)}}},_elementSizeForGLType:{value:function(e,t){var i=0;switch(t){case"SCALAR":i=1;break;case"VEC2":i=2;break;case"VEC3":i=3;break;case"VEC4":case"MAT2":i=4;break;case"MAT3":i=9;break;case"MAT4":i=16}switch(e){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*i;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*i;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*i;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(e,t,i){var r=e.bufferView,s=r.buffer,n=e.byteOffset+r.description.byteOffset,a=[n,this._elementSizeForGLType(e.componentType,e.type)*e.count+n];this._handleRequest({id:e.id,range:a,type:s.description.type,uri:s.description.uri,delegate:t,ctx:i},null)}},getBuffer:{value:function(e,t,i){var r=this._getResource(e.id);return r||(this._handleWrappedBufferViewResourceLoading(e,t,i),null)}},getFile:{value:function(e,t,i){return e.delegate=t,e.ctx=i,this._handleRequest({id:e.id,uri:e.uri,range:[0],type:"text",delegate:t,ctx:i},null),null}}}),function(){"use strict";function e(e,t,i){console.log(e+": "+t+": "+JSON.stringify(i,null,4))}var t=function(){this._entries={}};t.prototype.setEntry=function(e,t,i){e?(this._entries[e]&&console.warn("entry["+e+"] is being overwritten"),this._entries[e]=new function(e,t,i){this.entryID=e,this.object=t,this.description=i}(e,t,i)):console.error("No EntryID provided, cannot store",i)},t.prototype.getEntry=function(e){return this._entries[e]},t.prototype.clearEntries=function(){this._entries={}};var i=function(){};function r(e){var t=0;switch(e){case"SCALAR":t=1;break;case"VEC2":t=2;break;case"VEC3":t=3;break;case"VEC4":case"MAT2":t=4;break;case"MAT3":t=9;break;case"MAT4":t=16}return t}i.prototype.handleError=function(e,t){console.log("ERROR(IndicesDelegate):"+e+":"+t)},i.prototype.convert=function(e,t){return new Uint16Array(e,0,t.indices.count)},i.prototype.resourceAvailable=function(e,t){return t.geometry.indices=e,!0};var s=new i,n=function(e,t){this.indices=e,this.geometry=t},a=function(){};a.prototype.handleError=function(e,t){console.log("ERROR(VertexAttributeDelegate):"+e+":"+t)},a.prototype.convert=function(e,t){return e},a.prototype.resourceAvailable=function(e,t){var i=t.geometry,s=t.attribute,n=t.semantic;return"POSITION"===n?i.positions=new Float32Array(e,0,s.count*r(s.type)):"NORMAL"===n?i.normals=new Float32Array(e,0,s.count*r(s.type)):"TEXCOORD_0"!==n&&"TEXCOORD"!==n||(i.uv=new Float32Array(e,0,s.count*r(s.type))),i.loadedAttributes++,!0};var o=new a,h=function(e,t,i){this.attribute=e,this.semantic=t,this.geometry=i};xeogl.GLTFLoader=Object.create(xeogl.glTFParser,{setModel:{value:function(e){this.model=e}},load:{enumerable:!0,value:function(e,i,r){if(!this.model)throw"model not set";this.resources=new t,xeogl.glTFParser.handleLoadCompleted=r,xeogl.glTFParser.load.call(this,e,i)}},_makeID:{value:function(e){return this._idPrefix+"#"+e}},handlers:{value:{buffers:function(e,t,i){return this.resources.setEntry(e,null,t),t.type="ArrayBuffer",!0},bufferViews:function(e,t,i){this.resources.setEntry(e,null,t);var r=this.resources.getEntry(t.buffer);return t.type="ArrayBufferView",this.resources.getEntry(e).buffer=r,!0},accessors:function(e,t,i){return this.resources.setEntry(e,t,t),!0},textures:function(e,t,i){if(t.source){var r=this._json.images[t.source],s=new xeogl.Texture(this.model.scene,{id:this._makeID(e),src:r.uri,flipY:!0});return this.model.add(s),this.resources.setEntry(e,s,t),!0}},materials:function(e,t,i){var r,s=t.values||{},n=s.diffuse,a=s.specular,o=s.shininess,h=s.emission,l=s.transparency,c={id:this._makeID(e),meta:{userInfo:i},shininess:o,opacity:l,transparent:l<1};n&&(xeogl._isString(n)?(r=this.resources.getEntry(n))&&(c.diffuseMap=r.object):c.diffuse=n.slice(0,3)),a&&(xeogl._isString(a)?(r=this.resources.getEntry(a))&&(c.specularMap=r.object):c.specular=a.slice(0,3)),h&&(xeogl._isString(h)?(r=this.resources.getEntry(h))&&(c.emissiveMap=r.object):c.emissive=h.slice(0,3));var u=new xeogl.PhongMaterial(this.model.scene,c);return this.model.add(u),this.resources.setEntry(e,u,t),!0},lights:function(t,i,r){return e("light",t,i),!0},meshes:function(t,i,r){var a=[];this.resources.setEntry(t,a,i);var l=i.primitives;if(!l)return e("MISSING_PRIMITIVES for mesh:"+t),!1;for(var c=this._rootDescription.accessors,u=0;u<l.length;u++){var d=l[u];if(d.mode===WebGLRenderingContext.TRIANGLES){var f=new xeogl.Geometry(this.model.scene,{id:this._makeID(t)});this.model.add(f);var _=this.resources.getEntry(d.material).object;a.push({geometry:f,material:_});var p=Object.keys(d.attributes);f.totalAttributes+=p.length;var g=c[d.indices],m={bufferView:this.resources.getEntry(g.bufferView),byteOffset:g.byteOffset,count:g.count,id:d.indices,componentType:g.componentType,type:g.type},y=new n(m,f);xeogl.GLTFLoaderUtils.getBuffer(m,s,y);p.forEach(function(e){var t,i=d.attributes[e],r=(t=c[i],{bufferView:this.resources.getEntry(t.bufferView),byteOffset:t.byteOffset,byteStride:t.byteStride,count:t.count,max:t.max,min:t.min,componentType:t.componentType,type:t.type,id:i}),s=new h(r,e,f);xeogl.GLTFLoaderUtils.getBuffer(r,o,s)},this)}}return!0},cameras:function(e,t,i){return!0},scenes:function(e,t,i){var r,s,n=t.nodes;if(n)for(var a in n)n.hasOwnProperty(a)&&(r=n[a],s=null,this._parseNode(r,s))}}},_parseNode:{value:function(e,t){var i=this._json.nodes[e];if(i){var r=this.model,s=r.scene;if(i.matrix){var n=i.matrix;t=new xeogl.Transform(s,{id:this._makeID(e+".transform"),matrix:n,parent:t}),r.add(t)}if(i.translation){var a=i.translation;t=new xeogl.Translate(s,{id:this._makeID(e+".translation"),xyz:[a[0],a[1],a[2]],parent:t}),r.add(t)}if(i.rotation){var o=i.rotation;t=new xeogl.Rotate(s,{id:this._makeID(e+".rotation"),xyz:[o[0],o[1],o[2]],angle:o[3],parent:t}),r.add(t)}if(i.scale){var h=i.scale;t=new xeogl.Scale(s,{id:this._makeID(e+".scale"),xyz:[h[0],h[1],h[2]],parent:t}),r.add(t)}if(i.meshes){var l=new xeogl.Visibility(s,{id:this._makeID(e+".visibility")});r.add(l);var c=new xeogl.Cull(s,{id:this._makeID(e+".cull")});r.add(c);var u=new xeogl.Modes(s,{id:this._makeID(e+".modes")});r.add(c);var d,f,_,p,g,m,y,v,x=i.meshes,b=x.length;s.types["xeogl.Entity"];for(d=0;d<b;d++)for((f=this.resources.getEntry(x[d]))||(this.handlers.meshes.call(this,x[d],this._rootDescription.meshes[x[d]]),f=this.resources.getEntry(x[d])),_=0,p=(f=f.object).length;_<p;_++)g=f[_].material,m=f[_].geometry,y=this._makeID(e+".entity."+_),v=new xeogl.Entity(s,{id:y,meta:{name:i.name},material:g,geometry:m,transform:t,visibility:l,cull:c,modes:u,loading:!0}),r.add(v)}if(i.children){var w,M=i.children;for(_=0,p=M.length;_<p;_++)w=M[_],this._parseNode(w,t)}return!0}}}})}(),function(){"use strict";xeogl.GLTFModel=xeogl.Model.extend({type:"xeogl.GLTFModel",_init:function(e){this._super(e),this._src=null,e.src?xeogl._isString(e.src)?this.src=e.src:this.error("Value for config 'src' should be a string"):this.error("Config missing: 'src'")},_props:{src:{set:function(e){if(e)if(xeogl._isString(e))if(e!==this._src){this.destroyAll(),this._src=e;var t=xeogl.GLTFLoader;t.setModel(this),t.initWithPath(this.id,this._src);var i=this,r=i.scene.canvas.spinner;r.processes++,t.load(null,null,function(){r.processes--,i.fire("loaded")}),this.fire("src",this._src)}else this.fire("loaded");else this.error("Value for 'src' should be a string")},get:function(){return this._src}}},_getJSON:function(){var e={};return this.src&&(e.src=this._src),e},_destroy:function(){this.destroyAll()}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(e){this._state=new xeogl.renderer.PhongMaterial({type:"phongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),opacity:1,shininess:30,reflectivity:1,lineWidth:1,pointSize:1,ambientMap:null,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.opacity=e.opacity,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this.ambientMap=e.ambientMap,this.diffuseMap=e.diffuseMap,this.specularMap=e.specularMap,this.emissiveMap=e.emissiveMap,this.opacityMap=e.opacityMap,this.reflectivityMap=e.reflectivityMap,this.normalMap=e.normalMap,this.diffuseFresnel=e.diffuseFresnel,this.specularFresnel=e.specularFresnel,this.emissiveFresnel=e.emissiveFresnel,this.opacityFresnel=e.opacityFresnel,this.reflectivityFresnel=e.reflectivityFresnel},_props:{ambient:{set:function(e){this._state.ambient.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(e){this._state.diffuse.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(e){this._state.specular.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(e){this._state.emissive.set(e||[0,0,0]),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.opacity!==e&&(this._state.opacity=e,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity))},get:function(){return this._state.opacity}},shininess:{set:function(e){this._state.shininess=void 0!==e?e:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(e){this._state.lineWidth=e||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(e){this._state.pointSize=e||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(e){this._state.reflectivity=void 0!==e?e:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(e){this._attachComponent("xeogl.Texture","normalMap",e)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(e){this._attachComponent("xeogl.Texture","ambientMap",e)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(e){this._attachComponent("xeogl.Texture","diffuseMap",e)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(e){this._attachComponent("xeogl.Texture","specularMap",e)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(e){this._attachComponent("xeogl.Texture","emissiveMap",e)},get:function(){return this._attached.emissiveMap}},opacityMap:{set:function(e){this._attachComponent("xeogl.Texture","opacityMap",e)},get:function(){return this._attached.opacityMap}},reflectivityMap:{set:function(e){this._attachComponent("xeogl.Texture","reflectivityMap",e)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(e){this._attachComponent("xeogl.Reflect","reflection",e)},get:function(){return this._attached.reflection}},diffuseFresnel:{set:function(e){this._attachComponent("xeogl.Fresnel","diffuseFresnel",e)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(e){this._attachComponent("xeogl.Fresnel","specularFresnel",e)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(e){this._attachComponent("xeogl.Fresnel","emissiveFresnel",e)},get:function(){return this._attached.emissiveFresnel}},opacityFresnel:{set:function(e){this._attachComponent("xeogl.Fresnel","opacityFresnel",e)},get:function(){return this._attached.opacityFresnel}},reflectivityFresnel:{set:function(e){this._attachComponent("xeogl.Fresnel","reflectivityFresnel",e)},get:function(){return this._attached.reflectivityFresnel}}},_attachComponent:function(e,t,i){i=this._attach({name:t,type:e,component:i,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[t]=null,this._hashDirty=!0},scope:this}}}),this._state[t]=i?i._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var e=this._state,t=["/p"];e.normalMap&&(t.push("/b"),e.normalMap.matrix&&t.push("/mat")),e.ambientMap&&(t.push("/a"),e.ambientMap.matrix&&t.push("/mat")),e.diffuseMap&&(t.push("/d"),e.diffuseMap.matrix&&t.push("/mat")),e.specularMap&&(t.push("/s"),e.specularMap.matrix&&t.push("/mat")),e.emissiveMap&&(t.push("/e"),e.emissiveMap.matrix&&t.push("/mat")),e.opacityMap&&(t.push("/o"),e.opacityMap.matrix&&t.push("/mat")),e.reflectivityMap&&(t.push("/r"),e.reflectivityMap.matrix&&t.push("/mat")),e.diffuseFresnel&&t.push("/df"),e.specularFresnel&&t.push("/sf"),e.emissiveFresnel&&t.push("/ef"),e.opacityFresnel&&t.push("/of"),e.reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")},_getJSON:function(){var e={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive};1!==this._state.opacity&&(e.opacity=this._state.opacity),80!==this._state.shininess&&(e.shininess=this._state.shininess),1!==this._state.reflectivity&&(e.reflectivity=this._state.reflectivity),1!==this._state.lineWidth&&(e.lineWidth=this._state.lineWidth),1!==this._state.pointSize&&(e.pointSize=this._state.pointSize);var t=this._attached;return t.normalMap&&(e.normalMap=t.normalMap.id),t.ambientMap&&(e.ambientMap=t.ambientMap.id),t.diffuseMap&&(e.diffuseMap=t.diffuseMap.id),t.specularMap&&(e.specularMap=t.specularMap.id),t.emissiveMap&&(e.emissiveMap=t.emissiveMap.id),t.opacityMap&&(e.opacityMap=t.opacityMap.id),t.reflectivityMap&&(e.reflectivityMap=t.reflectivityMap.id),t.diffuseFresnel&&(e.diffuseFresnel=t.diffuseFresnel.id),t.specularFresnel&&(e.specularFresnel=t.specularFresnel.id),t.emissiveFresnel&&(e.emissiveFresnel=t.emissiveFresnel.id),t.opacityFresnel&&(e.opacityFresnel=t.opacityFresnel.id),t.reflectivityFresnel&&(e.reflectivityFresnel=t.reflectivityFresnel.id),e},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(e){this._state=new xeogl.renderer.Texture({texture:null,matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:null,pageTableTexture:null}),this._src=null,this._image=null,this._target=null,this._pageTable=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=e.translate,this.scale=e.scale,this.rotate=e.rotate,this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.flipY=e.flipY,e.src?this.src=e.src:e.image?this.image=e.image:e.target&&(this.target=e.target),xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src?this._srcDirty=!0:this._target&&(this._targetDirty=!0),this._scheduleUpdate()},_update:function(){var e=this.scene.canvas.gl,t=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),t.texture&&t.texture.renderBuffer&&(t.texture=null),t.texture||(t.texture=new xeogl.renderer.webgl.Texture2D(e)),t.texture.setImage(this._image,t),this._imageDirty=!1,this._propsDirty=!0),this._targetDirty&&(t.texture&&!t.texture.renderBuffer&&(t.texture.destroy(),t.texture=null),this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target&&(this._onTargetActive=this._target.on("active",function(e){t.texture=e?this._state.renderBuf.getTexture():null})),this._targetDirty=!1,this._propsDirty=!0),this._matrixDirty){var i,r;0===this._translate[0]&&0===this._translate[2]||(i=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0])),1===this._scale[0]&&1===this._scale[1]||(r=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),i=i?xeogl.math.mulMat4(i,r):r),0!==this._rotate&&(r=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),i=i?xeogl.math.mulMat4(i,r):r);var s=t.matrix;t.matrix=i,this._matrixDirty=!1,!!i!=!!s&&this.fire("dirty")}this._propsDirty&&(t.texture&&t.texture.setProps&&t.texture.setProps(t),this._propsDirty=!1),this._pageTableDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),t.texture&&t.texture.renderBuffer&&(t.texture=null),t.texture||(t.texture=new xeogl.renderer.webgl.Texture2D(e)),t.texture.setImage(this._image,t),this._imageDirty=!1,this._propsDirty=!0),this._renderer.imageDirty=!0},_loadSrc:function(e){var t=this,i=new Image,r=this.scene.canvas.spinner,s=r.textures;i.onload=function(){t._src===e&&(t._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(i),t._imageDirty=!0,t._srcDirty=!1,t._targetDirty=!1,s&&r.processes--,t._scheduleUpdate(),t.fire("image",t._image),t.fire("loaded",t._src))},i.onerror=function(){s&&r.processes--},0===e.indexOf("data")?i.src=e:(i.crossOrigin="Anonymous",i.src=e,s&&r.processes++)},_props:{image:{set:function(e){this._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(e),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._scheduleUpdate(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(e){this._image=null,this._src=e,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}},target:{set:function(e){this._image=null,this._src=null,this._target=this._attach({name:"renderBuf",type:null,component:e,sceneDefault:!0,on:{active:{callback:this._onTargetActive,scope:this}}}),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._scheduleUpdate(),this.fire("target",this._target)},get:function(){return this._attached.target}},pageTable:{set:function(e){this._pageTable=e,this._imageDirty=!0,this.fire("pageTable",this._pageTable)},get:function(){return this._state._pageTable}},translate:{set:function(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("rotate",this._rotate))},get:function(){return this._rotate}},minFilter:{set:function(e){"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"linearMipmapLinear"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),this._state.minFilter=e,this._propsDirty=!0,this._scheduleUpdate(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(e){"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),this._state.magFilter=e,this._propsDirty=!0,this._scheduleUpdate(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(e){"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),this._state.wrapS=e,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(e){"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),this._state.wrapT=e,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(e){e=!!e,this._state.flipY!==e&&(this._state.flipY=e,this._imageDirty=!0,this._scheduleUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var e={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(e.translate=this._translate),!this._scale||1===this._scale[0]&&1===this._scale[1]||(e.scale=this._scale),0!==this._rotate&&(e.rotate=this._rotate),"linearMipmapLinear"!==this._state.minFilter&&(e.minFilter=this._state.minFilter),"linear"!==this._state.magFilter&&(e.magFilter=this._state.magFilter),"repeat"!==this._state.wrapS&&(e.wrapS=this._state.wrapS),"repeat"!==this._state.wrapT&&(e.wrapT=this._state.wrapT),!1!==this._state.flipY&&(e.flipY=this._state.flipY),this._src?e.src=this._src:this._target?e.target=this._target.id:this._image,e},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(e){this._state=new xeogl.renderer.Fresnel({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=e.edgeColor,this.centerColor=e.centerColor,this.edgeBias=e.edgeBias,this.centerBias=e.centerBias,this.power=e.power},_props:{edgeColor:{set:function(e){this._state.edgeColor.set(e||[0,0,0]),this._renderer.imageDirty=!0,this.fire("edgeColor",this._state.edgeColor)},get:function(){return this._state.edgeColor}},centerColor:{set:function(e){this._state.centerColor.set(e||[1,1,1]),this._renderer.imageDirty=!0,this.fire("centerColor",this._state.centerColor)},get:function(){return this._state.centerColor}},edgeBias:{set:function(e){this._state.edgeBias=e||0,this._renderer.imageDirty=!0,this.fire("edgeBias",this._state.edgeBias)},get:function(){return this._state.edgeBias}},centerBias:{set:function(e){this._state.centerBias=void 0!==e&&null!==e?e:1,this._renderer.imageDirty=!0,this.fire("centerBias",this._state.centerBias)},get:function(){return this._state.centerBias}},power:{set:function(e){this._state.power=void 0!==e&&null!==e?e:1,this._renderer.imageDirty=!0,this.fire("power",this._state.power)},get:function(){return this._state.power}}},_getJSON:function(){return{edgeColor:this._state.edgeColor,centerColor:this._state.centerColor,edgeBias:this._state.edgeBias,centerBias:this._state.centerBias,power:this._state.power}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Reflect=xeogl.Component.extend({type:"xeogl.Reflect",_init:function(e){this._state=new xeogl.renderer.Reflect({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.src=e.src,xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.reflect=null,this._images?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._scheduleUpdate()},_update:function(){var e=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);this._imageDirty&&this._images&&(e.reflect.setImage(this._image),this._imageDirty=!1,this._propsDirty=!0),this._renderer.imageDirty=!0},_loadSrc:function(e){var t=this,i=new Image;i.onload=function(){t._src===e&&(t._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(i),t._imageDirty=!0,t._srcDirty=!1,t._targetDirty=!1,t._scheduleUpdate(),t.fire("image",t._image),t.fire("loaded",t._src))},i.onerror=function(){},0===e.indexOf("data")?i.src=e:(i.crossOrigin="Anonymous",i.src=e)},_props:{src:{set:function(e){this._image=null,this._src=e,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}}},_getJSON:function(){return{src:this._src.slice(0)}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Entity=xeogl.Component.extend({type:"xeogl.Entity",_init:function(e){this._loading=e.loading,!0===this._loading&&this.scene.canvas.spinner.processes++,this.camera=e.camera,this.clips=e.clips,this.colorTarget=e.colorTarget,this.colorBuf=e.colorBuf,this.depthTarget=e.depthTarget,this.depthBuf=e.depthBuf,this.visibility=e.visibility,this.cull=e.cull,this.modes=e.modes,this.geometry=e.geometry,this.layer=e.layer,this.lights=e.lights,this.material=e.material,this.morphTargets=e.morphTargets,this.reflect=e.reflect,this.shader=e.shader,this.shaderParams=e.shaderParams,this.stage=e.stage,this.transform=e.transform,this.billboard=e.billboard,this.stationary=e.stationary,this.viewport=e.viewport,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(e){this._setViewBoundaryDirty(),this._attach({name:"camera",type:"xeogl.Camera",component:e,sceneDefault:!0,on:{viewMatrix:{callback:this._setViewBoundaryDirty,scope:this},projMatrix:{callback:this._setCanvasBoundaryDirty,scope:this}}})},get:function(){return this._attached.camera}},clips:{set:function(e){this._attach({name:"clips",type:"xeogl.Clips",component:e,sceneDefault:!0})},get:function(){return this._attached.clips}},colorTarget:{set:function(e){this._attach({name:"colorTarget",type:"xeogl.ColorTarget",component:e,sceneDefault:!0})},get:function(){return this._attached.colorTarget}},colorBuf:{set:function(e){this._attach({name:"colorBuf",type:"xeogl.ColorBuf",component:e,sceneDefault:!0})},get:function(){return this._attached.colorBuf}},depthTarget:{set:function(e){this._attach({name:"depthTarget",type:"xeogl.DepthTarget",component:e,sceneDefault:!0})},get:function(){return this._attached.depthTarget}},depthBuf:{set:function(e){this._attach({name:"depthBuf",type:"xeogl.DepthBuf",component:e,sceneDefault:!0})},get:function(){return this._attached.depthBuf}},visibility:{set:function(e){this._attach({name:"visibility",type:"xeogl.Visibility",component:e,sceneDefault:!0})},get:function(){return this._attached.visibility}},cull:{set:function(e){this._attach({name:"cull",type:"xeogl.Cull",component:e,sceneDefault:!0})},get:function(){return this._attached.cull}},modes:{set:function(e){this._attach({name:"modes",type:"xeogl.Modes",component:e,sceneDefault:!0})},get:function(){return this._attached.modes}},geometry:{set:function(e){this._setWorldBoundaryDirty(),this._attach({name:"geometry",type:"xeogl.Geometry",component:e,sceneDefault:!0,on:{positions:{callback:this._setWorldBoundaryDirty,scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.geometry}},layer:{set:function(e){this._attach({name:"layer",type:"xeogl.Layer",component:e,sceneDefault:!0})},get:function(){return this._attached.layer}},lights:{set:function(e){this._attach({name:"lights",type:"xeogl.Lights",component:e,sceneDefault:!0})},get:function(){return this._attached.lights}},material:{set:function(e){this._attach({name:"material",type:"xeogl.Material",component:e,sceneDefault:!0})},get:function(){return this._attached.material}},morphTargets:{set:function(e){this._attach({name:"morphTargets",type:"xeogl.MorphTargets",component:e,sceneDefault:!0})},get:function(){return this._attached.morphTargets}},reflect:{set:function(e){this._attach({name:"reflect",type:"xeogl.Reflect",component:e,sceneDefault:!0})},get:function(){return this._attached.reflect}},shader:{set:function(e){this._attach({name:"shader",type:"xeogl.Shader",component:e,sceneDefault:!0})},get:function(){return this._attached.shader}},shaderParams:{set:function(e){this._attach({name:"shaderParams",type:"xeogl.ShaderParams",component:e,sceneDefault:!0})},get:function(){return this._attached.shaderParams}},stage:{set:function(e){this._attach({name:"stage",type:"xeogl.Stage",component:e,sceneDefault:!0})},get:function(){return this._attached.stage}},transform:{set:function(e){this._setWorldBoundaryDirty(),this._attach({name:"transform",type:"xeogl.Transform",component:e,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,xeogl.scheduleTask(this._transformUpdated,this))},scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},billboard:{set:function(e){this._attach({name:"billboard",type:"xeogl.Billboard",component:e,sceneDefault:!0})},get:function(){return this._attached.billboard}},viewport:{set:function(e){this._attach({name:"viewport",type:"xeogl.Viewport",component:e,sceneDefault:!0})},get:function(){return this._attached.viewport}},stationary:{set:function(e){this._attach({name:"stationary",type:"xeogl.Stationary",component:e,sceneDefault:!0})},get:function(){return this._attached.stationary}},localBoundary:{get:function(){return this._attached.geometry.localBoundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var e=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!e._worldBoundaryDirty&&(e._worldBoundaryDirty=!1,!0)},getOBB:function(){var t=e._attached.geometry;if(t)return t.localBoundary.obb},getMatrix:function(){var t=e._attached.transform;return e._transformDirty&&(t._buildLeafMatrix(),e._setWorldBoundaryDirty(),e._transformDirty=!1),t.leafMatrix}}),this._worldBoundary.on("destroyed",function(){e._worldBoundary=null})}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var e=this;this._viewBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!e._viewBoundaryDirty&&(e._viewBoundaryDirty=!1,!0)},getOBB:function(){return e.worldBoundary.obb},getMatrix:function(){return e._attached.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){e._viewBoundary=null})}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var e=this;this._canvasBoundary=this.create({type:"xeogl.Boundary2D",getDirty:function(){return!!e._canvasBoundaryDirty&&(e._canvasBoundaryDirty=!1,!0)},getOBB:function(){return e.viewBoundary.obb},getMatrix:function(){return e._attached.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){e._canvasBoundary=null})}return this._canvasBoundary}},glsl:{get:function(){var e=this._renderer.objects[this.id];if(!e)return null;var t=e.program.program.source;return{draw:{vertex:t.vertexDraw,fragment:t.fragmentDraw},pickObject:{vertex:t.vertexPickObject,fragment:t.fragmentPickObject},pickPrimitive:{vertex:t.vertexPickPrimitive,fragment:t.fragmentPickPrimitive}}}},glslString:{get:function(){var e=this.glsl;if(e)return JSON.stringify(e,"\n",4)}}},_transformUpdated:function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setWorldBoundaryDirty(),this._transformDirty=!1)},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_valid:function(){var e=this._attached.geometry;return!this.destroyed&&e&&e.positions&&e.indices},_compile:function(){var e=this;if(!this._compiling){e._compiling=!0;var t=this._renderer.objects[this.id];t&&(t.compiled=!1);var i=function(){e._valid()?(e.__compile(),e._compiling=!1):xeogl.scheduleTask(i)};xeogl.scheduleTask(i)}},__compile:function(){var e=this._attached;e.camera._compile(),e.clips._compile(),e.colorTarget._compile(),e.colorBuf._compile(),e.depthTarget._compile(),e.depthBuf._compile(),e.visibility._compile(),e.cull._compile(),e.modes._compile(),e.geometry._compile(),e.layer._compile(),e.lights._compile(),e.material._compile(),e.reflect._compile(),e.shader._compile(),e.shaderParams._compile(),e.stage._compile(),this._renderer.modelTransform=e.transform._state,e.billboard._compile(),e.stationary._compile(),e.viewport._compile();var t=this.id,i=this._renderer.buildObject(t);this._loading&&(this.scene.canvas.spinner.processes--,this._loading=!1),i&&i.error&&this.error(i.errorLog.join("\n"))},_getJSON:function(){var e=this._attached;return{camera:e.camera.id,clips:e.clips.id,colorTarget:e.colorTarget.id,colorBuf:e.colorBuf.id,depthTarget:e.depthTarget.id,depthBuf:e.depthBuf.id,visibility:e.visibility.id,cull:e.cull.id,modes:e.modes.id,geometry:e.geometry.id,layer:e.layer.id,lights:e.lights.id,material:e.material.id,reflect:e.reflect.id,shader:e.shader.id,shaderParams:e.shaderParams.id,stage:e.stage.id,transform:e.transform.id,billboard:e.billboard.id,stationary:e.stationary.id,viewport:e.viewport.id}},_destroy:function(){this._renderer.removeObject(this.id)}})}(),function(){"use strict";xeogl.ColorBuf=xeogl.Component.extend({type:"xeogl.ColorBuf",_init:function(e){this._state=new xeogl.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=e.blendEnabled,this.colorMask=e.colorMask},_props:{blendEnabled:{set:function(e){this._state.blendEnabled=!0===e,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(e){this._state.colorMask=e||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.DepthBuf=xeogl.Component.extend({type:"xeogl.DepthBuf",_init:function(e){this._state=new xeogl.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:!0}),this.clearDepth=e.clearDepth,this.depthFunc=e.depthFunc,this.active=e.active},_props:{clearDepth:{set:function(e){this._state.clearDepth=void 0!==e?e:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(e){e=e||"less";var t=this._depthFuncNames[e];void 0===t&&(this.error("Unsupported value for 'clearFunc': '"+e+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),t="less"),this._state.depthFunc=this.scene.canvas.gl[t],this._state.depthFuncName=e,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(e){e=!1!==e,this._state.active!==e&&(this._state.active=e,this._renderer.imageDirty=!0,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Layer=xeogl.Component.extend({type:"xeogl.Layer",_init:function(e){this._state=new xeogl.renderer.Layer({priority:null}),this.priority=e.priority},_props:{priority:{set:function(e){e=e||0,(e=Math.round(e))!==this._state.priority&&(this._state.priority=e,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.ColorTarget=xeogl.Component.extend({type:"xeogl.ColorTarget",_init:function(e){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.COLOR,renderBuf:null});var t=this.scene.canvas,i=this;this._webglContextRestored=t.on("webglContextRestored",function(){i._state.renderBuf&&i._state.renderBuf.webglRestored(t.gl)}),this.size=e.size,this.active=e.active},_props:{size:{set:function(e){e=e||null,this._size=e,this._active&&this._state.renderBuf.setSize(this._size),this.fire("size",this._size)},get:function(){return this._size}},active:{set:function(e){if(e=!1!==e,this._active!==e){var t=this._state;if(this._active=e,this._active){var i=this.scene.canvas;t.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:i.canvas,gl:i.gl,size:this._size}),this._renderer.imageDirty=!0}else t.renderBuf&&(t.renderBuf.destroy(),t.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){var e={active:this._active};return this._size&&(e.size=this._size),e},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.DepthTarget=xeogl.Component.extend({type:"xeogl.DepthTarget",_init:function(e){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.DEPTH,renderBuf:null});var t=this.scene.canvas,i=this;this._webglContextRestored=t.on("webglContextRestored",function(){i._state.renderBuf&&i._state.renderBuf.webglRestored(t.gl)}),this.active=e.active},_props:{active:{set:function(e){if(e=!1!==e,this._active!==e){this._active=e;var t=this._state;if(this._active){var i=this.scene.canvas;t.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:i.canvas,gl:i.gl}),this._renderer.imageDirty=!0}else t.renderBuf&&(t.renderBuf.destroy(),t.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{active:this._active}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.Modes=xeogl.Component.extend({type:"xeogl.Modes",_init:function(e){this._state=new xeogl.renderer.Modes({pickable:null,clippable:null,transparent:null,backfaces:null,frontface:null,collidable:null}),this.pickable=e.pickable,this.clippable=e.clippable,this.transparent=e.transparent,this.backfaces=e.backfaces,this.frontface=e.frontface,this.collidable=e.collidable},_props:{pickable:{set:function(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}},clippable:{set:function(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this._renderer.imageDirty=!0,this.fire("clippable",this._state.clippable))},get:function(){return this._state.clippable}},transparent:{set:function(e){e=!!e,this._state.transparent!==e&&(this._state.transparent=e,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent))},get:function(){return this._state.transparent}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}},collidable:{set:function(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this.fire("collidable",this._state.collidable))},get:function(){return this._state.collidable}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{pickable:this._state.pickable,clippable:this._state.clippable,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface,collidable:this._state.collidable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(e){this._state=new xeogl.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary},_props:{boundary:{set:function(e){if(!this._autoBoundary){if(!e){var t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this._renderer.imageDirty=!0,this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(e){var t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_compile:function(){this._renderer.viewport=this._state},_getJSON:function(){var e={};return this._autoBoundary?e.autoBoundary=!0:e.boundary=this._state.boundary.slice(),e}})}(),function(){"use strict";xeogl.Stage=xeogl.Component.extend({type:"xeogl.Stage",_init:function(e){this._state=new xeogl.renderer.Stage({priority:null,pickable:!0}),this.priority=e.priority,this.pickable=e.pickable},_props:{priority:{set:function(e){(e=e||0)!==this._state.priority&&(e=Math.round(e),this._state.priority=e,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}},pickable:{set:function(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Shader=xeogl.Component.extend({type:"xeogl.Shader",_init:function(e){this._state=new xeogl.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=e.vertex,this.fragment=e.fragment,this.setParams(e.params)},_props:{vertex:{set:function(e){this._state.vertex=e,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(e){this._state.fragment=e,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(e){for(var t in e)e.hasOwnProperty(t)&&(this._state.params[t]=e[t]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var e={params:this._state.params};return this._state.vertex&&(e.vertex=this._state.vertex),this._state.fragment&&(e.fragment=this._state.fragment),e}})}(),function(){"use strict";xeogl.ShaderParams=xeogl.Component.extend({type:"xeogl.ShaderParams",_init:function(e){this._state=new xeogl.renderer.ShaderParams({params:{}}),this.setParams(e.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(e){for(var t in e)e.hasOwnProperty(t)&&(this._state.params[t]=e[t]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";xeogl.Boundary2D=xeogl.Component.extend({type:"xeogl.Boundary2D",_init:function(e){this._obb=null,this._aabb=e.aabb||null,this._center=e.center||null,this._getDirty=e.getDirty,this._getOBB=e.getOBB,this._getMatrix=e.getMatrix},_props:{aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},_buildBoundary:function(){var e=xeogl.math,t=this.scene.canvas.canvas,i=t.width,r=t.height;this._obb||(this._obb=e.OBB2(),this._aabb=e.AABB2(),this._center=e.vec2());var s=this._getOBB(),n=this._getMatrix();s&&n&&(e.transformOBB3(n,s,this._obb),e.OBB3ToAABB2(this._obb,this._aabb),e.AABB2ToCanvas(this._aabb,i,r),e.getAABB2Center(this._aabb,this._center))},_getJSON:function(){return{aabb:this.aabb,center:this.center}}})}(),function(){"use strict";xeogl.Boundary3D=xeogl.Component.extend({type:"xeogl.Boundary3D",_init:function(e){this._obb=e.obb||null,this._aabb=e.aabb||null,this._sphere=e.sphere||null,this._center=e.center||null,this._getDirty=e.getDirty,this._getOBB=e.getOBB,this._getAABB=e.getAABB,this._getMatrix=e.getMatrix,this._getPositions=e.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}},sphere:{get:function(){return this._getDirty()&&this._buildBoundary(),this._sphere}}},_buildBoundary:function(){var e=xeogl.math;this._obb||(this._obb=xeogl.math.OBB3()),this._aabb||(this._aabb=xeogl.math.AABB3()),this._sphere||(this._sphere=xeogl.math.vec4()),this._center||(this._center=xeogl.math.vec3());var t=this._getAABB?this._getAABB():null;if(t)return this._aabb[0]=t[0],this._aabb[1]=t[1],this._aabb[2]=t[2],this._aabb[3]=t[3],this._aabb[4]=t[4],this._aabb[5]=t[5],e.AABB3ToOBB3(this._aabb,this._obb),e.OBB3ToSphere3(this._obb,this._sphere),void e.getSphere3Center(this._sphere,this._center);var i,r=this._getPositions?this._getPositions():null;if(r)return(i=this._getMatrix?this._getMatrix():null)?(e.positions3ToAABB3(r,this._aabb),e.AABB3ToOBB3(this._aabb,this._obb),e.transformOBB3(i,this._obb),e.OBB3ToAABB3(this._obb,this._aabb),e.OBB3ToSphere3(this._obb,this._sphere),void e.getSphere3Center(this._sphere,this._center)):(e.positions3ToAABB3(r,this._aabb),e.AABB3ToOBB3(this._aabb,this._obb),e.OBB3ToSphere3(this._obb,this._sphere),void e.getSphere3Center(this._sphere,this._center));var s=this._getOBB?this._getOBB():null;if(s){if(i=this._getMatrix?this._getMatrix():null)return e.transformOBB3(i,s,this._obb),e.OBB3ToAABB3(this._obb,this._aabb),e.OBB3ToSphere3(this._obb,this._sphere),void e.getSphere3Center(this._sphere,this._center);for(var n=0,a=s.length;n<a;n++)this._obb[n]=s[n];e.OBB3ToAABB3(this._obb,this._aabb),e.OBB3ToSphere3(this._obb,this._sphere),e.getSphere3Center(this._sphere,this._center)}},_getJSON:function(){return{obb:this.obb,aabb:this.aabb,center:this.center,sphere:this.sphere}}})}(),function(){"use strict";xeogl.Transform=xeogl.Component.extend({type:"xeogl.Transform",_init:function(e){this._onParentUpdated=null,this._onParentDestroyed=null,this._matrix=xeogl.math.identityMat4(xeogl.math.mat4()),this._leafMatrix=xeogl.math.mat4(),this._leafNormalMatrix=xeogl.math.mat4(),this._leafMatrixDirty=!0,this._leafNormalMatrixDirty=!0;var t=this;this._state=new xeogl.renderer.Transform({getMatrix:function(){return t._leafMatrixDirty&&t._buildLeafMatrix(),t._leafMatrix},getNormalMatrix:function(){return t._leafNormalMatrixDirty&&t._buildLeafNormalMatrix(),t._leafNormalMatrix}}),this.parent=e.parent,this.matrix=e.matrix,this.postMultiply=e.postMultiply},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._build&&this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._parent)this._postMultiply?xeogl.math.mulMat4(this._parent.leafMatrix,this._matrix,this._leafMatrix):xeogl.math.mulMat4(this._matrix,this._parent.leafMatrix,this._leafMatrix);else for(var e=0,t=this._matrix.length;e<t;e++)this._leafMatrix[e]=this._matrix[e];this._renderer.imageDirty=!0,this._leafMatrixDirty=!1,this._leafNormalMatrixDirty=!0}},_buildLeafNormalMatrix:function(){this._leafMatrixDirty&&this._buildLeafMatrix(),xeogl.math.inverseMat4(this._leafMatrix,this._leafNormalMatrix),xeogl.math.transposeMat4(this._leafNormalMatrix),this._renderer.imageDirty=!0,this._leafNormalMatrixDirty=!1},_props:{parent:{set:function(e){if(e)for(var t=this.id,i=e;i;i=i._parent)if(t===i.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||e&&e.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=e,this.fire("parent",this._parent),this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},postMultiply:{set:function(e){e=!1!==e,this._postMultiply!==e&&(this._postMultiply=e,this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("updated",!0),this.fire("postMultiply",this._postMultiply))},get:function(){return this._postMultiply}},matrix:{set:function(e){this._matrix.set(e||xeogl.math.identityMat4()),this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafMatrix}}},_getJSON:function(){var e={matrix:Array.prototype.slice.call(this._matrix),postMultiply:this._postMultiply};return this._parent&&(e.parent=this._parent.id),e},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";xeogl.Rotate=xeogl.Transform.extend({type:"xeogl.Rotate",_init:function(e){this._super(e),this.xyz=e.xyz,this.angle=e.angle},_update:function(){this.matrix=xeogl.math.rotationMat4v(this._angle*xeogl.math.DEGTORAD,this._xyz,this._matrix)},_props:{xyz:{set:function(e){(this._xyz=this._xyz||new xeogl.math.vec3).set(e||[0,1,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}},angle:{set:function(e){this._angle=e||0,this._scheduleUpdate(),this.fire("angle",this._angle)},get:function(){return this._angle}}},_getJSON:function(){var e={xyz:this._xyz,angle:this._angle};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";var e,t,i;xeogl.Quaternion=xeogl.Transform.extend({type:"xeogl.Quaternion",_init:function(e){this._super(e),this.xyzw=e.xyzw},_props:{xyzw:{set:function(e){var t=xeogl.math;(this._xyzw=this._xyzw||new t.vec4).set(e||t.identityQuaternion()),this.matrix=t.quaternionToMat4(this._xyzw,this._matrix||(this._matrix=xeogl.math.identityMat4())),this.fire("xyzw",this._xyzw)},get:function(){return this._xyzw}}},rotate:(e=xeogl.math,t=e.vec4(),i=e.vec4(),function(r){t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3]*e.DEGTORAD,e.angleAxisToQuaternion(t,i),this.xyzw=e.mulQuaternions(this._xyzw,i,this._xyzw)}),_getJSON:function(){var e={xyzw:this._xyzw};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";xeogl.Scale=xeogl.Transform.extend({type:"xeogl.Scale",_init:function(e){this._super(e),this.xyz=e.xyz},_update:function(){this.matrix=xeogl.math.scalingMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(e){(this._xyz=this._xyz||new xeogl.math.vec3).set(e||[1,1,1]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var e={xyz:this._xyz};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";xeogl.Translate=xeogl.Transform.extend({type:"xeogl.Translate",_init:function(e){this._super(e),this.xyz=e.xyz},_update:function(){this.matrix=xeogl.math.translationMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(e){(this._xyz=this._xyz||new xeogl.math.vec3).set(e||[0,0,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var e={xyz:this._xyz};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";xeogl.Billboard=xeogl.Component.extend({type:"xeogl.Billboard",_init:function(e){this._super(e),this._state=new xeogl.renderer.Billboard({active:!0,spherical:!0,hash:"a;s;"}),this.active=!1!==e.active,this.spherical=!1!==e.spherical},_props:{active:{set:function(e){e=!!e,this._state.active!==e&&(this._state.active=e,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}},spherical:{set:function(e){e=!!e,this._state.spherical!==e&&(this._state.spherical=e,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("spherical",this._state.spherical))},get:function(){return this._state.spherical}}},_compile:function(){this._renderer.billboard=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Stationary=xeogl.Component.extend({type:"xeogl.Stationary",_init:function(e){this._super(e),this._state=new xeogl.renderer.Stationary({active:!0}),this.active=!1!==e.active},_props:{active:{set:function(e){e=!!e,this._state.active!==e&&(this._state.active=e,this._state.hash=this._state.active?"a;":";",this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}}},_compile:function(){this._renderer.stationary=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Frustum=xeogl.Transform.extend({type:"xeogl.Frustum",_init:function(e){this._super(e),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far},_update:function(){this.matrix=xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._matrix)},_props:{left:{set:function(e){this._left=void 0!==e&&null!==e?e:-1,this._scheduleUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(e){this._right=void 0!==e&&null!==e?e:1,this._scheduleUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(e){this._top=void 0!==e&&null!==e?e:1,this._scheduleUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(e){this._bottom=void 0!==e&&null!==e?e:-1,this._scheduleUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var e={left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";var e,t=xeogl.math,i=t.vec3(),r=t.vec3(),s=t.vec3(),n=t.vec3(),a=t.vec3(),o=t.vec3();xeogl.Lookat=xeogl.Transform.extend({type:"xeogl.Lookat",_init:function(e){this._super(e),this._eye=t.vec3([0,0,10]),this._look=t.vec3([0,0,0]),this._up=t.vec3([0,1,0]),this.eye=e.eye,this.look=e.look,this.up=e.up,this.gimbalLockY=e.gimbalLockY},_update:(e=t.mat4(),function(){t.lookAtMat4v(this._eye,this._look,this._up,e),this.matrix=e}),rotateEyeY:function(e){var a=t.subVec3(this._eye,this._look,i),o=t.rotationMat4v(.0174532925*e,this._gimbalLockY?t.vec3([0,1,0]):this._up);a=t.transformPoint3(o,a,r),this.eye=t.addVec3(a,this._look,s),this._gimbalLockY&&(this.up=t.transformPoint3(o,this._up,n))},rotateEyeX:function(e){var h=t.subVec3(this._eye,this._look,i),l=t.cross3Vec3(t.normalizeVec3(h,r),t.normalizeVec3(this._up,s)),c=t.rotationMat4v(.0174532925*e,l);h=t.transformPoint3(c,h,n),this.eye=t.addVec3(h,this._look,a),this.up=t.transformPoint3(c,this._up,o)},rotateLookY:function(e){var n=t.subVec3(this._look,this._eye,i),a=t.rotationMat4v(.0174532925*e,this._up);n=t.transformPoint3(a,n,r),this.look=t.addVec3(n,this._eye,s)},rotateLookX:function(e){var o=t.subVec3(this._look,this._eye,i),h=t.cross3Vec3(t.normalizeVec3(o,r),t.normalizeVec3(this._up,s)),l=t.rotationMat4v(.0174532925*e,h);o=t.transformPoint3(l,o,n),this.look=t.addVec3(o,this._eye,a),this.up=t.transformPoint3(l,this._up,tempVecf)},pan:function(e){var h,l=t.subVec3(this._eye,this._look,i),c=[0,0,0];if(0!==e[0]){var u=t.cross3Vec3(t.normalizeVec3(l,[]),t.normalizeVec3(this._up,r));h=t.mulVec3Scalar(u,e[0]),c[0]+=h[0],c[1]+=h[1],c[2]+=h[2]}0!==e[1]&&(h=t.mulVec3Scalar(t.normalizeVec3(this._up,s),e[1]),c[0]+=h[0],c[1]+=h[1],c[2]+=h[2]),0!==e[2]&&(h=t.mulVec3Scalar(t.normalizeVec3(l,n),e[2]),c[0]+=h[0],c[1]+=h[1],c[2]+=h[2]),this.eye=t.addVec3(this._eye,c,a),this.look=t.addVec3(this._look,c,o)},zoom:function(e){var a=t.subVec3(this._eye,this._look,i),o=Math.abs(t.lenVec3(a,r)),h=Math.abs(o+e),l=t.normalizeVec3(a,s);this.eye=t.addVec3(this._look,t.mulVec3Scalar(l,h),n)},_props:{gimbalLockY:{set:function(e){e=!1!==e,this._gimbalLockY=e,this.fire("gimbalLockY",this._gimbalLockY)},get:function(){return this._gimbalLockY}},eye:{set:function(e){this._eye.set(e||[0,0,10]),this._scheduleUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(e){this._look.set(e||[0,0,0]),this._scheduleUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(e){this._up.set(e||[0,1,0]),this._scheduleUpdate(0),this.fire("up",this._up)},get:function(){return this._up}}},_getJSON:function(){var e={eye:this._eye.slice(),look:this._look.slice(),up:this._up.slice(),gimbalLockY:this._gimbalLockY};return this._parent&&(e.parent=this._parent.id),e}})}(),function(){"use strict";xeogl.Ortho=xeogl.Transform.extend({type:"xeogl.Ortho",_init:function(e){this._super(e),this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._scheduleUpdate,this)},_update:function(){var e,t,i,r,s=this.scene,n=this._scale,a=s.canvas.canvas,o=a.clientWidth,h=a.clientHeight,l=.5*n,c=o/h;o>h?(e=-l,t=l,i=l/c,r=-l/c):(e=-l*c,t=l*c,i=l,r=-l),this.matrix=xeogl.math.orthoMat4c(e,t,r,i,this._near,this._far,this.__tempMat||(this.__tempMat=xeogl.math.mat4()))},_props:{scale:{set:function(e){this._scale=void 0!==e&&null!==e?e:1,this._scheduleUpdate(0),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._scheduleUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._scheduleUpdate(),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var e={scale:this._scale,near:this._near,far:this._far};return this._parent&&(e.parent=this._parent.id),e},_destroy:function(){this._super(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Transform.extend({type:"xeogl.Perspective",_init:function(e){this._super(e),this._dirty=!1,this._fovy=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._scheduleUpdate,this),this.fovy=e.fovy,this.near=e.near,this.far=e.far},_update:function(){var e=this.scene.canvas.canvas,t=e.clientWidth/e.clientHeight;this.matrix=xeogl.math.perspectiveMat4(this._fovy*(Math.PI/180),t,this._near,this._far,this._matrix)},_props:{fovy:{set:function(e){this._fovy=void 0!==e&&null!==e?e:60,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var e={fovy:this._fovy,near:this._near,far:this._far};return this._parent&&(e.parent=this._parent.id),e},_destroy:function(){this._super(),this.scene.canvas.off(this._canvasResized)}})}(),xeogl.version="1.0.0",define("bimsurfer/lib/xeogl",function(){}),define("bimsurfer/src/xeoViewer/controls/bimCameraControl",["../../../lib/xeogl"],function(){"use strict";xeogl.BIMCameraControl=xeogl.Component.extend({type:"xeogl.BIMCameraControl",_init:function(e){var t,i,r,s,n=this,a=xeogl.math,o=e.sensitivityKeyboardRotate||.5,h=4,l=3,c=a.mat4(),u=e.camera,d=u.view,f=u.project,_=this.scene,p=_.input,g=a.vec3(),m=a.vec3([1,0,0]),y=0,v=a.vec2(),x=a.vec2(),b=a.vec2(),w=this._rotatePos=a.vec3([0,0,0]),M=a.vec2(),E=a.vec2(),S=!1,C=!1,D=!1,k=null;this._defaultDragAction="orbit";var T,B,A,F,P,O,R,L=function(){var e=!0;u.on("viewMatrix",function(){e=!0});var t=a.mat4();return function(){return e&&a.inverseMat4(d.matrix,t),t}}(),U=function(){var e=!0;u.on("projectMatrix",function(){e=!0});var t=a.mat4();return function(){return e&&a.inverseMat4(f.matrix,t),t}}(),I=function(){var e=!0;u.on("projectMatrix",function(){e=!0});var t=a.mat4();return function(){return e&&a.transposeMat4(f.matrix,t),t}}(),N=(T=!0,B=1,_.worldBoundary.on("updated",function(){T=!0}),function(){return T&&(B=a.getAABB3Diag(_.worldBoundary.aabb)),B}),V=(A=a.vec3(),F=a.vec3(),P=a.vec3(),function(e){var t=a.subVec3(e,w,A),i=a.transformVec3(c,t,F),r=a.addVec3(i,w,P);return a.rotateVec3Z(r,w,-E[0]*a.DEGTORAD,a.vec3())}),j=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.SphereGeometry",radius:1}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),transform:this.create({type:"xeogl.Translate",xyz:[0,0,0]}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),z=(O=null,function(e){j.transform.xyz=e,j.visibility.visible=!0,O&&(clearTimeout(O),O=null),O=setTimeout(function(){j.visibility.visible=!1,O=null},1e3)});function Y(){clearTimeout(R),R=null}function G(){y=0,E[0]=0,E[1]=0,t=d.eye.slice(),i=d.look.slice(),a.addVec3(t,d.up,g),K()}function K(){a.cross3Vec3(a.normalizeVec3(a.subVec3(d.eye,d.look,a.vec3())),d.up,m)}var H,W=function(e,t){clearTimeout(H),n.scene.canvas.overlay.style.cursor=e,t||(H=setTimeout(function(){n.scene.canvas.overlay.style.cursor="auto"},100))};function X(e,t){return e[0]>=t[0]-h&&e[0]<=t[0]+h&&e[1]>=t[1]-h&&e[1]<=t[1]+h}p.on("mousedown",function(e){if(e=e.slice(),p.mouseover&&p.mouseDownLeft&&!D){if(Y(),K(),t=d.eye.slice(),i=d.look.slice(),a.addVec3(t,d.up,g),(r=_.pick({canvasPos:e,pickSurface:!0}))&&r.worldPos){var n=r.worldPos.slice(),o=e,h=Date.now();1===y?(h-s<250&&X(e,x)&&(u=b,(c=n)[0]>=u[0]-l&&c[0]<=u[0]+l&&c[1]>=u[1]-l&&c[1]>=u[1]-l&&c[2]<=u[2]+l&&c[2]<=u[2]+l)&&(w.set(n),z(n)),y=0):(y=1,b=n,x=o,s=h)}else y=0;var c,u;v[0]=e[0],v[1]=e[1],E[0]=0,E[1]=0,C=!0}});var J,q=a.vec3(),Q=function(e){var t=_.pick({canvasPos:e||M,pickSurface:!0});t?(W("pointer",!0),t.worldPos&&(k=a.lenVec3(a.subVec3(t.worldPos,d.eye,q)))):W("auto",!0)};p.on("mousemove",function(e){if(p.mouseover&&!D){if(!C)return Q(e),M[0]=e[0],void(M[1]=e[1]);var r=N(),s=_.canvas.canvas,o=s.offsetWidth/2,h=s.offsetHeight/2,l=U(),u=L(),f=I(),y=f.subarray(8,12),v=f.subarray(12),x=[0,0,-(k||r),1],b=a.dotVec4(x,y)/a.dotVec4(x,v),w=function(e){var t=a.vec4();return t[0]=(e[0]-o)/o,t[1]=(e[1]-h)/h,t[2]=b,t[3]=1,t=a.vec4(a.mulMat4v4(l,t)),a.mulVec3Scalar(t,1/t[3]),t[3]=1,t[0]*=-1,[t,a.vec4(a.mulMat4v4(u,t))]},S=w(e),T=w(M),B="pan"===n._defaultDragAction;if((p.keyDown[p.KEY_SHIFT]||p.mouseDownMiddle||p.mouseDownLeft&&p.mouseDownRight)&&(B=!B),B)a.subVec3(S[1],T[1],q),d.eye=a.addVec3(d.eye,q),d.look=a.addVec3(d.look,q);else{a.subVec3(S[0],T[0],q);var A=-q[0]*Math.PI,F=q[1]*Math.PI;E[0]+=A,E[1]+=F,a.rotationMat4v(E[1]*a.DEGTORAD,m,c),d.eye=V(t),d.look=V(i),d.up=a.subVec3(V(g),d.eye,a.vec3())}M[0]=e[0],M[1]=e[1]}}),p.on("keydown",function(e){e===p.KEY_SHIFT&&(S=!0)}),p.on("keyup",function(e){e===p.KEY_SHIFT&&(S=!1,G())}),p.on("mouseup",function(e){C&&(D||(C=!1,p.mouseover&&(x&&X(e,x)?1===y&&(S?(y=0,n.fire("pick",r)):(R&&Y(),R=setTimeout(function(){y=0,n.fire("pick",r),R=null},250))):0===y&&v&&X(e,v)&&n.fire("nopick"))))}),p.on("dblclick",function(){D||(C=!1)}),_.on("tick",function(e){if(p.mouseover&&!(C||D||p.ctrlDown||p.altDown)){var r=p.keyDown[p.KEY_LEFT_ARROW],s=p.keyDown[p.KEY_RIGHT_ARROW],n=p.keyDown[p.KEY_UP_ARROW],h=p.keyDown[p.KEY_DOWN_ARROW];if(r||s||n||h){var l=e.deltaTime,u=.3*o,f=.3*o,_=0,y=0;s?_=-l*u:r&&(_=l*u),h?y=l*f:n&&(y=-l*f),Math.abs(_)>Math.abs(y)?y=0:_=0,E[0]-=_,E[1]+=y,a.rotationMat4v(E[1]*a.DEGTORAD,m,c),d.eye=V(t),d.look=V(i),d.up=a.subVec3(V(g),d.eye,a.vec3())}}}),function(){var e=a.vec3(),t=a.vec3(),i=a.vec3(),r=a.vec3();_.on("tick",function(s){if(p.mouseover&&!C&&!D){var n=s.deltaTime;if(!p.ctrlDown&&!p.altDown){var o=p.keyDown[p.KEY_ADD],h=p.keyDown[p.KEY_SUBTRACT];if(o||h){var l=N()/5e3,c=0;h?c=n*l:o&&(c=-n*l);var u=d.eye,_=d.look;a.mulVec3Scalar(a.normalizeVec3(a.subVec3(u,w,e),t),c,r),d.eye=a.addVec3(u,r,i),d.look=a.addVec3(_,r,i),f.isType("xeogl.Ortho")&&(f.scale+=.02*c),G()}}}})}(),function(){var e=0,t=0,i=!1,r=!1,s=0,n=(a.vec3(),a.vec3(),a.vec3()),o=a.vec3(),h=a.vec3();p.on("mousewheel",function(t){C||D||(0===(e=-t)?(r=!1,i=!1):i=!0)});var l=null;_.on("tick",function(c){if((r||i)&&!C&&!D){l&&clearTimeout(l),l=setTimeout(function(){Q(),l=null},50);var u=N();k&&(u=.02*u+k);var _=c.deltaTime/1e3,p=u*(e<0?-1:1)/.2/100;if(i&&(t=.2,s=0,i=!1,r=!0),r&&((s+=_)>t&&(r=!1),r)){var g=d.eye,m=d.look;a.mulVec3Scalar(xeogl.math.transposeMat4(d.matrix).slice(8),p,h),a.addVec3(g,h,n),a.addVec3(m,h,o);Math.abs(a.lenVec3(h)),Math.abs(a.lenVec3(a.subVec3(g,w,a.vec3())));d.eye=n,d.look=o,f.isType("xeogl.Ortho")&&(f.scale+=.02*e),G()}}})}(),function(){var e=n.create({type:"xeogl.CameraFlightAnimation",camera:u,duration:1});function t(t,i,r){w.set(i),D=!0,e.cancel(),e.flyTo({look:i,eye:t,up:r},function(){G(),D=!1})}p.on("keydown",function(e){if(p.mouseover&&!C&&(e===p.KEY_NUM_1||e===p.KEY_NUM_2||e===p.KEY_NUM_3||e===p.KEY_NUM_4||e===p.KEY_NUM_5||e===p.KEY_NUM_6)){var i=_.worldBoundary,r=i.aabb,s=i.center,n=a.getAABB3Diag(r),o=Math.abs(n/Math.tan(27.5));switch(e){case p.KEY_NUM_1:t(a.vec3([s[0]-o,s[1],s[2]]),s,a.vec3([0,0,1]));break;case p.KEY_NUM_2:t(a.vec3([s[0],s[1]+o,s[2]]),s,a.vec3([0,0,1]));break;case p.KEY_NUM_3:t(a.vec3([s[0]+o,s[1],s[2]]),s,a.vec3([0,0,1]));break;case p.KEY_NUM_4:t(a.vec3([s[0],s[1]-o,s[2]]),s,a.vec3([0,0,1]));break;case p.KEY_NUM_5:t(a.vec3([s[0],s[1],s[2]+o]),s,a.vec3([0,1,0]));break;case p.KEY_NUM_6:t(a.vec3([s[0],s[1],s[2]-o]),s,a.vec3([0,-1,0]));break;default:return}}})}(),_.on("tick",(J=a.vec3(),function(e){if(!C&&p.mouseover&&!D){var t=e.deltaTime;if(!p.ctrlDown&&!p.altDown){var i=p.keyDown[p.KEY_W],r=p.keyDown[p.KEY_S],s=p.keyDown[p.KEY_A],n=p.keyDown[p.KEY_D],a=p.keyDown[p.KEY_Z],o=p.keyDown[p.KEY_X];if(i||r||s||n||o||a){var h=0,l=0,c=0,u=N()/4e3;r?l=t*u:i&&(l=-t*u),n?h=t*u:s&&(h=-t*u),o?c=t*u:a&&(c=-t*u),J[0]=h,J[1]=l,J[2]=c,d.pan(J),G()}}}}))},_props:{rotatePos:{set:function(e){e&&this._rotatePos.set(e)}},defaultDragAction:{set:function(e){"pan"!==e&&"orbit"!==e||(this._defaultDragAction=e)}}}})}),define("bimsurfer/src/xeoViewer/entities/bimModel",["../../../lib/xeogl"],function(){"use strict";xeogl.BIMModel=xeogl.Component.extend({type:"xeogl.BIMModel",_init:function(e){this.collection=this.create({type:"xeogl.Collection"})},addObject:function(e){this.collection.add(e)}})}),define("bimsurfer/src/xeoViewer/entities/bimObject",["../../../lib/xeogl"],function(){"use strict";xeogl.BIMObject=xeogl.Component.extend({type:"xeogl.BIMObject",_init:function(e){var t;this.model=e.model,this.transform=this.create({type:"xeogl.Transform",matrix:e.matrix}),this.visibility=this.create({type:"xeogl.Visibility",visible:!0}),this.material=this.create({type:"xeogl.PhongMaterial",emissive:[0,0,0],diffuse:[Math.random(),Math.random(),Math.random()],opacity:1}),this.modes=this.create({type:"xeogl.Modes",transparent:!1,backfaces:!0}),this.stage=this.create({type:"xeogl.Stage",priority:0}),this.depthBuf=this.create({type:"xeogl.DepthBuf",active:!0}),this.entities=[];for(var i=0,r=e.geometryIds.length;i<r;i++)t=this.create({type:"xeogl.Entity",meta:{objectId:this.id},geometry:"geometry."+e.geometryIds[i],transform:this.transform,visibility:this.visibility,material:this.material,modes:this.modes,stage:this.stage,depthBuf:this.depthBuf}),this.entities.push(t)},add:function(e){var t=this.create({type:"xeogl.Entity",meta:{objectId:this.id},geometry:"geometry."+e,transform:this.transform,visibility:this.visibility,material:this.material,modes:this.modes,stage:this.stage,depthBuf:this.depthBuf});this.entities.push(t)},_props:{worldBoundary:{get:function(){return this.entities[0].worldBoundary}},viewBoundary:{get:function(){return this.entities[0].viewBoundary}},canvasBoundary:{get:function(){return this.entities[0].viewBoundary}},highlighted:{set:function(e){this.depthBuf.active=!e,this.stage.priority=e?2:0,this.material.emissive=e?[.5,.5,.5]:[0,0,0]}}}})}),define("bimsurfer/src/xeoViewer/helpers/bimBoundaryHelper",["../../../lib/xeogl"],function(){"use strict";var e=xeogl.Entity.extend({type:"xeogl.BIMBoundaryHelperEntity",_init:function(e){var t=this.create({type:"xeogl.OBBGeometry"}),i=this.create({type:"xeogl.PhongMaterial",diffuse:e.color||[.5,.5,.5],ambient:[0,0,0],specular:[0,0,0],lineWidth:2}),r=this.create({type:"xeogl.Modes",collidable:!1}),s=this.create({type:"xeogl.Stage",priority:3}),n=this.create({type:"xeogl.Visibility",visible:!0}),a=this.create({type:"xeogl.DepthBuf",active:!1});this._super(xeogl._apply({geometry:t,material:i,modes:r,stage:s,depthBuf:a,visibility:n},e))}});xeogl.BIMBoundaryHelper=function(t,i,r){var s=this;s._entities={},s._pool=[],s.setSelected=function(n){var a=Object.keys(s._entities);n.forEach(function(n){var o;s._entities[n]||(s._pool.length>0?(o=s._entities[n]=s._pool.shift()).visibility.visible=!0:o=s._entities[n]=new e(t,r),o.geometry.boundary=i.getObject(n).worldBoundary);var h=a.indexOf(n);-1!==h&&a.splice(h,1)}),a.forEach(function(e){var t=s._entities[e];t.visibility.visible=!1,s._pool.push(t),delete s._entities[e]})}}}),define("bimsurfer/src/xeoViewer/effects/highlightEffect",["../../../lib/xeogl"],function(){"use strict";xeogl.HighlightEffect=xeogl.Component.extend({type:"xeogl.HighlightEffect",_init:function(e){this._modes=this.create({type:"xeogl.Modes",transparent:!0,collidable:!1}),this._stage=this.create({type:"xeogl.Stage",priority:2}),this._depthBuf=this.create({type:"xeogl.DepthBuf",active:!1}),this._emissiveColor=(e.color||[.2,.9,.2]).slice(0,3),this._opacity=e.color&&e.color.length>3?e.color[3]:.25,this._helpers={},this._freeHelpers=[]},add:function(e){var t=e.entities;if(t)for(var i,r=0,s=t.length;r<s;r++)i=t[r],this._createHelper(i);else this._createHelper(e)},_createHelper:function(e){var t=this._freeHelpers.pop();t?(t.geometry=e.geometry,t.material.diffuse=e.material.diffuse,t.material.ambient=e.material.ambient,t.transform=e.transform,t.visibility.visible=!0,t.meta.entityId=e.id):t=this.create({type:"xeogl.Entity",geometry:e.geometry,transform:e.transform,material:this.create({type:"xeogl.PhongMaterial",emissive:this._emissiveColor,specular:[0,0,0],diffuse:[0,0,0],ambient:[0,0,0],opacity:this._opacity}),modes:this._modes,stage:this._stage,depthBuf:this._depthBuf,visibility:this.create({type:"xeogl.Visibility",visible:!0}),meta:{entityId:e.id}}),this._helpers[e.id]=t},clear:function(){var e;for(var t in this._helpers)this._helpers.hasOwnProperty(t)&&(e=this._helpers[t],this._destroyHelper(e))},remove:function(e){for(var t,i=e.entities,r=0,s=i.length;r<s;r++){t=i[r];var n=this._helpers[t.id];n&&this._destroyHelper(n)}},_destroyHelper:function(e){e.visibility.visible=!1,this._freeHelpers.push(e),delete this._helpers[e.meta.entityId]}})}),define("bimsurfer/src/xeoViewer/utils/collection",["../../../lib/xeogl"],function(){"use strict";xeogl.Collection=xeogl.Component.extend({type:"xeogl.Collection",_init:function(e){this.components={},this.numComponents=0,this.types={},this._destroyedSubs={},e.components&&this.add(e.components)},add:function(e){for(var t=0,i=(e=xeogl._isArray(e)?e:[e]).length;t<i;t++)this._add(e[t])},_add:function(e){var t,i,r,s;if(e.type)i=e;else{if(!xeogl._isNumeric(e)&&!xeogl._isString(e))return;if(this.scene.types[e]){if(r=e,!(s=this.scene.types[r]))return void this.warn("Component type not found: '"+r+"'");for(t in s)s.hasOwnProperty(t)&&this._add(s[t]);return}if(!(i=this.scene.components[e]))return void this.warn("Component not found: "+xeogl._inQuotes(e))}if(i.scene===this.scene){if(!this.components[i.id]){this.components[i.id]=i,(s=this.types[i.type])||(s=this.types[i.type]={}),s[i.id]=i,this.numComponents++;var n=this;this._destroyedSubs[i.id]=i.on("destroyed",function(){n._remove(i)}),this.fire("added",i),this._dirty||this._scheduleUpdate()}}else this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(i.id))},_scheduleUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._dirty=!1},clear:function(){this.iterate(function(e){this._remove(e)})},destroyAll:function(){this.iterate(function(e){e.destroy()})},remove:function(e){for(var t=0,i=(e=xeogl._isArray(e)?e:[e]).length;t<i;t++)this._remove(e[t])},_remove:function(e){var t=e.id;if(e.scene===this.scene){delete this.components[t],e.off(this._destroyedSubs[t]),delete this._destroyedSubs[t];var i=this.types[e.type];i&&delete i[e.id],this.numComponents--,this.fire("removed",e),this._dirty||this._scheduleUpdate()}else this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+t+"'")},iterate:function(e,t){t=t||this;var i=this.components;for(var r in i)i.hasOwnProperty(r)&&e.call(t,i[r])},_getJSON:function(){var e=[];for(var t in this.components)this.components.hasOwnProperty(t)&&e.push(this.components[t].id);return{components:e}},_destroy:function(){this.clear()}})}),define("bimsurfer/src/xeoViewer/xeoViewer",["../DefaultMaterials","../EventHandler","../Utils","../../lib/xeogl","./controls/bimCameraControl","./entities/bimModel","./entities/bimObject","./helpers/bimBoundaryHelper","./effects/highlightEffect","./utils/collection"],function(e,t,i){"use strict";function r(r){t.call(this);var s=this,n=document.getElementById(r.domNode),a=document.createElement("canvas");n.appendChild(a);var o=s.scene=new xeogl.Scene({canvas:a,transparent:!0}),h=[{type:"ambient",params:{color:[.65,.65,.75],intensity:1}},{type:"dir",params:{dir:[0,0,-1],color:[1,1,1],intensity:1,space:"view"}}];o.lights.lights=B(h);var l=new xeogl.Scale(o,{xyz:[1,1,1]}),c=o.input,u=o.camera;u.project.far=5e3;var d,f=new xeogl.CameraFlightAnimation(o,{fitFOV:25,duration:1}),_=new xeogl.Collection(o),p=new xeogl.BIMBoundaryHelper(o,s,{color:r.selectionBorderColor}),g=new xeogl.HighlightEffect(o,{color:r.selectionColor}),m={},y={},v={},x={},b={},w=null,M=["IfcOpeningElement","IfcSpace"],E={},S=null,C=null,D={persp:u.project,ortho:new xeogl.Ortho(o,{scale:1,near:.1,far:5e3})},k="persp";d=!1,u.on("projectMatrix",function(){d=!0}),u.on("viewMatrix",function(){d=!0}),o.on("tick",function(){s.fire("tick"),d&&(s.fire("camera-changed",[s.getCamera()]),d=!1)});var T=new xeogl.BIMCameraControl(o,{camera:u});function B(e){return e.map(function(e){return"ambient"==e.type?new xeogl.AmbientLight(o,e.params):"dir"==e.type?new xeogl.DirLight(o,e.params):"point"==e.type?new xeogl.PointLight(o,e.params):void console.log("Unknown light type: "+type)})}T.on("pick",function(e){var t=e.entity;if(t.meta){var i=t.meta.objectId||t.id;if(void 0!==i){var r=!!E[i],n=o.input.keyDown[c.KEY_SHIFT];s.setSelection({ids:[i],selected:!r,clear:!n})}}}),T.on("nopick",function(e){s.setSelection({clear:!0})}),this.setDefaultDragAction=function(e){T.defaultDragAction=e},this.setScale=function(e){l.xyz=[e,e,e]},this.taskStarted=function(){o.canvas.spinner.processes++,o.ticksPerRender=15},this.taskFinished=function(){var e=o.canvas.spinner;0!==e.processes&&(e.processes--,0===e.processes&&(o.ticksPerRender=1))},this.loadRandom=function(t){t=t||{},this.clear();var i=new xeogl.BoxGeometry(o,{id:"geometry.test"});_.add(i);var r,s,n,a,h,l,c=Object.keys(e),u=t.numEntities||200,d=t.size||200,f=d/2,p=t.center?t.center[0]:0,g=t.center?t.center[1]:0,m=t.center?t.center[2]:0;this.createModel("test");for(var y=0;y<u;y++)r=n="object"+y,a=xeogl.math.translationMat4c(Math.random()*d-f+p,Math.random()*d-f+g,Math.random()*d-f+m),h=xeogl.math.scalingMat4c(32*Math.random()+.2,32*Math.random()+.2,10*Math.random()+.2),l=xeogl.math.mulMat4(a,h,xeogl.math.mat4()),s=c[Math.round(Math.random()*c.length)],this.createObject("test","test",r,n,["test"],s,l);this.setCamera({eye:[0,0,0],target:[p,g,m],up:[0,0,1]}),this.viewFit(),this.saveReset()},this.createGeometry=function(e,t,i,r,s){var n=new xeogl.Geometry(o,{id:"geometry."+e,primitive:"triangles",positions:t,normals:i,colors:r,indices:s});return _.add(n),n},this.createModel=function(e){if(!m[e]){var t=new xeogl.BIMModel(o,{});return m[e]=t,_.add(t),t}console.log("Model with id "+e+" already exists, won't recreate")},this.createObject=function(e,t,i,r,s,n,a){if(e){var h=m[e];if(!h)return void console.log("Can't create object - model not found: "+e);r=e+":"+r}if(!y[r]){var c=new xeogl.BIMObject(o,{id:r,geometryIds:s,matrix:a});return c.transform.parent=l,this._addObject(n,c),h&&h.collection.add(c),-1!==M.indexOf(n)&&(c.visibility.visible=!1),c}console.log("Object with id "+r+" already exists, won't recreate")},this._addObject=function(t,r){var s;-1!==r.id.indexOf("#")&&(s=i.CompressGuid(r.id.split("#")[1].substr(8,36).replace(/-/g,""))),_.add(r),y[r.id]=r,s&&(v[s]||(v[s]=[])).push(r),(x[t]||(x[t]={}))[r.id]=r;var n=e[t]||e.DEFAULT;s||(r.material.diffuse=[n[0],n[1],n[2]]),r.material.specular=[0,0,0],n[3]<1&&(r.material.opacity=n[3],r.modes.transparent=!0),r.material.opacity<1&&(r.modes.transparent=!0)},this.loadglTF=function(e){this.clear();var t=new xeogl.GLTFModel(o,{src:e});return _.add(t),m[t.id]=t,t.on("loaded",function(){t.iterate(function(e){e.isType("xeogl.Entity")&&s._addObject("DEFAULT",e)}),s.saveReset()}),t},this.destroyModel=function(e){var t=m[e];t?(t.collection.iterate(function(e){e.destroy()}),t.destroy(),delete m[e]):console.warn("Can't destroy model - model not found: "+e)},this.clear=function(){var e=[];for(_.iterate(function(t){e.push(t)});e.length;)e.pop().destroy();y={},x={},b={},w=null,E={},S=null,this.saveReset()},this.setVisibility=function(e){var t=!1,i=(e=e||{}).ids,r=e.types;if(i||r){i=i||[],r=r||[];var s,n,a,o,h=!1!==e.visible;if(e.clear)for(o in b)b.hasOwnProperty(o)&&(delete b[o],t=!0);for(s=0,n=r.length;s<n;s++){var l=r[s],c=x[l]||{};Object.keys(c).forEach(function(e){c[e].visibility.visible=h,t=!0});var u=M.indexOf(l);-1!==u&&h?M.splice(u,1):-1!==u||h||M.push(l)}for(s=0,n=i.length;s<n;s++){a=i[s];var d=function(e){e.visibility.visible=h,t=!0},f=y[a];f?d(f):v[a].forEach(d)}t&&(w=Object.keys(b),this.fire("visibility-changed",[w]))}else console.error("Param expected: ids or types")},this.getVisibility=function(){return w||(w=Object.keys(b))},this.setSelection=function(e){var t,i=!1,r=!!(e=e||{}).selected;if(e.clear)for(t in E)E.hasOwnProperty(t)&&(E[t],delete E[t],i=!0);var s=e.ids;if(s)for(var n=0,a=s.length;n<a;n++){var o=function(e){var t=e.id;!!E[t]!==r&&(i=!0),r?E[t]=e:E[t]&&delete E[t],S=null};t=s[n];var h=y[t];h?o(h):v[t].forEach(o)}i&&(function(e){if(e.aabb)throw new Error("Not supported");if(e.ids){p.setSelected(e.ids),g.clear();for(var t,i,r=e.ids,s=0,n=r.length;s<n;s++)t=r[s],(i=y[t])&&g.add(i)}}({ids:S=Object.keys(E),show:S.length>0}),this.fire("selection-changed",[S]))},this.getSelection=function(){return S||(S=Object.keys(E))},this.setColor=function(e){var t=(e=e||{}).ids,i=e.types;if(t||i){t=t||[],i=i||[];var r=e.color;if(r){var n,a;for(h=0,l=i.length;h<l;h++){var o=x[i[h]]||{};Object.keys(o).forEach(function(e){var t=o[e];s._setObjectColor(t,r)})}for(var h=0,l=t.length;h<l;h++)n=t[h],(a=y[n]||v[n])?this._setObjectColor(a,r):console.error("Object not found: '"+n+"'")}else console.error("Param expected: 'color'")}else console.error("Param expected: ids or types")},this._setObjectColor=function(e,t){var i=e.material;i.diffuse=[t[0],t[1],t[2]];var r=t.length>3?t[3]:1;r!==i.opacity&&(i.opacity=r,e.modes.transparent=r<1)},this.setOpacity=function(e){var t=(e=e||{}).ids,i=e.types;if(t||i){t=t||[],i=i||[];var r=e.opacity;if(void 0!==r){var n,a;for(h=0,l=i.length;h<l;h++){var o=x[i[h]]||{};Object.keys(o).forEach(function(e){var t=o[e];s._setObjectOpacity(t,r)})}for(var h=0,l=t.length;h<l;h++)n=t[h],(a=y[n]||v[n])?this._setObjectOpacity(a,r):console.error("Object not found: '"+n+"'")}else console.error("Param expected: 'opacity'")}else console.error("Param expected: ids or types")},this._setObjectOpacity=function(e,t){var i=e.material;t!==i.opacity&&(i.opacity=t,e.modes.transparent=t<1)},this.setCamera=function(e){var t=(e=e||{}).type;if(t&&t!==k){var i=D[t];i?(u.project=i,k=t):console.error("Unsupported camera projection type: "+t)}e.animate?f.flyTo({eye:e.eye,look:e.target,up:e.up,fitFOV:e.fitFOV,duration:e.duration}):(e.eye&&(u.view.eye=e.eye),e.target&&(u.view.look=e.target,T.rotatePos=u.view.look),e.up&&(u.view.up=e.up)),e.fovy&&("persp"!==k?console.error("Ignoring update to 'fovy' for current '"+k+"' camera"):u.project.fovy=e.fovy),e.scale&&("ortho"!==k?console.error("Ignoring update to 'scale' for current '"+k+"' camera"):u.project.scale=e.scale)},this.getCamera=function(){var e=u.view,t={type:k,eye:e.eye.slice(0),target:e.look.slice(0),up:e.up.slice(0)},i=u.project;return"persp"===k?t.fovy=i.fovy:"ortho"===k&&(t.size=[1,1,1]),t},this.setLights=function(e){h=e;for(var t=o.lights.lights.length-1;t>=0;t--)o.lights.lights[t].destroy();o.lights.lights=B(h)},this.getLights=function(){return h},this.viewFit=function(e,t){var i,r=(e=e||{}).ids;i=r&&0!==r.length?function(e){var t,i,r,s,n,a,o,h;Object.keys(v).length?(t=[],e.forEach(function(e){v[e].forEach(function(e){t.push(e.id)})})):t=e;if(0===t.length)return null;if(1===t.length)return i=t[0],(r=y[i]||v[i])&&(s=r.worldBoundary)?s.aabb:null;var l,c=1e5,u=1e5,d=1e5,f=-1e5,_=-1e5,p=-1e5;for(n=0,a=t.length;n<a;n++)i=t[n],(r=y[i]||v[i])&&(s=r.worldBoundary)&&(l=s.aabb,o=l.slice(0),h=l.slice(3),o[0]<c&&(c=o[0]),o[1]<u&&(u=o[1]),o[2]<d&&(d=o[2]),h[0]>f&&(f=h[0]),h[1]>_&&(_=h[1]),h[2]>p&&(p=h[2]));var g=xeogl.math.AABB3();return g[0]=c,g[1]=u,g[2]=d,g[3]=f,g[4]=_,g[5]=p,g}(r):o.worldBoundary.aabb,e.animate?f.flyTo({aabb:i,fitFOV:e.fitFOV,duration:e.duration},function(){t&&t(),T.rotatePos=u.view.look}):f.jumpTo({aabb:i,fitFOV:50})},this.saveReset=function(){C=this.getBookmark()},this.getObject=function(e){return y[e]},this.reset=function(e){C?this.setBookmark(C,e):console.log("Ignoring call to xeoViewer.reset - xeoViewer.saveReset not called previously.")},this.getBookmark=function(e){var t,i,r=!e||e.visible,s=!e||e.colors,n=!e||e.selected,a=!e||e.camera,o={};if(r){var h=[];for(t in y)y.hasOwnProperty(t)&&(i=y[t]||v[t],r&&i.visibility.visible&&h.push(t));o.visible=h}if(s){var l={},c={};for(t in y)y.hasOwnProperty(t)&&(i=y[t]||v[t],l[t]=i.material.diffuse.slice(),c[t]=i.modes.transparent?i.material.opacity:1);o.colors=l,o.opacities=c}if(n&&(o.selected=this.getSelection()),a){var u=this.getCamera();u.animate=!0,o.camera=u}return o},this.setBookmark=function(e,t){var i=e.visible&&(!t||t.visible),r=e.colors&&(!t||t.colors),s=e.selected&&(!t||t.selected),n=e.camera&&(!t||t.camera);if(r){var a,o,h=e.colors,l=e.opacities;for(a in h)h.hasOwnProperty(a)&&(o=y[a]||v[a])&&(this._setObjectColor(o,h[a]),this._setObjectOpacity(o,l[a]))}i&&this.setVisibility({ids:e.visible,visible:!0}),s&&this.setSelection({ids:e.selected,selected:!0}),n&&this.setCamera(e.camera)},this.setConfigs=function(e){void 0!=(e=e||{}).mouseRayPick&&(T.mousePickEntity.rayPick=e.mouseRayPick),void 0!=e.viewFitFOV&&(f.fitFOV=e.viewFitFOV),void 0!=e.viewFitDuration&&(f.duration=e.viewFitDuration)},this.getSnapshot=function(e){return o.canvas.getSnapshot(e)},this.getTypes=function(){return Object.keys(x).map(function(e){return{name:e,visible:-1===M.indexOf(e)}})},this.getWorldBoundary=function(e,t){let i=y[e]||v[e];if(void 0===i)return null;{void 0===t&&(t={obb:new Float32Array(32),aabb:new Float32Array(6),center:xeogl.math.vec3(),sphere:xeogl.math.vec4()});let e=1/l.xyz[0],o=i.worldBoundary;t.aabb[0]=o.aabb[0]*e,t.aabb[1]=o.aabb[1]*e,t.aabb[2]=o.aabb[2]*e,t.aabb[3]=o.aabb[3]*e,t.aabb[4]=o.aabb[4]*e,t.aabb[5]=o.aabb[5]*e,xeogl.math.mulVec3Scalar(o.center,e,t.center),xeogl.math.mulVec4Scalar(o.sphere,e,t.sphere);for(var r=o.obb,s=t.obb.buffer,n=0;n<32;n+=4){var a=new Float32Array(s,4*n);xeogl.math.mulVec3Scalar(r.slice(n),e,a),a[3]=1}return t}},this.destroy=function(){o.destroy()}}return r.prototype=Object.create(t.prototype),r}),window.BIMSERVER_VERSION="1.5",define("bimsurfer/src/BimSurfer",["./Notifier","./BimServerModel","./PreloadQuery","./BimServerGeometryLoader","./xeoViewer/xeoViewer","./EventHandler"],function(e,t,i,r,s,n,a){var o;function h(a){var h=this;n.call(this),a=a||{};var l=this.viewer=new s(a);l.on("camera-changed",function(){h.fire("camera-changed",arguments)}),l.on("selection-changed",function(){h.fire("selection-changed",arguments)}),this._idMapping={toGuid:[],toId:[]},this.load=function(e){return e.test?(l.loadRandom(e),null):e.bimserver?this._loadFromServer(e):e.api?this._loadFromAPI(e):e.src?this._loadFrom_glTF(e):void 0},this._loadFromServer=function(t){var i=new e,r=new o(t.bimserver,i);return t.api=r,h._initApi(t).then(h._loginToServer).then(h._getRevisionFromServer).then(h._loadFromAPI)},this._initApi=function(e){return new Promise(function(t,i){e.api.init(function(){t(e)})})},this._loginToServer=function(e){return new Promise(function(t,i){e.token?e.api.setToken(e.token,function(){t(e)},i):e.api.login(e.username,e.password,function(){t(e)},i)})},this._getRevisionFromServer=function(e){return new Promise(function(t,i){e.roid?t(e):e.api.call("ServiceInterface","getAllRelatedProjects",{poid:e.poid},function(r){var s=!1;r.forEach(function(i){i.oid==e.poid&&(e.roid=i.lastRevisionId,e.schema=i.schema,h.models||(h.models=[]),h.models.push(i),s=!0,t(e))}),s||i()},i)})},this._loadFrom_glTF=function(e){if(e.src)return new Promise(function(t,i){var r=l.loadglTF(e.src);r.on("loaded",function(){l.scene.canvas.spinner.on("processes",function(e){0===e&&(l.viewFit({}),t(r))})})})},this._loadFromAPI=function(e){return new Promise(function(r,s){e.api.getModel(e.poid,e.roid,e.schema,!1,function(s){var n=!1;s.query(i,function(){if(!n){n=!0;var i=new t(e.api,s);h._loadModel(i),r(i)}})})})},this._loadModel=function(e){e.getTree().then(function(t){var i=[],s={},n={},a=function(e){"1.4"==BIMSERVER_VERSION?i.push(e.id):i[e.gid]=e.id,s[e.id]=e.guid,n[e.guid]=e.id;for(var t=0;t<(e.children||[]).length;++t)a(e.children[t])};a(t),h._idMapping.toGuid.push(s),h._idMapping.toId.push(n);var o={};o[e.model.roid]=e.model,l.taskStarted(),l.createModel(e.model.roid);var c=new r(e.api,o,l);c.addProgressListener(function(e,t,i){"start"==e?(console.log("Started loading geometries"),h.fire("loading-started")):"done"==e&&(console.log("Finished loading geometries ("+i+" objects received)"),h.fire("loading-finished"),l.taskFinished())}),c.setLoadOids([e.model.roid],i),l.on("tick",function(){c.process()}),c.start()})};var c=function(e){return function(t){for(var i=0;i<e.length;++i){var r=e[i][t];if(r)return r}return null}};this.toId=function(e){return e.map(c(h._idMapping.toId))},this.toGuid=function(e){return e.map(c(h._idMapping.toGuid))},this.setVisibility=function(e){l.setVisibility(e)},this.setSelection=function(e){return l.setSelection(e)},this.getSelection=function(){return l.getSelection()},this.setColor=function(e){l.setColor(e)},this.setOpacity=function(e){l.setOpacity(e)},this.viewFit=function(e){l.viewFit(e)},this.getCamera=function(){return l.getCamera()},this.setCamera=function(e){l.setCamera(e)},this.setLights=function(e){l.setLights(e)},this.getLights=function(){return l.getLights},this.reset=function(e){l.reset(e)},this.getTypes=function(){return l.getTypes()},this.setDefaultDragAction=function(e){l.setDefaultDragAction(e)},this.getWorldBoundary=function(e,t){return l.getWorldBoundary(e,t)},this.destroy=function(){l.destroy()}}return o=a||window.BimServerClient,h.prototype=Object.create(n.prototype),h}),define("bimsurfer/src/Request",[],function(){return{Make:function(e){return new Promise(function(t,i){var r=new XMLHttpRequest;r.open(e.method||"GET",e.url,!0),r.onload=function(s){console.log(e.url,r.readyState,r.status),4===r.readyState&&(200===r.status?t(r.responseXML):i(r.statusText))},r.send(null)})}}}),define("bimsurfer/src/StaticTreeRenderer",["./EventHandler","./Request","./Utils"],function(e,t,r){function s(s){var n=this;e.call(this);var a=n.TOGGLE=0,o=n.SELECT=1,h=n.SELECT_EXCLUSIVE=2,l=n.DESELECT=3,c=!1,u={},d={};this.getOffset=function(e){for(var t=document.getElementById(s.domNode),i=0;i+=e.offsetTop,e!=t;)e=e.offsetParent;return i},this.setSelected=function(e,t){t==h&&n.setSelected(n.getSelected(!0),l),e.forEach(function(e){var i=null;t==a?i=d[e]=!d[e]:t==o||t==h?i=d[e]=!0:t==l&&(i=d[e]=!1),u[e].className=i?"label selected":"label"});var i=n.getSelected().map(function(e){return n.getOffset(u[e])});if(i.length){i.sort(),i=[i[0],i[i.length-1]];var r=document.getElementById(s.domNode),c=[r.scrollTop,r.scrollTop+r.offsetHeight];if(!(i[0]>=c[0]&&i[1]<=c[1]))if(i[1]-i[0]>c[1]-c[0])r.scrollTop=i[0];else{var f=parseInt((i[1]+i[0])/2-(c[1]-c[0])/2,10);f=Math.max(f,0),f=Math.min(f,r.scrollHeight-r.offsetHeight),r.scrollTop=f}}this.fire("selection-changed",[n.getSelected(!0)])},this.getSelected=function(e){e=void 0===e||!!e;var t=[];return Object.keys(d).forEach(function(i){!!d[i]===e&&t.push(i)}),t};var f=[];this.addModel=function(e){f.push(e),e.src&&(c=!0)},this.qualifyInstance=function(e,t){return c?t:e+":"+t},this.build=function(){var e=function(t,i,r){var s=n.qualifyInstance(t,c?r.guid:r.id),o=document.createElement("div"),l=document.createElement("div");o.className="label",o.appendChild(document.createTextNode(r.name||r.guid)),i.appendChild(o),l.className="children",i.appendChild(l),u[s]=o,o.onclick=function(e){return e.stopPropagation(),e.preventDefault(),n.setSelected([s],e.shiftKey?a:h),n.fire("click",[s,n.getSelected(!0)]),!1};for(var d=0;d<(r.children||[]).length;++d){var f=r.children[d];if(c){if(f["xlink:href"])continue;if("IfcOpeningElement"===f.type)continue}var _=document.createElement("div");_.className="item",l.appendChild(_),e(t,_,f)}};f.forEach(function(n){var a=document.createElement("div");a.className="item",n.tree?e(n.id,a,n.tree):n.src&&t.Make({url:n.src}).then(function(t){var s=r.XmlToJson(t,{Name:"name",id:"guid"}),o=r.FindNodeOfType(s.children[0],"decomposition")[0].children[0];e(n.id||i,a,o)}),document.getElementById(s.domNode).appendChild(a)})}}return s.prototype=Object.create(e.prototype),s}),define("bimsurfer/src/MetaDataRenderer",["./EventHandler","./Request","./Utils"],function(e,t,i){function s(e){var t=this.div=document.createElement("div"),i=document.createElement("h3"),r=document.createElement("table"),s=document.createElement("tr");r.appendChild(s);var n=document.createElement("th"),a=document.createElement("th");n.appendChild(document.createTextNode("Name")),a.appendChild(document.createTextNode("Value")),s.appendChild(n),s.appendChild(a),t.appendChild(i),t.appendChild(r),e.domNode.appendChild(t),this.setName=function(e){i.appendChild(document.createTextNode(e))},this.addRow=function(){var e=document.createElement("tr");r.appendChild(e);var t=document.createElement("td"),i=document.createElement("td");return e.appendChild(t),e.appendChild(i),new function(e){var t=0,i=0;this.setName=function(i){t++>0&&e.name.appendChild(document.createTextNode(" ")),e.name.appendChild(document.createTextNode(i))},this.setValue=function(t){i++>0&&e.value.appendChild(document.createTextNode(", ")),e.value.appendChild(document.createTextNode(t))}}({name:t,value:i})}}function n(n){e.call(this);var a={},o=document.getElementById(n.domNode);this.addModel=function(e){return new Promise(function(r,s){var n;e.model?(a[e.id]=e.model,r(e.model)):(n=e.src,new Promise(function(e,r){t.Make({url:n}).then(function(t){var r=i.XmlToJson(t,{Name:"name",id:"guid"}),s=i.FindNodeOfType(r,"properties")[0],n=i.FindNodeOfType(r,"decomposition")[0].children[0],a=i.FindNodeOfType(r,"types")[0],o={},h={},l={};s.children.forEach(function(e){l[e.guid]=e});var c=function(e,t){var r=e&&e.ObjectPlacement?o:h;if(t["xlink:href"]){r[e.guid]||((s=i.Clone(e)).GlobalId=s.guid,r[s.guid]=s,r[s.guid].properties=[]);var s,n=t["xlink:href"].substr(1);(s=l[n])?r[e.guid].properties.push(s):h[n]&&(r[e.guid].properties=r[e.guid].properties.concat(h[n].properties))}t.children.forEach(function(e){c(t,e)})};c(null,a),c(null,n),e({model:{objects:o,source:"XML"}})})})).then(function(t){a[e.id]=t,r(t)})})};var h=function(e){var t=new s({domNode:o});return t.setName(e.type||e.getType()),["GlobalId","Name","OverallWidth","OverallHeight","Tag"].forEach(function(i){var s=e[i];if(void 0===s){var n=e["get"+i];n&&(s=n.apply(e))}void 0!==s&&(r=t.addRow(),r.setName(i),r.setValue(s))}),t},l=function(e){var t=new s({domNode:o});if(e.name&&e.children)t.setName(e.name),e.children.forEach(function(e){var i=t.addRow();i.setName(e.name),i.setValue(e.NominalValue)});else{e.getName(function(e){t.setName(e)});var i=function(e,r,s){var n=s||t.addRow();e.getName(function(e){n.setName(e)}),e.getNominalValue&&e.getNominalValue(function(e){n.setValue(e._v)}),e.getHasProperties&&e.getHasProperties(function(e,t){i(e,t,n)})};e.getHasProperties(i)}return t};this.setSelected=function(e){if(1===e.length)if(o.innerHTML="",-1!==(e=e[0]).indexOf(":")){e=e.split(":");var t=a[e[0]].model.objects[e[1]];h(t),t.getIsDefinedBy(function(e){"IfcRelDefinesByProperties"==e.getType()&&e.getRelatingPropertyDefinition(function(e){"IfcPropertySet"==e.getType()&&l(e)})})}else{t=a[1].model.objects[e];h(t),t.properties.forEach(function(e){l(e)})}else o.innerHTML="&nbsp;<br>Select a single element in order to see object properties."},this.setSelected([])}return n.prototype=Object.create(e.prototype),n}),define("bimsurfer/lib/domReady",[],function(){"use strict";var e,t,i,r="undefined"!=typeof window&&window.document,s=!r,n=r?document:null,a=[];function o(){var e=a;s&&e.length&&(a=[],function(e){var t;for(t=0;t<e.length;t+=1)e[t](n)}(e))}function h(){s||(s=!0,i&&clearInterval(i),o())}if(r){if(document.addEventListener)document.addEventListener("DOMContentLoaded",h,!1),window.addEventListener("load",h,!1);else if(window.attachEvent){window.attachEvent("onload",h),t=document.createElement("div");try{e=null===window.frameElement}catch(e){}t.doScroll&&e&&window.external&&(i=setInterval(function(){try{t.doScroll(),h()}catch(e){}},30))}"complete"===document.readyState&&h()}function l(e){return s?e(n):a.push(e),l}return l.version="2.0.1",l.load=function(e,t,i,r){r.isBuild?i(null):l(i)},l}),require(["bimsurfer/src/BimSurfer","bimsurfer/src/StaticTreeRenderer","bimsurfer/src/MetaDataRenderer","bimsurfer/src/Request","bimsurfer/src/Utils","bimsurfer/lib/domReady!"],function(e,t,i,r,s){var n=new e({domNode:"viewerContainer"}),a=window.location.hash;a="models/"+(a=a.length<1?"Duplex_A_20110907_optimized":a.substr(1));var o=new t({domNode:"treeContainer"});o.addModel({id:1,src:a+".xml"}),o.build(),o.on("click",highlight);var h=new i({domNode:"dataContainer"});h.addModel({id:1,src:a+".xml"}),n.load({src:a+".gltf"}).then(function(e){var t=n.viewer.scene,i=t.worldBoundary.aabb,r=xeogl.math.subVec3(i.slice(3),i,xeogl.math.vec3()),s=xeogl.math.lenVec3(r);t.camera.project.near=s/1e3,t.camera.project.far=100*s,t.camera.view.eye=[-1,-1,5],t.camera.view.up=[0,0,1],n.viewFit({centerModel:!0}),n.viewer.scene.canvas.canvas.style.display="block"}),n.on("selection-changed",function(e){h.setSelected(e.map(function(e){return s.CompressGuid(e.split("#")[1].substr(8,36).replace(/-/g,""))}))}),window.bimSurfer=n}),define("gltf_app",function(){});